<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>نظام التوظيف الذكي - ميس الطبية</title>
‎    <!-- يمكن ربط ملف CSS خارجي هنا -->
    <!-- <link rel="stylesheet" href="style.css"> -->

‎    <!-- تضمين jsPDF ومكتبات الخطوط العربية -->
‎    <!-- تحذير: تضمين الخطوط في jsPDF بشكل يدوي أو باستخدام Base64 معقد وقد لا يعمل مباشرة على كل المتصفحات والبيئات -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
‎    <!-- مثال (قد لا يعمل مباشرة ويحتاج تضمين يدوي للخط): -->
    <!-- <script src="https://cdn.jsdelivr.net/npm/jspdf-arabic@1.0.0/dist/jspdf.arabic.min.js"></script> -->
‎    <!-- يفضل استخدام مكتبات backend لتوليد PDF مع العربية بشكل موثوق -->


    <style>
        /* --- START OF FILE style.css --- */
        body {
            font-family: 'Arial', sans-serif; /* أو أي خط عربي احترافي آخر */
            direction: rtl;
            text-align: right;
            margin: 0;
            padding: 0;
            background-color: #f4f7f6; /* لون خلفية فاتح */
            color: #333;
            line-height: 1.6;
        }

        .container {
            width: 90%;
            max-width: 900px; /* أقصى عرض للمحتوى */
            margin: 20px auto;
            padding: 0 15px;
        }

        header {
            background-color: #0056b3; /* أزرق طبي احترافي */
            color: white;
            padding: 20px 0;
            text-align: center;
            margin-bottom: 20px;
        }

        header h1 {
            margin: 0 0 5px 0;
            font-size: 2.2em;
        }

        header h2 {
            margin: 0;
            font-size: 1.2em;
            font-weight: normal;
        }

        .logo {
            max-height: 80px; /* حجم الشعار */
            margin-top: 10px;
        }

        main {
            background-color: #fff; /* خلفية بيضاء للمحتوى الرئيسي */
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
        }

        section {
            margin-bottom: 30px;
            padding-bottom: 20px;
            border-bottom: 1px solid #eee;
        }

        section:last-child {
            border-bottom: none;
        }

        h2, h3, h4 {
            color: #0056b3;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
            margin-bottom: 20px;
        }

        h3, h4 {
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            margin-bottom: 15px;
            color: #007bff; /* لون أزرق أفتح للعناوين الفرعية */
        }

        .form-group {
            margin-bottom: 15px;
        }

        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
            color: #555;
        }

        input[type="text"],
        input[type="email"],
        input[type="tel"],
        input[type="number"],
        input[type="file"],
        select,
        textarea {
            width: calc(100% - 22px); /* عرض العنصر ناقص البادينج والبوردر */
            padding: 10px;
            margin-bottom: 5px;
            border: 1px solid #ccc;
            border-radius: 4px;
            box-sizing: border-box; /* احتساب البادينج والبوردر ضمن العرض */
            font-size: 1em;
            font-family: inherit; /* استخدام خط الأب */
            direction: rtl; /* تأكد من أن المدخلات تدعم RTL */
            text-align: right;
        }

        textarea {
            resize: vertical; /* السماح بتغيير الارتفاع فقط */
        }

        button {
            background-color: #007bff; /* أزرق قياسي للأزرار الأساسية */
            color: white;
            padding: 10px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 1em;
            margin-top: 10px;
            transition: background-color 0.3s ease;
            font-family: inherit;
        }

        button:hover {
            background-color: #0056b3;
        }

        button:disabled {
            background-color: #ccc;
            cursor: not-allowed;
        }

        .ai-helper-button {
             background-color: #6c757d; /* رمادي للأزرار المساعدة */
             font-size: 0.9em;
             padding: 5px 10px;
             margin-right: 5px;
             margin-bottom: 5px; /* مسافة أسفل الزر */
             display: inline-block; /* للتنسيق مع العناصر الأخرى */
        }

        .ai-helper-button:hover {
            background-color: #5a6268;
        }


        .ai-suggestion, .analysis-results {
            background-color: #e9ecef; /* خلفية فاتحة للاقتراحات والنتائج */
            border-right: 4px solid #007bff; /* خط أزرق على اليمين */
            padding: 10px;
            margin-top: 10px;
            margin-bottom: 10px;
            border-radius: 4px;
            font-size: 0.9em;
            color: #333;
            word-wrap: break-word; /* منع تجاوز النص للحدود */
            white-space: pre-wrap; /* الحفاظ على تنسيق النص (الأسطر الجديدة) */
        }

        .analysis-results {
             background-color: #f8f9fa; /* خلفية بيضاء/فاتحة أكثر للنتائج الرئيسية */
             border-right-color: #28a745; /* خط أخضر افتراضي لنتائج التحليل الجيدة */
             border: 1px solid #dee2e6;
             padding: 15px;
             margin-top: 15px;
             margin-bottom: 15px;
        }

        .analysis-results h3, .analysis-results h4 {
            color: #0056b3; /* عناوين داخل النتائج */
            margin-top: 0;
            margin-bottom: 10px;
            border-bottom: none;
            padding-bottom: 0;
        }

        .analysis-results.warning {
             background-color: #fff3cd; /* أصفر للتحذيرات أو الملاحظات */
             border-color: #ffeeba;
             border-right-color: #ffc107;
             color: #856404;
        }

        .analysis-results.danger {
             background-color: #f8d7da; /* أحمر للملاحظات السلبية */
             border-color: #f5c6cb;
             border-right-color: #dc3545;
             color: #721c24;
        }

        .analysis-results.green {
             background-color: #d4edda; /* أخضر صريح */
             border-color: #c3e6cb;
             border-right-color: #28a745;
             color: #155724;
        }


        .evaluation-indicator {
            display: inline-block;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            margin-left: 10px; /* مسافة عن النص */
            vertical-align: middle;
            border: 1px solid #ccc; /* بوردر لتظهر الدائرة حتى لو كانت بيضاء */
        }

        .evaluation-indicator.green {
            background-color: #28a745; /* أخضر */
        }

        .evaluation-indicator.yellow {
            background-color: #ffc107; /* أصفر */
        }

        .evaluation-indicator.red {
            background-color: #dc3545; /* أحمر */
        }


        table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 20px;
        }

        th, td {
            border: 1px solid #ddd;
            padding: 10px;
            text-align: right;
        }

        th {
            background-color: #e9ecef;
            font-weight: bold;
        }

        tbody tr:nth-child(even) {
            background-color: #f2f2f2;
        }

        .hidden {
            display: none !important; /* استخدام !important للتأكد من الإخفاء */
        }

        footer {
            background-color: #333;
            color: white;
            text-align: center;
            padding: 20px 0;
            margin-top: 30px;
            font-size: 0.9em;
        }

        audio {
            display: block; /* عرض مشغل الصوت كبلوك */
            margin-top: 10px;
            width: 100%; /* عرض كامل */
            max-width: 400px; /* أقصى عرض معقول */
        }

        .workflow-status {
            text-align: center;
            margin-bottom: 30px;
            font-size: 1.1em;
            color: #0056b3;
        }

        .workflow-status span {
            font-weight: bold;
            color: #28a745; /* لون مميز للحالة الحالية */
        }


‎        /* تصميم متجاوب */
        @media (max-width: 768px) {
            header h1 {
                font-size: 1.8em;
            }

            .container {
                width: 95%;
            }

            button {
                 width: auto;
                 display: inline-block;
                 margin-left: 5px;
            }

            .ai-helper-button {
                 margin-left: 5px; /* adjust space */
                 margin-right: 0; /* reset right margin */
            }

            input[type="text"],
            input[type="email"],
            input[type="tel"],
            input[type="number"],
            select,
            textarea {
                width: calc(100% - 20px); /* adjust for smaller padding */
            }
             .ai-helper-button {
                 margin-top: 5px; /* add space above helper buttons on small screens */
             }
        }

        @media (max-width: 480px) {
             header h1 {
                 font-size: 1.5em;
             }
              button {
                  display: block; /* Stack buttons on very small screens */
                  width: 100%;
                  margin-left: 0;
                  margin-bottom: 5px;
              }
               .ai-helper-button {
                   display: block; /* Stack AI buttons too */
                   width: 100%;
                   margin-left: 0;
                   margin-right: 0;
                   margin-bottom: 5px;
                   margin-top: 5px; /* Ensure space between buttons when stacked */
               }


             input[type="text"],
             input[type="email"],
             input[type="tel"],
             input[type="number"],
             select,
             textarea {
                 width: calc(100% - 20px);
             }
        }
        /* --- END OF FILE style.css --- */
    </style>

</head>
<body>
    <header>
        <div class="container">
            <h1>نظام التوظيف الذكي</h1>
            <h2>ميس الطبية</h2>
            <img src="placeholder-logo.png" alt="شعار ميس الطبية" class="logo"> <!-- استبدل بمسار شعارك -->
        </div>
    </header>

    <main class="container">

‎        <!-- قسم حالة الطلب (محاكاة) -->
        <section class="workflow-status">
            <h3>حالة طلبك الحالي: <span id="current-status">في انتظار التقديم</span></h3>
            <p>يرجى إكمال الخطوات التالية لإتمام عملية التوظيف.</p>
        </section>

‎        <!-- قسم نموذج التقديم -->
        <section id="application-form">
            <h2>تقديم طلب توظيف</h2>
            <form id="job-application-form">
                <div class="form-group">
                    <label for="full-name">الاسم الكامل:</label>
                    <input type="text" id="full-name" required>
                </div>

                <div class="form-group">
                    <label for="id-number">رقم الهوية:</label>
                    <input type="text" id="id-number" required>
                </div>

                <div class="form-group">
                    <label for="email">البريد الإلكتروني:</label>
                    <input type="email" id="email" required>
                </div>

                <div class="form-group">
                    <label for="phone">رقم الجوال:</label>
                    <input type="tel" id="phone" required>
                </div>

                 <div class="form-group">
                    <label for="gender">الجنس:</label>
                    <select id="gender" required>
                        <option value="">اختر...</option>
                        <option value="ذكر">ذكر</option>
                        <option value="أنثى">أنثى</option>
                    </select>
                </div>

                 <div class="form-group">
                    <label for="marital-status">الحالة الاجتماعية:</label>
                    <select id="marital-status" required>
                        <option value="">اختر...</option>
                        <option value="أعزب">أعزب</option>
                        <option value="متزوج">متزوج</option>
                        <option value="مطلق">مطلق</option>
                        <option value="أرمل">أرمل</option>
                    </select>
                </div>

                <div class="form-group">
                    <label for="education-level">المؤهل العلمي:</label>
                    <input type="text" id="education-level" required>
                     <div class="ai-suggestion" id="education-ai-tip"></div>
                </div>

                <div class="form-group">
                    <label for="major">التخصص:</label>
                    <input type="text" id="major" required>
                     <div class="ai-suggestion" id="major-ai-tip"></div>
                </div>

                <div class="form-group">
                    <label for="experience-years">سنوات الخبرة:</label>
                    <input type="number" id="experience-years" min="0" required>
                    <div class="ai-suggestion" id="experience-ai-tip"></div>
                </div>

                 <div class="form-group">
                    <label for="city">المدينة:</label>
                    <input type="text" id="city" required>
                </div>

                <div class="form-group">
                    <label for="job-title">الوظيفة المتقدم لها:</label>
                    <select id="job-title" required>
                         <option value="">اختر الوظيفة...</option>
‎                         <!-- سيتم ملء هذه القائمة ديناميكياً من خلال JavaScript أو بيانات مبدئية (في نظام حقيقي من Backend) -->
                         <option value="طبيب عام">طبيب عام</option>
                         <option value="ممرض">ممرض</option>
                         <option value="فني مختبر">فني مختبر</option>
                         <option value="مدير إداري">مدير إداري</option>
                    </select>
                     <div class="ai-suggestion" id="job-match-ai-tip"></div>
                </div>

                <div class="form-group">
                    <label for="career-objective">الهدف الوظيفي:</label>
                    <textarea id="career-objective" rows="4"></textarea>
                     <button type="button" class="ai-helper-button" data-field="career-objective">اقتراح هدف وظيفي (AI)</button>
                     <div class="ai-suggestion" id="career-objective-ai-suggestion"></div>
                </div>

                <div class="form-group">
                    <label for="cv-upload">رفع السيرة الذاتية (PDF, DOCX):</label>
                    <input type="file" id="cv-upload" accept=".pdf, .docx" required>
‎                     <!-- زر التحليل سيتم تفعيله بعد رفع الملف -->
                     <button type="button" class="ai-helper-button" data-field="cv-analysis" disabled>تحليل السيرة الذاتية (AI)</button>
                </div>
                 <div id="cv-analysis-results" class="analysis-results hidden">
                     <h3>نتائج تحليل السيرة الذاتية (AI)</h3>
                     <p id="cv-analysis-text"></p>
                     <h4>مدى التطابق مع الوظيفة: <span id="cv-match-score">--</span></h4>
                      <div id="cv-extracted-skills" class="ai-suggestion hidden"></div> <!-- لعرض المهارات المستخرجة -->
                      <div id="cv-red-flags" class="ai-suggestion warning hidden"></div> <!-- لعرض أي ملاحظات مهمة -->
                 </div>


                <div class="form-group">
                    <label for="audio-intro">شرح صوتي عن نفسك (حتى دقيقة):</label>
                    <input type="file" id="audio-intro" accept=".mp3, .wav, .m4a">
                    <span>أو تسجيل صوتي مباشر:</span><br>
                     <button type="button" id="start-recording">بدء التسجيل</button>
                     <button type="button" id="stop-recording" disabled>إيقاف التسجيل</button>
                     <audio id="audio-playback" controls class="hidden"></audio>
                     <div id="audio-transcription" class="ai-suggestion hidden"></div> <!-- لعرض النص المستخرج -->
‎                     <!-- زر التحليل سيتم تفعيله بعد تحويل الصوت لنص -->
                     <button type="button" class="ai-helper-button" data-field="audio-analysis" disabled>تحليل الشرح الصوتي (AI)</button>
                     <div id="audio-analysis-results" class="analysis-results hidden"></div>
                </div>


                <div class="form-group">
                    <label for="notes">ملاحظات إضافية:</label>
                    <textarea id="notes" rows="4"></textarea>
                     <div class="ai-suggestion" id="notes-ai-tip"></div>
                </div>

                <button type="submit" id="submit-application">إرسال الطلب</button>
            </form>
        </section>

‎        <!-- قسم المقابلة الذكية -->
        <section id="smart-interview-section" class="hidden">
             <h2>المقابلة الذكية</h2>
              <p>سيتم إجراء مقابلة أولية لتحديد مدى ملاءمتك للوظيفة. يمكنك الاختيار بين المقابلة الكتابية أو الصوتية.</p>

             <div id="interview-type-selection" style="text-align: center; margin-bottom: 20px;">
                 <button type="button" id="select-text-interview">بدء المقابلة الكتابية</button>
‎                 <!-- زر المقابلة الصوتية يتطلب إعدادات إضافية للتعامل مع API حقيقي -->
                 <!-- <button type="button" id="select-voice-interview" disabled>بدء المقابلة الصوتية (تحت التطوير)</button> -->
             </div>


             <div id="text-interview" class="hidden">
                 <h3>المقابلة الكتابية</h3>
                 <div id="interview-questions">
‎                     <!-- سيتم توليد الأسئلة هنا بواسطة AI -->
                     <p>... يرجى اختيار نوع المقابلة ...</p>
                 </div>
‎                 <!-- الأزرار ستظهر بعد تحميل الأسئلة -->
                 <button type="button" id="submit-text-interview" class="hidden">إرسال إجابات المقابلة</button>
                 <div id="text-interview-overall-analysis" class="analysis-results hidden">
                      <h3>تحليل المقابلة الكتابية الشامل (AI)</h3>
                      <p id="text-interview-summary"></p>
                 </div>
             </div>

‎             <!-- قسم المقابلة الصوتية المباشرة (محاكاة جزئية) -->
             <div id="voice-interview" class="hidden">
                 <h3>المقابلة الصوتية</h3>
                 <p>سيتم طرح الأسئلة شفهياً. يرجى النقر على "بدء تسجيل الإجابة" بعد كل سؤال.</p>
                 <div id="voice-interview-question" class="ai-suggestion" style="font-size: 1.1em;">
‎                     <!-- السؤال الصوتي الحالي هنا -->
                 </div>
                 <button type="button" id="start-voice-interview">ابدأ المقابلة الصوتية</button>
                 <button type="button" id="start-voice-answer-recording" class="hidden">بدء تسجيل الإجابة</button>
                 <button type="button" id="stop-voice-answer-recording" disabled class="hidden">إيقاف تسجيل الإجابة</button>
                 <audio id="voice-interview-playback" controls class="hidden"></audio>
                 <div id="voice-interview-transcription" class="ai-suggestion hidden"></div>
                 <button type="button" id="submit-voice-answer" disabled class="hidden">إرسال الإجابة وتحليلها (AI)</button>
                 <div id="voice-interview-results" class="analysis-results hidden"></div> <!-- تحليل الإجابة الحالية -->
                 <button type="button" id="next-voice-question" disabled class="hidden">السؤال التالي</button>
                  <div id="voice-interview-overall-analysis" class="analysis-results hidden">
                      <h3>تحليل المقابلة الصوتية الشامل (AI)</h3>
                      <p id="voice-interview-summary"></p>
                 </div>
                  <button type="button" id="finish-voice-interview" disabled class="hidden">إنهاء المقابلة الصوتية</button>
             </div>

        </section>

‎        <!-- قسم التقييم والتقرير -->
        <section id="evaluation-report-section" class="hidden">
            <h2>التقييم النهائي والتقرير</h2>

            <div id="smart-evaluation">
                <h3>التقييم الذكي الشامل (AI)</h3>
                <p>نتيجة التقييم العام: <span id="overall-score">--</span> <span id="overall-evaluation-indicator" class="evaluation-indicator"></span></p>

                <div id="evaluation-summary" class="analysis-results hidden">
                     <h4>ملخص التقييم:</h4>
                     <p id="evaluation-summary-text"></p>
                </div>
                <div id="strength-weakness-analysis" class="analysis-results hidden">
                    <h4>نقاط القوة والضعف (AI):</h4>
                    <p id="strength-weakness-text"></p>
                </div>
                 <div id="behavioral-analysis" class="analysis-results hidden">
                     <h4>تحليل السمات السلوكية (AI):</h4>
                     <p id="behavioral-analysis-text"></p>
                 </div>

            </div>

            <div id="pdf-report">
                <h3>تقرير التوظيف التلقائي</h3>
                <p>يمكنك توليد تقرير PDF يلخص بيانات المتقدم ونتائج التقييم.</p>
                <button type="button" id="generate-pdf-report">توليد تقرير PDF</button>
                <div id="pdf-status"></div>
            </div>
        </section>

‎         <!-- قسم لوحة مسؤول التوظيف (عرض توضيحي بسيط) -->
         <section id="recruiter-view-section" class="hidden">
             <h2>لوحة مسؤول التوظيف (عرض توضيحي)</h2>
             <p>هذا القسم يحاكي عرض بيانات المتقدم الحالي كما يراه مسؤول التوظيف.</p>
             <div id="applicant-summary">
‎                 <!-- سيتم عرض ملخص بيانات المتقدم والنتائج هنا -->
             </div>
             <button type="button" id="export-applicant-data">تصدير بيانات المتقدم (JSON)</button>
         </section>

‎         <!-- قسم التحليل المقارن (عرض توضيحي بسيط) -->
         <section id="comparison-matrix-section" class="hidden">
              <h2>تحليل مقارن للمتقدمين (عرض توضيحي)</h2>
              <p>هذا الجدول يعرض مقارنة افتراضية بين عدة متقدمين لنفس الوظيفة، يتبعه تحليل AI.</p>
              <table id="comparison-table">
                  <thead>
                      <tr>
                          <th>الاسم</th>
                          <th>سنوات الخبرة</th>
                          <th>التخصص</th>
                          <th>نتائج المقابلة الكتابية</th>
                          <th>نتائج المقابلة الصوتية</th>
                           <th>تطابق السيرة الذاتية (%)</th>
                          <th>التقييم العام</th>
                      </tr>
                  </thead>
                  <tbody>
‎                       <!-- سيتم ملء بيانات المقارنة هنا، هذه بيانات افتراضية -->
                       <tr>
                           <td>علياء محمد</td>
                           <td>3</td>
                           <td>تمريض</td>
                           <td>جيد</td>
                           <td>ممتاز</td>
                           <td>80</td>
                           <td>85 <span class="evaluation-indicator green"></span></td>
                       </tr>
                        <tr>
                           <td>أحمد سليم</td>
                           <td>5</td>
                           <td>فني مختبر</td>
                           <td>ممتاز</td>
                           <td>جيد</td>
                           <td>90</td>
                           <td>92 <span class="evaluation-indicator green"></span></td>
                       </tr>
                       <tr>
                           <td>فاطمة خالد</td>
                           <td>1</td>
                           <td>طبيب عام</td>
                           <td>مقبول</td>
                           <td>لا يوجد</td>
                            <td>60</td>
                           <td>65 <span class="evaluation-indicator yellow"></span></td>
                       </tr>
‎                        <!-- بيانات المتقدم الحالي ستضاف هنا ديناميكياً بعد التقييم -->
                  </tbody>
              </table>
              <div id="comparison-analysis" class="analysis-results hidden">
                   <h3>تحليل المقارنة (AI)</h3>
                   <p id="comparison-analysis-text">... سيتم توليد تحليل مقارن هنا بواسطة AI ...</p>
              </div>
         </section>


    </main>

    <footer>
        <div class="container">
            <p>© 2023 ميس الطبية. جميع الحقوق محفوظة.</p>
        </div>
    </footer>

    <script>
        /* --- START OF FILE script.txt --- */

‎        // تحذير أمني خطير: عرض مفتاح API مباشرة في كود الواجهة الأمامية غير آمن إطلاقاً.
‎        // في بيئة الإنتاج، يجب أن يتم إرسال الطلبات إلى الخادم الخلفي الذي يقوم بدوره باستدعاء Gemini API باستخدام المفتاح المخزن بأمان على الخادم.
        const GEMINI_API_KEY = 'AIzaSyCV3Kb2rHMQoyAiYkrAFA82UlcGbYAAC0M'; // استبدل بمفتاحك الفعلي
        const GEMINI_API_URL = 'https://generativelanguage.googleapis.com/v1beta/models/gemini-2.0-flash:generateContent'; // استخدام نموذج أسرع وأقل تكلفة للمحادثات القصيرة/المهام البسيطة

‎        // --- وظيفة محاكاة لاستدعاء Gemini API ---
‎        // في نظام حقيقي، هذه الدالة سترسل البيانات إلى Backend API، والـ Backend هو من يستدعي Gemini.
        async function callGeminiAPI(promptText) {
             console.log("AI Prompt:", promptText); // لعرض ال prompt المرسل لـ AI

‎            // محاكاة تأخير زمني لاستدعاء API
            await new Promise(resolve => setTimeout(resolve, 1500));

‎            // في بيئة الإنتاج، يجب أن يتم هذا الاستدعاء عبر خادم (Backend)
‎            // لحماية مفتاح API الخاص بك.
            const url = `${GEMINI_API_URL}?key=${GEMINI_API_KEY}`;

            try {
                const response = await fetch(url, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        contents: [{
                            parts: [{ text: promptText }]
                        }],
‎                        // إعدادات إضافية للتحكم في استجابة النموذج (اختياري)
                         generationConfig: {
                             temperature: 0.7, // التحكم في عشوائية الرد (0 للقليل، 1 للكثير)
                             maxOutputTokens: 800, // الحد الأقصى لعدد التوكنات في الرد
                         },
                          safetySettings: [ // لإدارة المحتوى غير المرغوب فيه
                            {
                                category: "HARM_CATEGORY_HARASSMENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_HATE_SPEECH",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_SEXUALLY_EXPLICIT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                            {
                                category: "HARM_CATEGORY_DANGEROUS_CONTENT",
                                threshold: "BLOCK_MEDIUM_AND_ABOVE"
                            },
                         ],
                    }),
                });

                if (!response.ok) {
                    const errorData = await response.json();
                    console.error('Gemini API Error:', response.status, errorData);
‎                     // رسالة خطأ أكثر وضوحاً للمستخدم
                    return `خطأ في استدعاء AI: ${errorData.error ? errorData.error.message : response.statusText}`;
                }

                const data = await response.json();
‎                // استخراج النص من استجابة Gemini
                const generatedText = data.candidates && data.candidates.length > 0 && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts.length > 0
                                   ? data.candidates[0].content.parts[0].text
‎                                   : 'لم يتم توليد نص بواسطة AI.';

                 console.log("AI Response:", generatedText); // لعرض الرد من AI
                 return generatedText;


            } catch (error) {
                console.error('Fetch error:', error);
                return `حدث خطأ أثناء الاتصال بخدمة AI: ${error.message}`;
            }
        }


‎        // --- متغيرات عامة للعناصر والبيانات وحالة Workflow ---
        const form = document.getElementById('job-application-form');
        const cvUploadInput = document.getElementById('cv-upload');
        const audioIntroInput = document.getElementById('audio-intro'); // للملف الصوتي المحمّل
        const startRecordingBtn = document.getElementById('start-recording');
        const stopRecordingBtn = document.getElementById('stop-recording');
        const audioPlayback = document.getElementById('audio-playback');

‎        // أقسام Workflow
        const applicationFormSection = document.getElementById('application-form');
        const smartInterviewSection = document.getElementById('smart-interview-section');
        const evaluationReportSection = document.getElementById('evaluation-report-section');
        const recruiterViewSection = document.getElementById('recruiter-view-section');
        const comparisonMatrixSection = document.getElementById('comparison-matrix-section');

‎        // حالة Workflow
        const currentStatusSpan = document.getElementById('current-status');
        let currentWorkflowStep = 'application'; // 'application', 'interview', 'evaluation', 'completed'

‎        // عناصر لعرض نتائج AI وتحليلاتها
        const careerObjectiveAISuggestionDiv = document.getElementById('career-objective-ai-suggestion');

        const cvAnalysisResultsDiv = document.getElementById('cv-analysis-results');
        const cvAnalysisTextP = document.getElementById('cv-analysis-text');
        const cvMatchScoreSpan = document.getElementById('cv-match-score');
        const cvExtractedSkillsDiv = document.getElementById('cv-extracted-skills');
        const cvRedFlagsDiv = document.getElementById('cv-red-flags');


        const audioTranscriptionDiv = document.getElementById('audio-transcription');
        const audioAnalysisResultsDiv = document.getElementById('audio-analysis-results');

        const interviewTypeSelectionDiv = document.getElementById('interview-type-selection');
        const textInterviewDiv = document.getElementById('text-interview');
        const voiceInterviewDiv = document.getElementById('voice-interview');

        const textInterviewQuestionsDiv = document.getElementById('interview-questions');
        const submitTextInterviewBtn = document.getElementById('submit-text-interview');
        const textInterviewOverallAnalysisDiv = document.getElementById('text-interview-overall-analysis');
        const textInterviewSummaryP = document.getElementById('text-interview-summary');

        const voiceInterviewQuestionDiv = document.getElementById('voice-interview-question');
        const startVoiceInterviewBtn = document.getElementById('start-voice-interview');
        const startVoiceAnswerRecordingBtn = document.getElementById('start-voice-answer-recording');
        const stopVoiceAnswerRecordingBtn = document.getElementById('stop-voice-answer-recording');
        const voiceInterviewPlayback = document.getElementById('voice-interview-playback');
        const voiceInterviewTranscriptionDiv = document.getElementById('voice-interview-transcription');
        const submitVoiceAnswerBtn = document.getElementById('submit-voice-answer');
        const voiceInterviewResultsDiv = document.getElementById('voice-interview-results'); // تحليل الإجابة الفردية
        const nextVoiceQuestionBtn = document.getElementById('next-voice-question');
        const finishVoiceInterviewBtn = document.getElementById('finish-voice-interview');
        const voiceInterviewOverallAnalysisDiv = document.getElementById('voice-interview-overall-analysis');
        const voiceInterviewSummaryP = document.getElementById('voice-interview-summary');


        const overallScoreSpan = document.getElementById('overall-score');
        const overallEvaluationIndicatorDiv = document.getElementById('overall-evaluation-indicator');
        const evaluationSummaryDiv = document.getElementById('evaluation-summary');
        const evaluationSummaryTextP = document.getElementById('evaluation-summary-text');
        const strengthWeaknessAnalysisDiv = document.getElementById('strength-weakness-analysis');
        const strengthWeaknessTextP = document.getElementById('strength-weakness-text');
        const behavioralAnalysisDiv = document.getElementById('behavioral-analysis');
        const behavioralAnalysisTextP = document.getElementById('behavioral-analysis-text');


        const comparisonTableBody = document.querySelector('#comparison-table tbody');
        const comparisonAnalysisDiv = document.getElementById('comparison-analysis');
        const comparisonAnalysisTextP = document.getElementById('comparison-analysis-text');

        const pdfStatusDiv = document.getElementById('pdf-status');
        const generatePdfButton = document.getElementById('generate-pdf-report');


        let recordedAudioChunks = [];
        let mediaRecorder;
        let applicantData = {}; // كائن لتخزين جميع بيانات المتقدم ونتائج AI (في الذاكرة فقط لهذا العرض)
        let cvTextContent = ''; // محاكاة لمحتوى السيرة الذاتية كنص بعد المعالجة الخلفية
        let audioTranscriptionText = ''; // محاكاة للنص المستخرج من الصوت بعد المعالجة الخلفية

        let textInterviewQuestions = []; // أسئلة المقابلة الكتابية التي تم توليدها
        let currentVoiceQuestionIndex = 0;
        let voiceInterviewQuestions = []; // أسئلة المقابلة الصوتية
        let voiceInterviewAnswersTranscriptions = []; // نصوص إجابات المقابلة الصوتية


‎        // --- وظيفة تحديث حالة Workflow في الواجهة ---
        function updateWorkflowStatus(status) {
            currentWorkflowStep = status;
            let statusText = '';
            switch (status) {
                case 'application':
                    statusText = 'في انتظار التقديم';
                    break;
                case 'submitted':
                    statusText = 'تم استلام الطلب';
                    break;
                case 'screening':
                     statusText = 'قيد الفرز الآلي وتحليل السيرة الذاتية';
                     break;
                case 'interview':
                    statusText = 'في مرحلة المقابلة الذكية';
                     break;
                 case 'interview_completed':
                    statusText = 'تم إكمال المقابلة الذكية';
                    break;
                case 'evaluation':
                    statusText = 'قيد التقييم الشامل بواسطة AI';
                    break;
                case 'completed':
                    statusText = 'اكتمل التقييم (في انتظار مراجعة مسؤول التوظيف)';
                    break;
                case 'accepted':
                     statusText = 'تم قبول المتقدم مبدئياً';
                    break;
                case 'rejected':
                     statusText = 'لم يتطابق المتقدم مع المتطلبات الحالية';
                    break;
                default:
                    statusText = status; // لعرض أي حالة أخرى
            }
            currentStatusSpan.textContent = statusText;
‎            // يمكن إضافة تنسيقات مختلفة حسب الحالة
        }


‎        // --- وظيفة مساعدة لاستدعاء AI Helper buttons ---
        document.querySelectorAll('.ai-helper-button').forEach(button => {
            button.addEventListener('click', async () => {
                const field = button.dataset.field;
                const originalButtonText = button.textContent;
                button.disabled = true;
                button.textContent = 'الذكاء الاصطناعي يعمل...';

                let prompt = '';
                let outputElement = null;
                let analysisResultsElement = null; // لإظهار نتائج التحليل التفصيلية

                switch (field) {
                    case 'career-objective':
                         const education = document.getElementById('education-level').value;
                         const major = document.getElementById('major').value;
                         const experience = document.getElementById('experience-years').value;
                         const jobTitle = document.getElementById('job-title').value;
                         if (!education && !major && !experience && !jobTitle) {
                             alert('يرجى ملء حقول (المؤهل، التخصص، سنوات الخبرة، الوظيفة المتقدم لها) لاقتراح هدف وظيفي.');
                             button.disabled = false;
                             button.textContent = originalButtonText;
                             return;
                         }
                         prompt = `بناءً على المؤهل العلمي "${education}"، التخصص "${major}"، و${experience} سنوات خبرة، وللتقدم لوظيفة "${jobTitle}" في قطاع طبي، اقترح هدف وظيفي احترافي وموجز باللغة العربية.`;
                         outputElement = careerObjectiveAISuggestionDiv;
                         outputElement.classList.remove('hidden');
                        break;
                    case 'cv-analysis':
‎                         // في نظام حقيقي، هذه الخطوة تحدث بعد Backend File Processing
                         if (!cvTextContent) {
                             cvAnalysisResultsDiv.classList.remove('hidden');
                             cvAnalysisTextP.textContent = 'لا يمكن تحليل السيرة الذاتية. يرجى رفع ملف صالح أولاً ومعالجته.';
                             cvAnalysisResultsDiv.className = 'analysis-results danger';
                              button.disabled = false;
                             button.textContent = originalButtonText;
                             return;
                         }
                        const jobTitleForAnalysis = document.getElementById('job-title').value;
                        if (!jobTitleForAnalysis) {
                             alert('يرجى اختيار الوظيفة المتقدم لها أولاً لتقييم مدى التطابق.');
                              button.disabled = false;
                             button.textContent = originalButtonText;
                             return;
                        }
                        // prompt لطلب تحليل مفصل واستخراج معلومات وتطابق
                        prompt = `حلل السيرة الذاتية التالية للمتقدم لوظيفة "${jobTitleForAnalysis}" في قطاع طبي.
‎                         استخرج منها:
‎                         - الخبرات الأساسية (اذكر المسميات الوظيفية والسنوات).
‎                         - المهارات التقنية وغير التقنية الرئيسية.
‎                         - المؤهل التعليمي والتخصص وتاريخ التخرج.
‎                         - أي سمات إيجابية أو ملاحظات مهمة ظاهرة (مثل مشاريع، دورات إضافية).
‎                         - أي نقاط قد تحتاج تدقيقاً (مثل فترات زمنية غير واضحة، تغييرات وظيفية متكررة - اذكرها كملاحظة).
‎                         قيم مدى تطابق السيرة الذاتية مع متطلبات وظيفة "${jobTitleForAnalysis}" بنسبة مئوية (مثال: 85%).

‎                         نظم الرد كالتالي:
‎                         ملخص التحليل: [ملخص نصي]
‎                         الخبرات: [قائمة أو نقاط]
‎                         المهارات: [قائمة أو نقاط]
‎                         المؤهل: [تفاصيل]
‎                         ملاحظات إيجابية: [قائمة أو نقاط]
‎                         ملاحظات تحتاج تدقيق: [قائمة أو نقاط، أو "لا يوجد"]
‎                         نسبة التطابق مع الوظيفة: [رقم]%

‎                         محتوى السيرة الذاتية المستخرج (محاكاة):
                         ${cvTextContent}`;

                        outputElement = cvAnalysisTextP; // النص الرئيسي للتحليل
                        analysisResultsElement = cvAnalysisResultsDiv; // الحاوية الرئيسية للنتائج
                        analysisResultsElement.classList.remove('hidden');
                        outputElement.textContent = 'جاري التحليل...';
                        cvMatchScoreSpan.textContent = 'جاري التقييم...';
                        cvExtractedSkillsDiv.classList.add('hidden'); // إخفاء قبل النتائج
                        cvRedFlagsDiv.classList.add('hidden'); // إخفاء قبل النتائج
                        analysisResultsElement.className = 'analysis-results'; // إعادة تعيين اللون

‎                         // تحديث حالة ال Workflow
                         updateWorkflowStatus('screening');

                         break;
                    case 'audio-analysis':
‎                         // في نظام حقيقي، هذه الخطوة تحدث بعد Backend Speech-to-Text
                         if (!audioTranscriptionText) {
                              audioAnalysisResultsDiv.classList.remove('hidden');
                              audioAnalysisResultsDiv.textContent = 'لا يمكن تحليل الصوت. يرجى تسجيل أو رفع مقطع صوتي أولاً وتحويله إلى نص.';
                              audioAnalysisResultsDiv.className = 'analysis-results danger';
                               button.disabled = false;
                               button.textContent = originalButtonText;
                               return;
                         }
                         prompt = `حلل النص التالي الذي قدمه المتقدم عن نفسه في سياق مقابلة توظيف لوظيفة "${document.getElementById('job-title').value || 'طبية'}" في قطاع طبي.
‎                          قم بتقييم:
‎                          - وضوح الشرح وتنظيمه.
‎                          - مدى ارتباطه بالوظيفة واهتمامات المتقدم.
‎                          - السمات الشخصية أو مهارات التواصل الظاهرة من النص.
‎                          - أي نقاط قوة أو ضعف ظاهرة من خلال حديثه.

‎                          نظم الرد في نقاط أو فقرات واضحة باللغة العربية.

‎                         نص الشرح الصوتي المستخرج (محاكاة):
                         ${audioTranscriptionText}`;

                         outputElement = audioAnalysisResultsDiv;
                         outputElement.classList.remove('hidden');
                         outputElement.textContent = 'جاري تحليل الشرح الصوتي...';
                         outputElement.className = 'analysis-results'; // إعادة تعيين اللون
                         break;

‎                    // نصائح فورية للحقول
                    case 'education-ai-tip':
                         const currentEdu = document.getElementById('education-level').value;
                         outputElement = document.getElementById('education-ai-tip');
                         outputElement.classList.remove('hidden');
                         if (currentEdu) {
                             prompt = `بناءً على المؤهل العلمي "${currentEdu}"، قدم نصيحة سريعة وموجزة (سطر واحد) لمتقدم لوظيفة طبية. مثال: "تأكد من إبراز المواد الدراسية ذات الصلة بوضوح في سيرتك الذاتية."`;
                         } else {
                             outputElement.textContent = ''; // مسح الرسالة إذا كان الحقل فارغاً
                              button.disabled = false;
                              button.textContent = originalButtonText;
                             return;
                         }
                         break;
                    case 'major-ai-tip':
                         const currentMajor = document.getElementById('major').value;
                         outputElement = document.getElementById('major-ai-tip');
                         outputElement.classList.remove('hidden');
                          if (currentMajor) {
                             prompt = `بناءً على التخصص "${currentMajor}"، قدم نصيحة سريعة وموجزة (سطر واحد) لمتقدم لوظيفة طبية. مثال: "اذكر بوضوح أي مشاريع أو أبحاث قمت بها في هذا التخصص."`;
                         } else {
                             outputElement.textContent = '';
                              button.disabled = false;
                              button.textContent = originalButtonText;
                             return;
                         }
                         break;
                     case 'experience-ai-tip':
                         const currentExp = document.getElementById('experience-years').value;
                         outputElement = document.getElementById('experience-ai-tip');
                         outputElement.classList.remove('hidden');
                          if (currentExp !== '' && currentExp >= 0) {
                             prompt = `قدم نصيحة سريعة وموجزة (سطر واحد) لمتقدم لوظيفة طبية لديه ${currentExp} سنوات خبرة. مثال: "ركز على الإنجازات الرئيسية والمسؤوليات التي تحملتها خلال سنوات خبرتك."`;
                         } else {
                             outputElement.textContent = '';
                              button.disabled = false;
                              button.textContent = originalButtonText;
                             return;
                         }
                         break;
‎                    // يمكنك إضافة المزيد هنا لنصائح حول الملاحظات الإضافية، إلخ.
                    default:
                        console.warn('Unknown AI helper field:', field);
                         button.disabled = false;
                         button.textContent = originalButtonText;
                        return;
                }

‎                // تنفيذ الاستدعاء الفعلي لـ Gemini API (أو المحاكاة)
                if (prompt) {
                    outputElement.textContent = 'جاري التواصل مع AI...'; // رسالة مؤقتة
                    const result = await callGeminiAPI(prompt);

‎                     // معالجة خاصة لنتائج تحليل السيرة الذاتية لفصل الأجزاء
                     if (field === 'cv-analysis') {
‎                         // محاولة استخلاص الأجزاء المختلفة من الرد المنظم
                         const parts = result.split('\n').reduce((acc, line) => {
                              if (line.startsWith('ملخص التحليل:')) acc.summary += line.replace('ملخص التحليل:', '').trim() + '\n';
                              else if (line.startsWith('الخبرات:')) acc.experience += line.replace('الخبرات:', '').trim() + '\n';
                              else if (line.startsWith('المهارات:')) acc.skills += line.replace('المهارات:', '').trim() + '\n';
                              else if (line.startsWith('المؤهل:')) acc.education += line.replace('المؤهل:', '').trim() + '\n';
                              else if (line.startsWith('ملاحظات إيجابية:')) acc.positives += line.replace('ملاحظات إيجابية:', '').trim() + '\n';
                              else if (line.startsWith('ملاحظات تحتاج تدقيق:')) acc.redFlags += line.replace('ملاحظات تحتاج تدقيق:', '').trim() + '\n';
                               else if (line.startsWith('نسبة التطابق مع الوظيفة:')) acc.match = line.replace('نسبة التطابق مع الوظيفة:', '').trim();
                              else acc.summary += line.trim() + '\n'; // أي سطر آخر يضاف للملخص
                             return acc;
                         }, { summary: '', experience: '', skills: '', education: '', positives: '', redFlags: '', match: '--' });

                         cvAnalysisTextP.textContent = `ملخص التحليل: ${parts.summary.trim()}\nالخبرات: ${parts.experience.trim()}\nالمؤهل: ${parts.education.trim()}\nملاحظات إيجابية: ${parts.positives.trim()}`;
                         cvMatchScoreSpan.textContent = parts.match;

‎                         // عرض المهارات وملاحظات التدقيق في أقسام منفصلة
                         if (parts.skills.trim()) {
                              cvExtractedSkillsDiv.classList.remove('hidden');
                              cvExtractedSkillsDiv.innerHTML = `<h4>المهارات المستخرجة:</h4><p>${parts.skills.trim()}</p>`;
                         } else {
                             cvExtractedSkillsDiv.classList.add('hidden');
                         }

                         if (parts.redFlags.trim() && parts.redFlags.trim() !== 'لا يوجد') {
                              cvRedFlagsDiv.classList.remove('hidden');
                              cvRedFlagsDiv.innerHTML = `<h4>ملاحظات تحتاج تدقيق:</h4><p>${parts.redFlags.trim()}</p>`;
                              cvRedFlagsDiv.className = 'ai-suggestion warning'; // تلوين الملاحظات بالتحذير
                         } else {
                             cvRedFlagsDiv.classList.add('hidden');
                         }


‎                         // تحديث تنسيق نتائج التحليل بناءً على التطابق (مثال بسيط)
                         if (parts.match.includes('%')) {
                              const scoreValue = parseInt(parts.match, 10);
                              if (scoreValue >= 80) cvAnalysisResultsDiv.className = 'analysis-results green'; // أخضر
                              else if (scoreValue >= 50) cvAnalysisResultsDiv.className = 'analysis-results warning'; // أصفر
                              else cvAnalysisResultsDiv.className = 'analysis-results danger'; // أحمر
                         } else {
                              cvAnalysisResultsDiv.className = 'analysis-results'; // افتراضي
                         }

‎                          // تخزين نتائج التحليل المفصلة
                          applicantData.cvAnalysis = result;
                          applicantData.cvMatchScore = parts.match;
                          applicantData.cvExtractedSkills = parts.skills.trim();
                          applicantData.cvRedFlags = parts.redFlags.trim();


                     } else {
                         outputElement.textContent = result;
‎                         // للتحليلات الأخرى مثل تحليل الصوت
                         if (field === 'audio-analysis') {
                             applicantData.audioAnalysis = result;
‎                              // يمكن إضافة منطق هنا لتغيير لون outputElement بناءً على تحليل AI
                         }
                     }

                } else {
                     outputElement.textContent = ''; // مسح الرسالة إذا لم يتم توليد prompt
                      if (analysisResultsElement) analysisResultsElement.classList.add('hidden');
                }


                button.disabled = false;
                button.textContent = originalButtonText; // استعادة النص الأصلي
            });
        });

‎        // حفظ النص الأصلي لأزرار AI Helper عند تحميل الصفحة
        document.querySelectorAll('.ai-helper-button').forEach(button => {
            button.setAttribute('data-original-text', button.textContent);
        });


‎        // --- معالجة رفع ملف السيرة الذاتية ---
        cvUploadInput.addEventListener('change', async (event) => {
            const file = event.target.files[0];
            const cvAnalysisButton = document.querySelector('.ai-helper-button[data-field="cv-analysis"]');
            if (file) {
                cvAnalysisButton.disabled = true; // تعطيل الزر أثناء المعالجة
                 cvAnalysisResultsDiv.classList.remove('hidden');
                 cvAnalysisResultsDiv.className = 'analysis-results'; // reset class
                 cvAnalysisTextP.textContent = 'جاري معالجة ملف السيرة الذاتية واستخلاص النص... (يتطلب خدمة backend)';
                 cvMatchScoreSpan.textContent = '--';
                 cvExtractedSkillsDiv.classList.add('hidden');
                 cvRedFlagsDiv.classList.add('hidden');


‎                // في نظام حقيقي: يتم إرسال الملف إلى الخادم للمعالجة واستخلاص النص
‎                // باستخدام مكتبات مثل pdf-parse (Node.js) أو PyPDF2 (Python)
‎                // هنا: سنقوم بمحاكاة استخلاص النص بعد تأخير
                 await new Promise(resolve => setTimeout(resolve, 2000)); // محاكاة تأخير المعالجة
                 cvTextContent = `(نص محاكى من السيرة الذاتية لملف ${file.name}, ${file.size} بايت).

‎                 الاسم: [اسم المتقدم]
‎                 المؤهل: [مؤهل المتقدم]
‎                 التخصص: [تخصص المتقدم]
‎                 سنوات الخبرة: [عدد] سنوات في [مجال]
‎                 المهارات: [قائمة مهارات محاكية]
‎                 اللغات: [لغات]
‎                 الخبرة العملية:
‎                 - [مسمى وظيفي 1] في [اسم الشركة 1] ([تاريخ - تاريخ])
‎                 - [مسمى وظيفي 2] في [اسم الشركة 2] ([تاريخ - تاريخ])
‎                 الدورات التدريبية: [قائمة دورات محاكاة]
‎                 `; // نص محاكى

                cvAnalysisTextP.textContent = 'تم استخلاص النص بنجاح. اضغط على "تحليل السيرة الذاتية (AI)"';
                cvAnalysisButton.disabled = false; // تفعيل زر التحليل بعد المحاكاة


            } else {
                cvTextContent = '';
                cvAnalysisButton.disabled = true;
                 cvAnalysisResultsDiv.classList.add('hidden'); // إخفاء النتائج
                 cvAnalysisTextP.textContent = '';
                 cvMatchScoreSpan.textContent = '--';
                 cvExtractedSkillsDiv.classList.add('hidden');
                 cvRedFlagsDiv.classList.add('hidden');
            }
        });

‎        // --- معالجة تسجيل الصوت أو رفع ملف صوتي ---
        let recordedAudioBlob = null; // لتخزين المقطع الصوتي المسجل أو المرفوع

        if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
‎            // معالجة التسجيل المباشر
            startRecordingBtn.addEventListener('click', async () => {
                try {
                    const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                    mediaRecorder = new MediaRecorder(stream);
                    recordedAudioChunks = [];
                    recordedAudioBlob = null; // مسح التسجيل السابق

                    mediaRecorder.ondataavailable = (event) => {
                        recordedAudioChunks.push(event.data);
                    };

                    mediaRecorder.onstop = async () => {
                        recordedAudioBlob = new Blob(recordedAudioChunks, { type: 'audio/wav' }); // يمكن تغيير النوع
                        const audioUrl = URL.createObjectURL(recordedAudioBlob);
                        audioPlayback.src = audioUrl;
                        audioPlayback.classList.remove('hidden');

‎                        // في نظام حقيقي: إرسال audioBlob إلى خادم لتحويله إلى نص باستخدام Speech-to-Text API
                        audioTranscriptionDiv.classList.remove('hidden');
                        audioTranscriptionDiv.textContent = 'جاري تحويل الصوت إلى نص... (يتطلب خدمة backend)';
                        document.querySelector('.ai-helper-button[data-field="audio-analysis"]').disabled = true; // تعطيل زر التحليل أثناء التحويل

‎                         // محاكاة تحويل الصوت إلى نص
                         await new Promise(resolve => setTimeout(resolve, 2500)); // محاكاة تأخير التحويل
                         audioTranscriptionText = "مرحباً، أنا [اسم المتقدم]. لدي خبرة [عدد] سنوات في مجال [المجال المطلوب] وأنا متحمس للعمل في ميس الطبية والمساهمة في فريقكم."; // نص محاكى

                        audioTranscriptionDiv.textContent = `النص المستخرج (محاكاة): ${audioTranscriptionText}`;
                        document.querySelector('.ai-helper-button[data-field="audio-analysis"]').disabled = false; // تفعيل زر التحليل
                         audioAnalysisResultsDiv.classList.add('hidden'); // إخفاء نتائج التحليل السابقة

‎                        // إيقاف المسار الصوتي للميكروفون
                        stream.getTracks().forEach(track => track.stop());
                    };

                    mediaRecorder.start();
                    startRecordingBtn.disabled = true;
                    stopRecordingBtn.disabled = false;
                     audioTranscriptionDiv.classList.remove('hidden');
                    audioTranscriptionDiv.textContent = 'التسجيل قيد التقدم...';
                     audioPlayback.classList.add('hidden'); // إخفاء مشغل الصوت أثناء التسجيل
                     document.querySelector('.ai-helper-button[data-field="audio-analysis"]').disabled = true;


                } catch (err) {
                    console.error('Error accessing microphone:', err);
                     audioTranscriptionDiv.classList.remove('hidden');
                    audioTranscriptionDiv.textContent = `خطأ في الوصول إلى الميكروفون: ${err.message}`;
                     document.querySelector('.ai-helper-button[data-field="audio-analysis"]').disabled = true;
                }
            });

            stopRecordingBtn.addEventListener('click', () => {
                mediaRecorder.stop();
                startRecordingBtn.disabled = false;
                stopRecordingBtn.disabled = true;
            });

‎             // معالجة رفع ملف صوتي
             audioIntroInput.addEventListener('change', async (event) => {
                 const file = event.target.files[0];
                  const audioAnalysisButton = document.querySelector('.ai-helper-button[data-field="audio-analysis"]');
                 if (file) {
                     recordedAudioBlob = file; // تخزين الملف المرفوع
                     const audioUrl = URL.createObjectURL(file);
                     audioPlayback.src = audioUrl;
                     audioPlayback.classList.remove('hidden');

‎                     // في نظام حقيقي: إرسال الملف الصوتي إلى خادم لتحويله إلى نص
                      audioTranscriptionDiv.classList.remove('hidden');
                     audioTranscriptionDiv.textContent = 'جاري تحويل الملف الصوتي إلى نص... (يتطلب خدمة backend)';
                     audioAnalysisButton.disabled = true; // تعطيل زر التحليل أثناء التحويل
                     audioAnalysisResultsDiv.classList.add('hidden'); // إخفاء نتائج التحليل السابقة


‎                     // محاكاة تحويل الملف إلى نص
                      await new Promise(resolve => setTimeout(resolve, 2500)); // محاكاة تأخير التحويل
                     audioTranscriptionText = "مرحباً، هذه مقدمة صوتية مرفوعة."; // نص محاكى من ملف مرفوع

                     audioTranscriptionDiv.textContent = `النص المستخرج (محاكاة): ${audioTranscriptionText}`;
                     audioAnalysisButton.disabled = false; // تفعيل زر التحليل

‎                     // تعطيل أزرار التسجيل إذا تم رفع ملف
                     startRecordingBtn.disabled = true;
                     stopRecordingBtn.disabled = true;

                 } else {
                     recordedAudioBlob = null;
                     audioPlayback.removeAttribute('src');
                     audioPlayback.classList.add('hidden');
                     audioTranscriptionDiv.classList.add('hidden');
                     audioTranscriptionText = '';
                     audioAnalysisButton.disabled = true;
                     audioAnalysisResultsDiv.classList.add('hidden');

‎                     // تفعيل أزرار التسجيل مرة أخرى
                     startRecordingBtn.disabled = false;
                     stopRecordingBtn.disabled = true;
                 }
             });


        } else {
            console.warn('MediaRecorder API not supported.');
            startRecordingBtn.disabled = true;
            stopRecordingBtn.disabled = true;
             audioTranscriptionDiv.classList.remove('hidden');
            audioTranscriptionDiv.textContent = 'تسجيل الصوت غير مدعوم في متصفحك.';
             document.querySelector('.ai-helper-button[data-field="audio-analysis"]').disabled = true;
        }


‎        // --- معالجة إرسال النموذج الرئيسي ---
        form.addEventListener('submit', async (event) => {
            event.preventDefault(); // منع الإرسال التقليدي للصفحة

‎            // جمع البيانات من النموذج
            applicantData = {
                fullName: document.getElementById('full-name').value,
                idNumber: document.getElementById('id-number').value,
                email: document.getElementById('email').value,
                phone: document.getElementById('phone').value,
                gender: document.getElementById('gender').value,
                maritalStatus: document.getElementById('marital-status').value,
                educationLevel: document.getElementById('education-level').value,
                major: document.getElementById('major').value,
                experienceYears: document.getElementById('experience-years').value,
                city: document.getElementById('city').value,
                jobTitle: document.getElementById('job-title').value,
                careerObjective: document.getElementById('career-objective').value,
                notes: document.getElementById('notes').value,
‎                // محاكاة لبيانات الملفات المحملة/المسجلة
                cvFileName: cvUploadInput.files[0] ? cvUploadInput.files[0].name : null,
                audioProvided: recordedAudioBlob ? true : false, // هل تم توفير صوت؟
‎                // محتوى النص المستخرج من CV والصوت (محاكى/مخزن من الخطوات السابقة)
                cvTextContent: cvTextContent,
                audioTranscription: audioTranscriptionText,
‎                // نتائج التحليل من AI (مخزنة من الخطوات السابقة)
                 cvAnalysis: applicantData.cvAnalysis || 'لم يتم تحليل السيرة الذاتية.', // استخدام النتائج المخزنة
                 cvMatchScore: applicantData.cvMatchScore || '--',
                 cvExtractedSkills: applicantData.cvExtractedSkills || '',
                 cvRedFlags: applicantData.cvRedFlags || '',

                audioAnalysis: applicantData.audioAnalysis || 'لم يتم تحليل الشرح الصوتي.', // استخدام النتائج المخزنة

                textInterviewAnswers: {},
                textInterviewAnalysis: '',

                voiceInterviewAnswers: [], // تخزين الإجابات الصوتية المحولة لنص لكل سؤال
                voiceInterviewAnalysis: '',

                overallEvaluationScore: '--',
                overallEvaluationSummary: '',
                strengthWeakness: '',
                behavioralTraits: '',

                 workflowStatus: 'submitted', // حالة مبدئية بعد الإرسال
            };

‎             // في نظام حقيقي: يتم إرسال applicantData والملفات (CV, Audio) إلى Backend
‎             // الـ Backend يقوم بتخزين البيانات في قاعدة البيانات
‎             // الـ Backend يقوم بمعالجة الملفات (تحويل لنص) وتخزين النص في قاعدة البيانات أو التخزين السحابي
‎             // الـ Backend يقوم بتشغيل تحليلات AI الأولية (تحليل CV، تحليل الصوت) ويخزن النتائج
             console.log("Simulating sending application data to backend:", applicantData);

‎            // إخفاء نموذج التقديم وإظهار قسم المقابلة
            applicationFormSection.classList.add('hidden');
            smartInterviewSection.classList.remove('hidden');
            updateWorkflowStatus('interview'); // تحديث حالة Workflow

‎            // عرض خيارات المقابلة (كتابية/صوتية)
             interviewTypeSelectionDiv.classList.remove('hidden');

        });

‎        // --- اختيار نوع المقابلة ---
        document.getElementById('select-text-interview').addEventListener('click', () => {
             interviewTypeSelectionDiv.classList.add('hidden');
             textInterviewDiv.classList.remove('hidden');
             startSmartTextInterview();
        });

‎        // // مثال لزر مقابلة صوتية (يحتاج تطوير backend حقيقي)
        // document.getElementById('select-voice-interview').addEventListener('click', () => {
        //      interviewTypeSelectionDiv.classList.add('hidden');
        //      voiceInterviewDiv.classList.remove('hidden');
        //      startSmartVoiceInterview(); // دالة لم يتم تنفيذها بالكامل هنا
        // });


‎        // --- عملية المقابلة الذكية الكتابية ---
        async function startSmartTextInterview() {
            textInterviewQuestionsDiv.textContent = 'جاري توليد أسئلة المقابلة الكتابية بناءً على سيرتك الذاتية وتحليلات AI الأولية... (يتطلب خدمة backend)';
             submitTextInterviewBtn.disabled = true; // تعطيل زر الإرسال حتى يتم توليد الأسئلة

‎            // استدعاء Gemini لتوليد أسئلة المقابلة بناءً على تحليل السيرة الذاتية
‎            // في نظام حقيقي، نستخدم نتائج تحليل السيرة الذاتية المخزنة في Backend
             const prompt = `بناءً على تحليل السيرة الذاتية التالي والمتقدم لوظيفة "${applicantData.jobTitle}" في قطاع طبي، قم بتوليد 5-7 أسئلة مقابلة كتابية احترافية لاختبار مدى ملاءمة المتقدم ومهاراته. اجعل الأسئلة متنوعة وتشمل الجوانب الفنية، السلوكية، وحل المشكلات. يمكن تضمين أسئلة تطلب أمثلة بناءً على الخبرة المذكورة. اجعل الأسئلة مرتبة بقائمة مرقمة.

‎             تحليل السيرة الذاتية وملخصها (محاكاة):
             ${applicantData.cvAnalysis || applicantData.cvTextContent || 'لم يتم تحليل السيرة الذاتية - توليد أسئلة عامة.'}`; // استخدم النص المستخرج أو رسالة بديلة

            const questionsResponse = await callGeminiAPI(prompt);

‎            // تقسيم الرد إلى أسئلة فردية
‎            // تحسين تقسيم الأسئلة
            textInterviewQuestions = questionsResponse.split('\n').filter(q => q.trim().length > 0 && (q.includes('?') || q.includes('.'))).map(q => q.replace(/^\s*[\d\.-]+\s*/, '').trim()); // تنظيف وإزالة ترقيم محتمل

            if (textInterviewQuestions.length > 0) {
                textInterviewQuestionsDiv.innerHTML = '<h3>أسئلة المقابلة الكتابية:</h3>';
                 // applicantData.textInterviewQuestions = textInterviewQuestions; // حفظ الأسئلة (في backend)

                textInterviewQuestions.forEach((q, index) => {
                    const questionElement = document.createElement('div');
                    questionElement.classList.add('form-group');
                    questionElement.innerHTML = `
                        <label for="q${index}">${index + 1}. ${q}</label>
                        <textarea id="q${index}" rows="3" data-question="${q}"></textarea>
‎                        <!-- يمكن إضافة زر تحليل إجابة فردية هنا أيضاً لو كان workflow يسمح بذلك قبل الإرسال النهائي -->
                        <!-- <button type="button" class="ai-helper-button analyze-text-answer-btn" data-question-id="${index}">تحليل هذه الإجابة</button> -->
                        <!-- <div id="q${index}-analysis-results" class="analysis-results hidden"></div> -->
                    `;
                    textInterviewQuestionsDiv.appendChild(questionElement);
                });

                submitTextInterviewBtn.classList.remove('hidden');
                 submitTextInterviewBtn.disabled = false;


            } else {
                textInterviewQuestionsDiv.innerHTML = '<p>لم يتمكن AI من توليد أسئلة مقابلة كتابية. يرجى المحاولة لاحقاً أو تخطي هذه الخطوة.</p>';
                submitTextInterviewBtn.classList.remove('hidden');
                 submitTextInterviewBtn.disabled = false; // لا تزال تسمح بالإرسال للمتابعة
            }
        }

‎        // --- معالجة إرسال إجابات المقابلة الكتابية ---
        submitTextInterviewBtn.addEventListener('click', async () => {
            const answers = {};
            const answerElements = textInterviewQuestionsDiv.querySelectorAll('textarea');
            answerElements.forEach(textarea => {
                const question = textarea.dataset.question;
                const answer = textarea.value;
                answers[question] = answer;
            });
            applicantData.textInterviewAnswers = answers;

‎            // في نظام حقيقي: يتم إرسال الإجابات إلى Backend لتخزينها وتحليلها
             console.log("Simulating sending text interview answers to backend:", answers);


‎            // تحليل إجابات المقابلة الكتابية بالكامل بواسطة AI
            textInterviewOverallAnalysisDiv.classList.remove('hidden');
            textInterviewSummaryP.textContent = 'جاري تحليل إجابات المقابلة الكتابية... (يتطلب خدمة AI)';
             submitTextInterviewBtn.disabled = true; // تعطيل الزر أثناء التحليل

            const answersText = Object.entries(applicantData.textInterviewAnswers)
                .map(([q, a]) => `السؤال: ${q}\nالإجابة: ${a}\n---`)
                .join('\n');

            const prompt = `حلل مجموعة الإجابات التالية لمقابلة كتابية لوظيفة "${applicantData.jobTitle}" في قطاع طبي. قم بتقييم الأداء العام للمتقدم بناءً على هذه الإجابات. هل كانت شاملة، احترافية، ومقنعة؟ استنتج السمات السلوكية الظاهرة من الإجابات (مثل القدرة على التعبير، التفكير المنطقي، الثقة). قدم ملخصاً وتقييماً شاملاً يوضح نقاط القوة والضعف في الإجابات. استخدم اللغة العربية.

‎            الإجابات:
            ${answersText}`;

            const analysisResult = await callGeminiAPI(prompt);
            applicantData.textInterviewAnalysis = analysisResult; // تخزين نتيجة التحليل

            textInterviewSummaryP.textContent = analysisResult;
            textInterviewOverallAnalysisDiv.className = 'analysis-results'; // Reset class
‎            // يمكن إضافة منطق هنا لتغيير لون analysisResultsDiv بناءً على تقييم AI العام

‎            // الانتقال إلى قسم التقييم النهائي
            smartInterviewSection.classList.add('hidden');
            evaluationReportSection.classList.remove('hidden');
             updateWorkflowStatus('evaluation'); // تحديث حالة Workflow

            await generateOverallEvaluation(); // بدء عملية التقييم الشامل
        });


‎        // --- عملية المقابلة الصوتية (محاكاة جزئية جداً) ---
‎        // هذه الدالة تحتاج الكثير من العمل على Backend لتكون واقعية (إدارة الأسئلة، تسجيل الصوت، Speech-to-Text API، تحليل إجابات فردية ثم شامل)
‎        // هنا سيتم محاكاة طرح سؤال واحد فقط وتحويل إجابته النصية لمحاكاة عملية أكبر.

         const voiceInterviewQuestionsList = [
‎             "يرجى تقديم نفسك بإيجاز وتسليط الضوء على سبب اهتمامك بالعمل في ميس الطبية.",
‎             "صف موقفاً واجهتك فيه تحدياً صعباً في عملك السابق وكيف تعاملت معه.",
‎             "ما هي أبرز ثلاث مهارات لديك تجعلك مناسباً لهذه الوظيفة؟",
‎             "كيف تواكب أحدث التطورات في مجال عملك الطبي؟",
‎             "ما هي توقعاتك للراتب والمزايا؟"
         ];

        async function startSmartVoiceInterview() {
             voiceInterviewDiv.classList.remove('hidden');
             startVoiceInterviewBtn.classList.add('hidden');
             currentVoiceQuestionIndex = 0;
             voiceInterviewAnswersTranscriptions = []; // مسح الإجابات السابقة
             voiceInterviewOverallAnalysisDiv.classList.add('hidden'); // إخفاء التحليل الشامل المبدئي

             voiceInterviewQuestions = voiceInterviewQuestionsList; // استخدام قائمة الأسئلة المحاكية
             displayVoiceQuestion(currentVoiceQuestionIndex);
        }

        function displayVoiceQuestion(index) {
             if (index < voiceInterviewQuestions.length) {
                 voiceInterviewQuestionDiv.textContent = `السؤال ${index + 1}: ${voiceInterviewQuestions[index]}`;
                 startVoiceAnswerRecordingBtn.classList.remove('hidden');
                 stopVoiceAnswerRecordingBtn.classList.add('hidden');
                 submitVoiceAnswerBtn.classList.add('hidden');
                 nextVoiceQuestionBtn.classList.add('hidden');
                 finishVoiceInterviewBtn.classList.add('hidden');
                 voiceInterviewPlayback.classList.add('hidden');
                 voiceInterviewTranscriptionDiv.classList.add('hidden');
                  voiceInterviewResultsDiv.classList.add('hidden'); // إخفاء تحليل الإجابة الفردية السابقة

             } else {
                 voiceInterviewQuestionDiv.textContent = 'انتهت أسئلة المقابلة الصوتية.';
                  startVoiceAnswerRecordingBtn.classList.add('hidden');
                  stopVoiceAnswerRecordingBtn.classList.add('hidden');
                  submitVoiceAnswerBtn.classList.add('hidden');
                  nextVoiceQuestionBtn.classList.add('hidden');
                  finishVoiceInterviewBtn.classList.remove('hidden'); // إظهار زر إنهاء المقابلة
                  voiceInterviewPlayback.classList.add('hidden');
                  voiceInterviewTranscriptionDiv.classList.add('hidden');
                  voiceInterviewResultsDiv.classList.add('hidden'); // إخفاء تحليل الإجابة الفردية السابقة
             }
        }

‎        // تسجيل الإجابة الصوتية (محاكاة)
         if (navigator.mediaDevices && navigator.mediaDevices.getUserMedia) {
             let voiceAnswerRecorder;
             let voiceAnswerChunks = [];

             startVoiceAnswerRecordingBtn.addEventListener('click', async () => {
                  try {
                     const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                     voiceAnswerRecorder = new MediaRecorder(stream);
                     voiceAnswerChunks = [];
                      voiceInterviewPlayback.classList.add('hidden'); // إخفاء المشغل
                      voiceInterviewTranscriptionDiv.classList.add('hidden'); // إخفاء النص السابق
                      voiceInterviewResultsDiv.classList.add('hidden'); // إخفاء التحليل السابق


                     voiceAnswerRecorder.ondataavailable = (event) => {
                         voiceAnswerChunks.push(event.data);
                     };

                     voiceAnswerRecorder.onstop = async () => {
                         const audioBlob = new Blob(voiceAnswerChunks, { type: 'audio/wav' });
                         const audioUrl = URL.createObjectURL(audioBlob);
                         voiceInterviewPlayback.src = audioUrl;
                         voiceInterviewPlayback.classList.remove('hidden');

‎                         // محاكاة تحويل الصوت إلى نص
                         voiceInterviewTranscriptionDiv.classList.remove('hidden');
                         voiceInterviewTranscriptionDiv.textContent = 'جاري تحويل الإجابة إلى نص... (يتطلب خدمة backend)';
                          submitVoiceAnswerBtn.disabled = true;
                         nextVoiceQuestionBtn.disabled = true;

                         await new Promise(resolve => setTimeout(resolve, 2000));
‎                          // نص محاكى للإجابة
                         const simulatedAnswerText = `إجابتي على السؤال ${currentVoiceQuestionIndex + 1} هي... [نص محاكى للإجابة على السؤال الحالي]`;
                         voiceInterviewTranscriptionDiv.textContent = `النص المستخرج (محاكاة): ${simulatedAnswerText}`;

                         voiceInterviewAnswersTranscriptions.push({
                             question: voiceInterviewQuestions[currentVoiceQuestionIndex],
                             answer: simulatedAnswerText
‎                         }); // تخزين الإجابة

                          submitVoiceAnswerBtn.disabled = false; // تفعيل زر إرسال وتحليل الإجابة


                         stream.getTracks().forEach(track => track.stop()); // إيقاف المسار الصوتي
                     };

                     voiceAnswerRecorder.start();
                     startVoiceAnswerRecordingBtn.disabled = true;
                     stopVoiceAnswerRecordingBtn.disabled = false;
                      voiceInterviewTranscriptionDiv.classList.remove('hidden');
                     voiceInterviewTranscriptionDiv.textContent = 'التسجيل قيد التقدم للإجابة...';


                  } catch (err) {
                     console.error('Error accessing microphone for voice interview:', err);
                      voiceInterviewTranscriptionDiv.classList.remove('hidden');
                     voiceInterviewTranscriptionDiv.textContent = `خطأ في الوصول إلى الميكروفون: ${err.message}`;
                      startVoiceAnswerRecordingBtn.disabled = false; // إعادة تفعيل الزر
                      stopVoiceAnswerRecordingBtn.disabled = true;
                  }
             });

             stopVoiceAnswerRecordingBtn.addEventListener('click', () => {
                 voiceAnswerRecorder.stop();
                 startVoiceAnswerRecordingBtn.disabled = false;
                 stopVoiceAnswerRecordingBtn.disabled = true;
             });

‎             // إرسال وتحليل الإجابة الفردية (محاكاة)
             submitVoiceAnswerBtn.addEventListener('click', async () => {
                 submitVoiceAnswerBtn.disabled = true;
                  voiceInterviewResultsDiv.classList.remove('hidden');
                 voiceInterviewResultsDiv.textContent = 'جاري تحليل الإجابة بواسطة AI...';

                 const currentQuestion = voiceInterviewQuestions[currentVoiceQuestionIndex];
                 const currentAnswer = voiceInterviewAnswersTranscriptions[currentVoiceQuestionIndex].answer;

                 const prompt = `حلل الإجابة التالية لسؤال المقابلة الصوتية "${currentQuestion}" في سياق التقديم لوظيفة "${applicantData.jobTitle}" في قطاع طبي. قم بتقييم مدى ملاءمة الإجابة، احترافيتها، ووضوحها. قدم نقاط تحسين أو ملاحظات إيجابية بناءً على الإجابة. استخدم اللغة العربية.

‎                 الإجابة (نص مستخرج):
                 ${currentAnswer}`;

                 const result = await callGeminiAPI(prompt);
                 voiceInterviewAnswersTranscriptions[currentVoiceQuestionIndex].analysis = result; // تخزين تحليل الإجابة
                 voiceInterviewResultsDiv.textContent = result;
                  voiceInterviewResultsDiv.className = 'analysis-results'; // Reset class

‎                 // تحديد اللون بناءً على النتيجة المحللة (كلمات مفتاحية)
                  if (result.includes('ممتازة') || result.includes('قوية جدا')) {
                      voiceInterviewResultsDiv.classList.add('green');
                  } else if (result.includes('تحتاج تحسين') || result.includes('بعض الغموض')) {
                       voiceInterviewResultsDiv.classList.add('warning');
                  } else if (result.includes('غير مناسبة') || result.includes('ضعيفة')) {
                       voiceInterviewResultsDiv.classList.add('danger');
                  }


                  nextVoiceQuestionBtn.classList.remove('hidden'); // إظهار زر السؤال التالي
                  nextVoiceQuestionBtn.disabled = false;

             });

‎             // الانتقال للسؤال التالي
             nextVoiceQuestionBtn.addEventListener('click', () => {
                 currentVoiceQuestionIndex++;
                 displayVoiceQuestion(currentVoiceQuestionIndex);
             });

‎             // إنهاء المقابلة الصوتية وتحليلها الشامل
             finishVoiceInterviewBtn.addEventListener('click', async () => {
                  finishVoiceInterviewBtn.disabled = true;
                  voiceInterviewOverallAnalysisDiv.classList.remove('hidden');
                  voiceInterviewSummaryP.textContent = 'جاري تحليل المقابلة الصوتية الشامل... (يتطلب خدمة AI)';

                 applicantData.voiceInterviewAnswers = voiceInterviewAnswersTranscriptions; // حفظ كل الإجابات وتحليلاتها

                 const allAnswersText = voiceInterviewAnswersTranscriptions
                    .map(item => `السؤال: ${item.question}\nالإجابة: ${item.answer}\nتحليل AI الفردي: ${item.analysis || 'لا يتوفر.'}\n---`)
                    .join('\n');

                 const prompt = `حلل المقابلة الصوتية التالية لوظيفة "${applicantData.jobTitle}" في قطاع طبي بناءً على نصوص الأسئلة والإجابات المستخرجة (بالإضافة إلى التحليلات الفردية المرفقة إن وجدت). قم بتقييم الأداء العام للمتقدم في المقابلة. استنتج السمات السلوكية ومهارات التواصل الظاهرة من مجموع الإجابات. قدم ملخصاً شاملاً يوضح نقاط القوة والضعف الرئيسية للمتقدم خلال هذه المقابلة. استخدم اللغة العربية.

‎                 نص المقابلة الصوتية (محاكاة):
                 ${allAnswersText}`;

                 const analysisResult = await callGeminiAPI(prompt);
                 applicantData.voiceInterviewAnalysis = analysisResult; // تخزين نتيجة التحليل الشامل

                 voiceInterviewSummaryP.textContent = analysisResult;
                 voiceInterviewOverallAnalysisDiv.className = 'analysis-results'; // Reset class
‎                 // يمكن إضافة منطق لتغيير لون هذا القسم أيضاً بناءً على تقييم AI

‎                 // الانتقال إلى قسم التقييم النهائي
                 smartInterviewSection.classList.add('hidden');
                 evaluationReportSection.classList.remove('hidden');
                 updateWorkflowStatus('evaluation'); // تحديث حالة Workflow

                 await generateOverallEvaluation(); // بدء عملية التقييم الشامل

             });

         } else {
‎             // تعطيل المقابلة الصوتية إذا كان التسجيل غير مدعوم
             document.getElementById('select-voice-interview').disabled = true;
             document.getElementById('select-voice-interview').textContent += ' (المقابلة الصوتية غير مدعومة في متصفحك)';
         }




‎        // --- عملية التقييم الذكي الشامل ---
        async function generateOverallEvaluation() {
            evaluationSummaryTextP.textContent = 'جاري توليد التقييم النهائي... (يتطلب خدمة AI)';
             evaluationSummaryDiv.classList.remove('hidden');
             strengthWeaknessAnalysisDiv.classList.add('hidden'); // إخفاء حتى يتم التحليل
             behavioralAnalysisDiv.classList.add('hidden'); // إخفاء حتى يتم التحليل
             generatePdfButton.disabled = true; // تعطيل زر التقرير حتى اكتمال التقييم

             updateWorkflowStatus('evaluation'); // التأكد من الحالة الصحيحة

‎            // جمع كل النتائج التحليلية المتوفرة
            const allAnalysisPrompt = `
‎            بناءً على البيانات التالية لمتقدم لوظيفة "${applicantData.jobTitle}" في ميس الطبية، قم بإجراء تقييم شامل وتوليد ملخص مفصل.

‎            بيانات المتقدم الأساسية:
‎            - المؤهل: ${applicantData.educationLevel}
‎            - التخصص: ${applicantData.major}
‎            - سنوات الخبرة: ${applicantData.experienceYears}

‎            تحليل السيرة الذاتية (CV Analysis):
            ${applicantData.cvAnalysis || 'لا يتوفر تحليل للسيرة الذاتية.'}
‎            نسبة التطابق مع الوظيفة (من تحليل السيرة الذاتية): ${applicantData.cvMatchScore || '--'}
‎            المهارات المستخرجة من السيرة الذاتية: ${applicantData.cvExtractedSkills || 'لا توجد.'}
‎             ملاحظات تحتاج تدقيق من السيرة الذاتية: ${applicantData.cvRedFlags || 'لا يوجد.'}


‎            تحليل الشرح الصوتي الأولي (Audio Intro Analysis):
            ${applicantData.audioAnalysis || 'لا يتوفر تحليل للشرح الصوتي.'}
‎            نص الشرح الصوتي: ${applicantData.audioTranscription || 'لا يتوفر نص.'}


‎            تحليل المقابلة الكتابية (Text Interview Analysis):
            ${applicantData.textInterviewAnalysis || 'لا يتوفر تحليل للمقابلة الكتابية.'}
‎            // في نظام حقيقي، يمكن إرفاق نصوص الإجابات الفردية هنا أيضاً.


‎            // يمكن إضافة تحليل المقابلة الصوتية هنا إذا تم تنفيذها في workflow
‎            تحليل المقابلة الصوتية (Voice Interview Analysis - إذا تم إجراؤها):
            ${applicantData.voiceInterviewAnalysis || 'لم يتم إجراء المقابلة الصوتية.'}
‎            // في نظام حقيقي، يمكن إرفاق نصوص الإجابات الفردية هنا أيضاً.


‎            المهمة:
‎            1.  قم بتوليد "ملخص تقييم شامل" يدمج نتائج جميع التحليلات أعلاه لتقديم صورة متكاملة عن المتقدم وملاءمته للوظيفة.
‎            2.  استنتج "نقاط القوة والضعف الرئيسية" للمتقدم بناءً على جميع البيانات. قدمها في شكل قائمة نقطية.
‎            3.  استنتج "السمات السلوكية ومهارات التواصل" الظاهرة من الشرح الصوتي والمقابلات. قدمها في شكل قائمة نقطية.
‎            4.  قم بتقييم نهائي شامل للمتقدم بنظام نقاط من 0 إلى 100، حيث 100 هو الأعلى ملاءمة. يجب أن يعكس هذا التقييم الموزون أهمية كل جزء (ربما CV له وزن، الشرح الصوتي وزن، المقابلة الكتابية وزن، المقابلة الصوتية وزن آخر).
‎            5.  قدم "توصية نهائية" مبدئية للتوظيف (يوصى بشدة، يوصى، مقبول مع تحفظ، لا يوصى) بناءً على التقييم.

‎            صيغة الرد المطلوبة (استخدم عناوين واضحة):
‎            التقييم النهائي (من 100): [رقم من 0-100]
‎            ملخص التقييم الشامل: [نص الملخص]
‎            نقاط القوة:
‎            [قائمة نقطية بنقاط القوة]
‎            نقاط الضعف:
‎            [قائمة نقطية بنقاط الضعف]
‎            السمات السلوكية ومهارات التواصل:
‎            [قائمة نقطية بالسمات]
‎            التوصية النهائية: [نص التوصية]
            `;

            const evaluationResult = await callGeminiAPI(allAnalysisPrompt);
            applicantData.overallEvaluationSummary = evaluationResult; // تخزين النتيجة النصية الكاملة

‎            // محاولة استخلاص الأجزاء المختلفة من الرد المنظم
             const evaluationParts = evaluationResult.split('\n\n').reduce((acc, block) => {
                if (block.startsWith('التقييم النهائي (من 100):')) acc.score = block.replace('التقييم النهائي (من 100):', '').trim();
                else if (block.startsWith('ملخص التقييم الشامل:')) acc.summary = block.replace('ملخص التقييم الشامل:', '').trim();
                else if (block.startsWith('نقاط القوة:')) acc.strength = block.replace('نقاط القوة:', '').trim();
                else if (block.startsWith('نقاط الضعف:')) acc.weakness = block.replace('نقاط الضعف:', '').trim();
                else if (block.startsWith('السمات السلوكية ومهارات التواصل:')) acc.behavioral = block.replace('السمات السلوكية ومهارات التواصل:', '').trim();
                else if (block.startsWith('التوصية النهائية:')) acc.recommendation = block.replace('التوصية النهائية:', '').trim();
                return acc;
            }, { score: '--', summary: '', strength: '', weakness: '', behavioral: '', recommendation: '' });


‎            // عرض النتيجة الرقمية والمؤشر
            const score = parseInt(evaluationParts.score, 10);
            if (!isNaN(score)) {
                applicantData.overallEvaluationScore = score;
                overallScoreSpan.textContent = score;

                overallEvaluationIndicatorDiv.className = 'evaluation-indicator'; // reset classes
                if (score >= 80) {
                    overallEvaluationIndicatorDiv.classList.add('green');
                     evaluationSummaryDiv.className = 'analysis-results green';
                      strengthWeaknessAnalysisDiv.className = 'analysis-results green';
                      behavioralAnalysisDiv.className = 'analysis-results green';
                } else if (score >= 50) {
                    overallEvaluationIndicatorDiv.classList.add('yellow');
                     evaluationSummaryDiv.className = 'analysis-results warning';
                      strengthWeaknessAnalysisDiv.className = 'analysis-results warning';
                       behavioralAnalysisDiv.className = 'analysis-results warning';
                } else {
                    overallEvaluationIndicatorDiv.classList.add('red');
                     evaluationSummaryDiv.className = 'analysis-results danger';
                     strengthWeaknessAnalysisDiv.className = 'analysis-results danger';
                     behavioralAnalysisDiv.className = 'analysis-results danger';
                }
            } else {
                overallScoreSpan.textContent = '--';
                overallEvaluationIndicatorDiv.className = 'evaluation-indicator'; // default grey
                 evaluationSummaryDiv.className = 'analysis-results warning'; // Use warning for unclear score
                 strengthWeaknessAnalysisDiv.className = 'analysis-results warning';
                 behavioralAnalysisDiv.className = 'analysis-results warning';
            }

‎            // عرض الملخصات النصية المفصلة
             evaluationSummaryDiv.classList.remove('hidden');
            evaluationSummaryTextP.textContent = `${evaluationParts.summary.trim()}\n\nالتوصية النهائية: ${evaluationParts.recommendation.trim()}`;

             strengthWeaknessAnalysisDiv.classList.remove('hidden');
             strengthWeaknessTextP.textContent = `نقاط القوة:\n${evaluationParts.strength.trim()}\n\nنقاط الضعف:\n${evaluationParts.weakness.trim()}`;

             behavioralAnalysisDiv.classList.remove('hidden');
             behavioralAnalysisTextP.textContent = evaluationParts.behavioral.trim();

‎             // تخزين الأجزاء المفصلة في بيانات المتقدم
             applicantData.strengthWeakness = `قوة: ${evaluationParts.strength.trim()}\n ضعف: ${evaluationParts.weakness.trim()}`;
             applicantData.behavioralTraits = evaluationParts.behavioral.trim();
             applicantData.recommendation = evaluationParts.recommendation.trim();


‎            // تفعيل زر توليد التقرير
            generatePdfButton.disabled = false;

‎            // عرض قسم مسؤول التوظيف (للعرض فقط)
             recruiterViewSection.classList.remove('hidden');
             displayApplicantSummaryForRecruiter();

‎             // عرض قسم المقارنة (للعرض فقط - بيانات افتراضية + بيانات المتقدم الحالي)
             comparisonMatrixSection.classList.remove('hidden');
             addCurrentApplicantToComparisonTable(); // إضافة بيانات المتقدم الحالي
             await generateComparisonAnalysis(); // بدء تحليل المقارنة بواسطة AI

             updateWorkflowStatus('completed'); // تحديث حالة Workflow إلى مكتمل
        }

‎        // --- إضافة بيانات المتقدم الحالي إلى جدول المقارنة ---
        function addCurrentApplicantToComparisonTable() {
             const newRow = comparisonTableBody.insertRow();
             newRow.innerHTML = `
                 <td>${applicantData.fullName} (أنت)</td>
                 <td>${applicantData.experienceYears}</td>
                 <td>${applicantData.major}</td>
                 <td>${applicantData.textInterviewAnalysis ? 'تم التقييم' : 'لا يوجد'}</td>
                 <td>${applicantData.voiceInterviewAnalysis ? 'تم التقييم' : 'لا يوجد'}</td>
                 <td>${applicantData.cvMatchScore || '--'}</td>
                 <td>${applicantData.overallEvaluationScore} <span class="evaluation-indicator ${applicantData.overallEvaluationScore >= 80 ? 'green' : applicantData.overallEvaluationScore >= 50 ? 'yellow' : 'red'}"></span></td>
             `;
‎             // يمكن إضافة لون خلفية مميز لصف المتقدم الحالي
             newRow.style.backgroundColor = '#e9f7ef'; // لون أخضر فاتح
        }


‎        // --- توليد تحليل المقارنة (بيانات افتراضية + بيانات المتقدم الحالي) ---
        async function generateComparisonAnalysis() {
             comparisonAnalysisTextP.textContent = 'جاري توليد تحليل المقارنة... (يتطلب خدمة AI)';
             comparisonAnalysisDiv.classList.remove('hidden');

‎             // جمع بيانات المتقدمين من الجدول (يشمل المتقدم الحالي)
             const comparisonData = [];
             comparisonTableBody.querySelectorAll('tr').forEach(row => {
                 const cells = row.querySelectorAll('td');
                 if (cells.length > 0) {
                     comparisonData.push({
                         name: cells[0].textContent.trim(),
                         experience: cells[1].textContent.trim(),
                         major: cells[2].textContent.trim(),
                         textInterview: cells[3].textContent.trim(),
                         voiceInterview: cells[4].textContent.trim(),
                         cvMatch: cells[5].textContent.trim(),
                         overallScore: cells[6].textContent.split(' ')[0].trim() // استخلاص النتيجة فقط
                     });
                 }
             });

             const comparisonPrompt = `
‎             قم بتحليل مقارن بين المتقدمين التاليين لوظيفة في ميس الطبية، بناءً على بياناتهم وتقييماتهم المتاحة:
             ${comparisonData.map(app => `
‎             - الاسم: ${app.name}
‎               الخبرة: ${app.experience}
‎               التخصص: ${app.major}
‎               أداء المقابلة الكتابية: ${app.textInterview}
‎               أداء المقابلة الصوتية: ${app.voiceInterview}
‎               تطابق السيرة الذاتية: ${app.cvMatch}
‎               التقييم العام: ${app.overallScore}`).join('\n---\n')}

‎             ركز على نقاط القوة النسبية لكل متقدم، الاختلافات الرئيسية في الخبرة والمهارات وأداء المقابلات، ومدى ملاءمتهم مقارنة ببعضهم البعض بناءً على التقييم العام. اقترح المرشح (أو المرشحين) الأكثر ملاءمة لهذا الدور بناءً على هذه البيانات، مع ذكر مبرراتك. استخدم اللغة العربية.
‎             `; // يجب تعديل ال prompt ليتناسب مع سيناريو وظيفة واحدة للمقارنة في نظام حقيقي

             const analysisResult = await callGeminiAPI(comparisonPrompt);
             comparisonAnalysisTextP.textContent = analysisResult;
             comparisonAnalysisDiv.className = 'analysis-results'; // reset class
‎             // يمكن إضافة منطق هنا لتغيير لون div بناءً على التوصية العامة
        }


‎        // --- عرض ملخص المتقدم لمسؤول التوظيف ---
        function displayApplicantSummaryForRecruiter() {
            const summaryDiv = document.getElementById('applicant-summary');
‎             // بناء المحتوى HTML لعرض الملخص
            summaryDiv.innerHTML = `
                <h3>ملخص طلب المتقدم: ${applicantData.fullName}</h3>
                <p><strong>حالة الطلب:</strong> <span style="color: green; font-weight: bold;">${currentStatusSpan.textContent}</span></p> <!-- عرض الحالة الحالية -->
                <p><strong>الوظيفة المتقدم لها:</strong> ${applicantData.jobTitle}</p>
                <p><strong>التقييم العام:</strong> ${applicantData.overallEvaluationScore} <span class="evaluation-indicator ${applicantData.overallEvaluationScore >= 80 ? 'green' : applicantData.overallEvaluationScore >= 50 ? 'yellow' : 'red'}"></span></p>
                 <div class="analysis-results">
                     <h4>ملخص التقييم الشامل (AI):</h4>
                     <p>${applicantData.overallEvaluationSummary.replace(/التقييم النهائي.*|نقاط القوة.*|نقاط الضعف.*|السمات السلوكية.*|التوصية النهائية.*/gs, '').trim()}</p> <!-- عرض الملخص فقط -->
                     <p><strong>التوصية النهائية (AI):</strong> ${applicantData.recommendation || 'لا يوجد توصية.'}</p>
                 </div>
                  <div class="analysis-results">
                      <h4>نقاط القوة والضعف (AI):</h4>
                      <p>${applicantData.strengthWeakness || 'لا يوجد تحليل.'}</p>
                 </div>
                 <div class="analysis-results">
                      <h4>السمات السلوكية ومهارات التواصل (AI):</h4>
                      <p>${applicantData.behavioralTraits || 'لا يوجد تحليل.'}</p>
                 </div>


                <h4>بيانات الاتصال:</h4>
                <ul>
                    <li>البريد الإلكتروني: ${applicantData.email}</li>
                    <li>رقم الجوال: ${applicantData.phone}</li>
                    <li>المدينة: ${applicantData.city}</li>
                    <li>الجنس: ${applicantData.gender}</li>
                    <li>الحالة الاجتماعية: ${applicantData.maritalStatus}</li>
                </ul>

                <h4>الخلفية التعليمية والمهنية:</h4>
                 <ul>
                     <li>المؤهل العلمي: ${applicantData.educationLevel}</li>
                     <li>التخصص: ${applicantData.major}</li>
                     <li>سنوات الخبرة: ${applicantData.experienceYears}</li>
                     <li>الهدف الوظيفي: ${applicantData.careerObjective || 'لم يحدد.'}</li>
                      <li>ملاحظات إضافية: ${applicantData.notes || 'لا يوجد.'}</li>
                 </ul>


                <h4>تحليل السيرة الذاتية:</h4>
                 <div class="analysis-results">
                     <p><strong>مدى التطابق مع الوظيفة:</strong> ${applicantData.cvMatchScore || '--'}</p>
                     <h4>ملخص التحليل (AI):</h4>
‎                      <!-- عرض نتائج التحليل المفصلة المخزنة -->
                     <p>${applicantData.cvAnalysis.replace(/ملخص التحليل.*|الخبرات.*|المهارات.*|المؤهل.*|ملاحظات إيجابية.*|ملاحظات تحتاج تدقيق.*|نسبة التطابق.*/gs, '').trim()}</p>
                      <h4>الخبرات والمهارات المستخرجة (AI):</h4>
                       <p>الخبرات: ${applicantData.cvAnalysis.includes('الخبرات:') ? applicantData.cvAnalysis.split('الخبرات:')[1].split('المهارات:')[0].trim() : 'لا توجد.'}</p>
                       <p>المهارات: ${applicantData.cvExtractedSkills || 'لا توجد.'}</p>
                       <p>ملاحظات تحتاج تدقيق: ${applicantData.cvRedFlags || 'لا يوجد.'}</p>
                 </div>


                 <h4>الشرح الصوتي (المرفق/المسجل):</h4>
                 <p><strong>النص المستخرج (AI):</strong> ${applicantData.audioTranscription || 'لا يتوفر نص مستخرج.'}</p>
                  <div class="analysis-results">
                      <h4>تحليل الشرح الصوتي (AI):</h4>
                      <p>${applicantData.audioAnalysis || 'لا يتوفر تحليل.'}</p>
                  </div>
                 ${applicantData.audioProvided ? '<p><button onclick="alert(\'محاكاة تشغيل المقطع الصوتي الأصلي\')">تشغيل المقطع الصوتي الأصلي</button></p>' : ''} <!-- محاكاة تشغيل الصوت الأصلي -->

                 <h4>المقابلة الكتابية:</h4>
                 <div class="analysis-results">
                     <h4>تحليل المقابلة الكتابية الشامل (AI):</h4>
                     <p>${applicantData.textInterviewAnalysis || 'لا يتوفر تحليل للمقابلة الكتابية.'}</p>
                 </div>
‎                  <!-- يمكن عرض إجابات المتقدم الفردية هنا -->
                 <!-- <h4>إجابات المتقدم:</h4> -->
                 <!-- <ul> ... عرض إجابات applicantData.textInterviewAnswers ... </ul> -->


                 <h4>المقابلة الصوتية (إذا تم إجراؤها):</h4>
                  <div class="analysis-results">
                     <h4>تحليل المقابلة الصوتية الشامل (AI):</h4>
                      <p>${applicantData.voiceInterviewAnalysis || 'لم يتم إجراء المقابلة الصوتية أو لا يتوفر تحليل.'}</p>
                  </div>
‎                  <!-- يمكن عرض إجابات المتقدم الفردية هنا مع تحليل كل إجابة -->

            `;

‎            // إضافة class مناسب لنتائج التحليل في عرض المسؤول بناءً على محتواها أو درجة التقييم
             summaryDiv.querySelectorAll('.analysis-results').forEach(div => {
                 if (div.textContent.includes('نقاط قوة') || div.textContent.includes('ممتاز') || div.textContent.includes('قوية جدا')) div.classList.add('green');
                  else if (div.textContent.includes('نقاط ضعف') || div.textContent.includes('تحتاج تحسين') || div.textContent.includes('بعض الغموض')) div.classList.add('warning');
                  else if (div.textContent.includes('غير مناسبة') || div.textContent.includes('ضعيفة جدا')) div.classList.add('danger');
                   else div.className = 'analysis-results'; // إعادة تعيين اللون الافتراضي
             });

        }


‎        // --- توليد تقرير PDF ---
        generatePdfButton.addEventListener('click', async () => {
            pdfStatusDiv.textContent = 'جاري تجهيز محتوى التقرير...';
            generatePdfButton.disabled = true;

‎            // في نظام حقيقي، هذا المحتوى يأتي من Backend
‎            // هنا، نستخدم بيانات applicantData التي جمعناها ونحللها مجدداً لتقرير منظم
            const reportTextContent = `
‎            تقرير تقييم وتوظيف المتقدم: ${applicantData.fullName}

‎            الوظيفة المتقدم لها: ${applicantData.jobTitle}

‎            البيانات الأساسية:
‎            - الاسم: ${applicantData.fullName}
‎            - رقم الهوية: ${applicantData.idNumber}
‎            - البريد الإلكتروني: ${applicantData.email}
‎            - رقم الجوال: ${applicantData.phone}
‎            - الجنس: ${applicantData.gender}
‎            - الحالة الاجتماعية: ${applicantData.maritalStatus}
‎            - المدينة: ${applicantData.city}
‎            - المؤهل العلمي: ${applicantData.educationLevel}
‎            - التخصص: ${applicantData.major}
‎            - سنوات الخبرة: ${applicantData.experienceYears}
‎            - الهدف الوظيفي: ${applicantData.careerObjective || 'لم يحدد.'}
‎            - ملاحظات إضافية من المتقدم: ${applicantData.notes || 'لا يوجد.'}
‎            - السيرة الذاتية المرفقة: ${applicantData.cvFileName || 'لا يوجد ملف.'}
‎            - الشرح الصوتي المرفق: ${applicantData.audioProvided ? 'متوفر.' : 'لا يوجد.'}

            ---

‎            التقييم الذكي الشامل (AI):
‎            النتيجة الإجمالية: ${applicantData.overallEvaluationScore} / 100
‎            ملخص التقييم: ${applicantData.overallEvaluationSummary.replace(/التقييم النهائي.*:/, '').trim()}

            ---

‎            تحليل السيرة الذاتية (AI):
‎            نسبة التطابق مع الوظيفة: ${applicantData.cvMatchScore || '--'}
‎            المهارات المستخرجة: ${applicantData.cvExtractedSkills || 'لا يوجد.'}
‎            نقاط تحتاج تدقيق من السيرة الذاتية: ${applicantData.cvRedFlags || 'لا يوجد.'}

            ---

‎            تحليل الشرح الصوتي (AI):
‎            النص المستخرج: ${applicantData.audioTranscription || 'لا يوجد نص مستخرج.'}
‎            التحليل: ${applicantData.audioAnalysis || 'لا يوجد تحليل.'}

            ---

‎            تحليل المقابلة الكتابية (AI):
‎            التحليل الشامل للإجابات: ${applicantData.textInterviewAnalysis || 'لا يوجد تحليل.'}
‎            // في التقرير النهائي في نظام حقيقي، يمكن تضمين نصوص جميع الأسئلة والإجابات هنا.

            ---

‎            تحليل المقابلة الصوتية (AI - إذا تم إجراؤها):
‎            التحليل الشامل للإجابات: ${applicantData.voiceInterviewAnalysis || 'لم يتم إجراء المقابلة الصوتية.'}
‎            // في التقرير النهائي في نظام حقيقي، يمكن تضمين نصوص جميع الأسئلة والإجابات هنا.

            ---

‎            نقاط القوة والضعف (AI):
‎            نقاط القوة:
            ${applicantData.strengthWeakness.includes('قوة:') ? applicantData.strengthWeakness.split('قوة:')[1].split('ضعف:')[0].trim() : 'لا يوجد تحليل.'}
‎            نقاط الضعف:
            ${applicantData.strengthWeakness.includes('ضعف:') ? applicantData.strengthWeakness.split('ضعف:')[1].trim() : 'لا يوجد تحليل.'}

            ---

‎            السمات السلوكية ومهارات التواصل (AI):
            ${applicantData.behavioralTraits || 'لا يوجد تحليل.'}

            ---

‎            التوصية النهائية (AI):
            ${applicantData.recommendation || 'لا يوجد توصية.'}

            ---

‎            ملاحظات إضافية لمسؤول التوظيف:
‎            // يمكن إضافة ملاحظات يدوية من المسؤولين هنا في نظام حقيقي
‎            لا يوجد ملاحظات إضافية في هذا التقرير التلقائي.

‎            تم توليد هذا التقرير تلقائياً بواسطة نظام التوظيف الذكي لميس الطبية.
‎            التاريخ: ${new Date().toLocaleDateString('ar-SA')}
            `;

            pdfStatusDiv.textContent = 'جاري إنشاء ملف PDF...';

‎            // استخدام jsPDF لتوليد الملف
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();

‎            // الخطوط العربية في jsPDF مشكلة معروفة بدون مكتبات مساعدة أو تضمين الخطوط يدوياً (كـ Base64 مثلاً)
‎            // الكود التالي هو مثال يوضح كيف يمكن استخدام الخط إذا تم تضمينه بشكل صحيح.
‎            // إذا لم يظهر النص العربي بشكل صحيح، فقد تحتاج لمكتبة مثل jspdf-arabic أو حل backend.
            try {
‎                 // محاولة إضافة خط افتراضي أو استخدام خط النظام إذا لم يتم تضمين خط مخصص
                 // doc.addFont('Amiri-Regular.ttf', 'Amiri-Regular', 'normal'); // يتطلب توفير ملف الخط
                 // doc.setFont('Amiri-Regular');
                 doc.setFont('helvetica'); // استخدام خط نظام شائع، قد لا يدعم العربية بشكل مثالي
                 doc.setRTLTextDirection(true); // تفعيل اتجاه النص من اليمين لليسار
                 doc.setFontSize(12);

                 let y = 15; // بداية الإحداثي Y للصفحة من الأعلى
                 const pageHeight = doc.internal.pageSize.getHeight();
                 const pageWidth = doc.internal.pageSize.getWidth();
                 const margin = 15; // الهامش من الجوانب

‎                 // تقسيم المحتوى النصي إلى أسطر مناسبة
                 // jsPDF مع RTL تحتاج الحسابات من اليمين
                 const splitText = doc.splitTextToSize(reportTextContent, pageWidth - 2 * margin); // تقسيم النص ليناسب العرض بين الهامشين


‎                 // إضافة النص إلى ال PDF
                 splitText.forEach(line => {
                     // doc.text(text, x, y, { align: 'right' }) هي الطريقة الأفضل مع RTLTextDirection
                     doc.text(line, pageWidth - margin, y, { align: 'right' });
                     y += 7; // زيادة الارتفاع لكل سطر
                     if (y > pageHeight - margin) { // إضافة صفحة جديدة إذا امتلأت الصفحة
                         doc.addPage();
                         // doc.setFont('Amiri-Regular'); // إعادة تعيين الخط للصفحة الجديدة إذا كان مخصصاً
                          doc.setFont('helvetica');
                          doc.setRTLTextDirection(true);
                         doc.setFontSize(12);
                         y = margin; // بداية الصفحة الجديدة بالهامش العلوي
                     }
                 });

‎                 // حفظ الملف
                 doc.save(`تقرير_توظيف_${applicantData.fullName.replace(/\s/g, '_')}.pdf`);

                 pdfStatusDiv.textContent = 'تم إنشاء تقرير PDF بنجاح.';
                 pdfStatusDiv.className = 'analysis-results green'; // إشارة نجاح

             } catch (e) {
                  console.error("PDF Generation Error:", e);
                  pdfStatusDiv.textContent = `خطأ في توليد ملف PDF. قد تكون مشكلة في دعم الخطوط العربية. ${e.message}`;
                   pdfStatusDiv.className = 'analysis-results danger'; // إشارة خطأ
             }


            generatePdfButton.disabled = false;
        });


‎        // --- تصدير بيانات المتقدم (للعرض التوضيحي لمسؤول التوظيف) ---
        document.getElementById('export-applicant-data').addEventListener('click', () => {
             const dataStr = "data:text/json;charset=utf-8," + encodeURIComponent(JSON.stringify(applicantData, null, 2));
             const downloadAnchorNode = document.createElement('a');
             downloadAnchorNode.setAttribute("href", dataStr);
             downloadAnchorNode.setAttribute("download", `applicant_data_${applicantData.fullName.replace(/\s/g, '_')}.json`);
             document.body.appendChild(downloadAnchorNode); // Required for Firefox
             downloadAnchorNode.click();
             downloadAnchorNode.remove();
        });


‎        // --- تهيئة مبدئية عند تحميل الصفحة ---
        document.addEventListener('DOMContentLoaded', () => {
‎            // يمكنك هنا تحميل قائمة الوظائف ديناميكياً إذا كانت لديك Backend API
‎            // مثال: fetch('/api/jobs').then(response => response.json()).then(jobs => { ... fill select ... });

‎            // تعطيل أزرار التحليل حتى يتم توفير المدخلات ذات الصلة
            document.querySelectorAll('.ai-helper-button[data-field="cv-analysis"], .ai-helper-button[data-field="audio-analysis"]').forEach(btn => btn.disabled = true);
‎            // تعطيل زر توليد التقرير حتى اكتمال التقييم
            generatePdfButton.disabled = true;

‎             // إخفاء الأقسام الإضافية عند التحميل
            smartInterviewSection.classList.add('hidden');
            evaluationReportSection.classList.add('hidden');
            recruiterViewSection.classList.add('hidden');
            comparisonMatrixSection.classList.add('hidden');
‎             // إخفاء عناصر المقابلة الصوتية والكتابية حتى يتم اختيار النوع
             textInterviewDiv.classList.add('hidden');
             voiceInterviewDiv.classList.add('hidden');


‎             // إخفاء مشغل الصوت المرفوع/المسجل افتراضياً
             audioPlayback.classList.add('hidden');
             audioTranscriptionDiv.classList.add('hidden');

‎             // إخفاء نتائج التحليل المبدئية
              cvAnalysisResultsDiv.classList.add('hidden');
              audioAnalysisResultsDiv.classList.add('hidden');
              textInterviewOverallAnalysisDiv.classList.add('hidden');
              voiceInterviewResultsDiv.classList.add('hidden');
              voiceInterviewOverallAnalysisDiv.classList.add('hidden');
               evaluationSummaryDiv.classList.add('hidden');
               strengthWeaknessAnalysisDiv.classList.add('hidden');
               behavioralAnalysisDiv.classList.add('hidden');
                comparisonAnalysisDiv.classList.add('hidden');


             updateWorkflowStatus('application'); // تعيين الحالة المبدئية

‎             // // لتفعيل المقابلة الصوتية (اختياري - إذا كانت ميزة مدعومة جزئياً فقط)
             // document.getElementById('select-voice-interview').addEventListener('click', startSmartVoiceInterview);

        });
        /* --- END OF FILE script.txt --- */
    </script>
</body>
</html>