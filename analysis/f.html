<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mais Medical - Sales Analysis Dashboard</title>
    <!-- Bootstrap 5 CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Font Awesome Icons -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <!-- Chart.js -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root {
            --primary: #0066cc;
            --primary-light: #3385d6;
            --secondary: #f8f9fa;
            --accent: #17a2b8;
            --dark: #343a40;
            --light: #f8f9fa;
            --danger: #dc3545;
            --success: #28a745;
            --warning: #ffc107;
            --gray: #6c757d;
            --gray-light: #e9ecef;
        }
        
        body {
            background-color: #f5f7fa;
            color: #333;
            line-height: 1.6;
        }
        
        .navbar-brand {
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .navbar-brand i {
            color: #fff;
        }
        
        .dashboard-title {
            font-size: 1rem;
            font-weight: 400;
            color: rgba(255, 255, 255, 0.9);
        }
        
        .card {
            border-radius: 8px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.05);
            transition: transform 0.3s ease, box-shadow 0.3s ease;
            margin-bottom: 25px;
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
        }
        
        .card-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 1.25rem;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .card-title {
            font-size: 1.25rem;
            font-weight: 600;
            color: var(--dark);
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 0;
        }
        
        .card-title i {
            color: var(--primary);
        }
        
        .section-divider {
            display: flex;
            align-items: center;
            margin: 1.5rem 0;
            font-weight: 500;
            color: var(--gray);
        }
        
        .section-divider::before,
        .section-divider::after {
            content: "";
            flex: 1;
            height: 1px;
            background-color: var(--gray-light);
        }
        
        .section-divider::before {
            margin-right: 1rem;
        }
        
        .section-divider::after {
            margin-left: 1rem;
        }
        
        .file-upload {
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            border: 2px dashed var(--gray-light);
            border-radius: 6px;
            padding: 30px;
            text-align: center;
            cursor: pointer;
            transition: all 0.3s ease;
        }
        
        .file-upload:hover {
            border-color: var(--primary-light);
            background-color: rgba(0, 102, 204, 0.02);
        }
        
        .file-upload i {
            font-size: 2.5rem;
            color: var(--primary);
            margin-bottom: 15px;
        }
        
        .file-upload-text {
            margin-bottom: 10px;
            font-weight: 500;
        }
        
        .file-upload-info {
            color: var(--gray);
            font-size: 0.9rem;
            margin-bottom: 15px;
        }
        
        .file-input {
            display: none;
        }
        
        .summary-list li {
            margin-bottom: 10px;
        }
        
        .chart-container {
            position: relative;
            height: 300px;
            margin-top: 20px;
        }
        
        .recommendations {
            background-color: #f0f7ff;
            border-left: 4px solid var(--primary);
            padding: 15px;
            margin-top: 20px;
            border-radius: 0 6px 6px 0;
        }
        
        .recommendation-title {
            font-weight: 600;
            color: var(--primary);
            margin-bottom: 10px;
        }
        
        /* Loading animation */
        .loading-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: rgba(255, 255, 255, 0.8);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            flex-direction: column;
            display: none;
        }
        
        /* Chatbot */
        .chatbot-toggle {
            position: fixed;
            bottom: 30px;
            right: 30px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 4px 15px rgba(0, 102, 204, 0.3);
            transition: all 0.3s ease;
            z-index: 900;
        }
        
        .chatbot-toggle:hover {
            transform: scale(1.1);
            background-color: var(--primary-light);
        }
        
        .chatbot-toggle i {
            font-size: 1.5rem;
        }
        
        .chatbot-container {
            position: fixed;
            bottom: 100px;
            right: 30px;
            width: 350px;
            height: 450px;
            background-color: white;
            border-radius: 12px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            z-index: 901;
            display: none;
            flex-direction: column;
            overflow: hidden;
        }
        
        .chatbot-header {
            background-color: var(--primary);
            color: white;
            padding: 15px 20px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .chatbot-title {
            font-weight: 500;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        .chatbot-close {
            cursor: pointer;
            font-size: 1.2rem;
        }
        
        .chatbot-messages {
            flex: 1;
            padding: 20px;
            overflow-y: auto;
        }
        
        .message {
            margin-bottom: 15px;
            display: flex;
            flex-direction: column;
        }
        
        .message-user {
            align-items: flex-end;
        }
        
        .message-bot {
            align-items: flex-start;
        }
        
        .message-content {
            padding: 10px 15px;
            border-radius: 18px;
            max-width: 80%;
        }
        
        .message-user .message-content {
            background-color: var(--primary);
            color: white;
            border-bottom-right-radius: 4px;
        }
        
        .message-bot .message-content {
            background-color: var(--gray-light);
            color: var(--dark);
            border-bottom-left-radius: 4px;
        }
        
        .chatbot-input {
            padding: 15px;
            border-top: 1px solid var(--gray-light);
            display: flex;
            align-items: center;
        }
        
        /* Language selector */
        .language-selector {
            margin-left: 1rem;
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            padding: 0.375rem 0.75rem;
            color: white;
            background-color: rgba(255, 255, 255, 0.1);
            transition: all 0.2s;
        }
        
        .language-selector:hover {
            background-color: rgba(255, 255, 255, 0.2);
        }
        
        /* History panel */
        .history-panel {
            position: fixed;
            right: -350px;
            top: 0;
            bottom: 0;
            width: 350px;
            background-color: white;
            box-shadow: -5px 0 15px rgba(0, 0, 0, 0.1);
            z-index: 1000;
            transition: right 0.3s ease;
            padding: 20px;
            overflow-y: auto;
        }
        
        .history-panel.show {
            right: 0;
        }
        
        .history-toggle {
            position: fixed;
            right: 20px;
            top: 80px;
            z-index: 1001;
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--primary);
            color: white;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        }
        
        .history-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 20px;
            padding-bottom: 10px;
            border-bottom: 1px solid var(--gray-light);
        }
        
        .history-item {
            padding: 10px 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            cursor: pointer;
            transition: all 0.2s;
        }
        
        .history-item:hover {
            background-color: var(--gray-light);
        }
        
        .history-meta {
            display: flex;
            justify-content: space-between;
            font-size: 0.85rem;
            color: var(--gray);
            margin-bottom: 5px;
        }
        
        .history-title {
            font-weight: 500;
        }
        
        /* Custom tooltip */
        .custom-tooltip {
            position: relative;
            display: inline-block;
        }
        
        .custom-tooltip .tooltip-text {
            visibility: hidden;
            width: 120px;
            background-color: var(--dark);
            color: white;
            text-align: center;
            border-radius: 6px;
            padding: 5px 0;
            position: absolute;
            z-index: 1;
            bottom: 125%;
            left: 50%;
            margin-left: -60px;
            opacity: 0;
            transition: opacity 0.3s;
        }
        
        .custom-tooltip .tooltip-text::after {
            content: "";
            position: absolute;
            top: 100%;
            left: 50%;
            margin-left: -5px;
            border-width: 5px;
            border-style: solid;
            border-color: var(--dark) transparent transparent transparent;
        }
        
        .custom-tooltip:hover .tooltip-text {
            visibility: visible;
            opacity: 1;
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .chatbot-container {
                width: 90%;
                right: 5%;
                bottom: 80px;
            }
            
            .history-panel {
                width: 100%;
                right: -100%;
            }
        }
    </style>
</head>
<body>
    <!-- Loading Overlay -->
    <div class="loading-overlay" id="loadingOverlay">
        <div class="spinner-border text-primary" role="status"></div>
        <div class="mt-3 text-primary">Analyzing sales data with AI...</div>
    </div>
    
    <!-- Header -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-primary sticky-top shadow-sm">
        <div class="container">
            <a class="navbar-brand" href="#">
                <i class="fas fa-heartbeat fa-lg"></i>
                <div>
                    <h1 class="mb-0 h4">Mais Medical</h1>
                    <div class="dashboard-title" data-i18n="dashboard.title">Sales Analysis Dashboard</div>
                </div>
            </a>
            <div class="d-flex align-items-center">
                <select id="languageSelector" class="language-selector" disabled>
                    <option value="en" selected>English</option>
                    <option value="es">Español</option>
                    <option value="fr">Français</option>
                    <option value="ar">العربية</option>
                </select>
                <button class="btn btn-outline-light ms-2" type="button" id="aboutBtn" data-bs-toggle="modal" data-bs-target="#aboutModal">
                    <i class="fas fa-info-circle"></i>
                </button>
            </div>
        </div>
    </nav>
    
    <!-- Main Content -->
    <main class="py-4">
        <div class="container">
            <!-- Product Selection Card -->
            <div class="card shadow-sm">
                <div class="card-header bg-white">
                    <h2 class="card-title"><i class="fas fa-clipboard-list"></i> <span data-i18n="product.select">Select Product & Data</span></h2>
                </div>
                <div class="card-body">
                    <div class="row g-4">
                        <div class="col-md-6">
                            <div class="mb-3">
                                <label for="productCategory" class="form-label fw-medium" data-i18n="product.category">Product Category*</label>
                                <select class="form-select form-select-lg" id="productCategory" required>
                                    <option value="" selected disabled data-i18n="product.categoryPrompt">Select a product category</option>
                                    <option value="Airway">Airway</option>
                                    <option value="Anesthesia">Anesthesia</option>
                                    <option value="Oxygen Therapy">Oxygen Therapy</option>
                                    <option value="Neonatal">Neonatal</option>
                                    <option value="I.V. Therapy">I.V. Therapy</option>
                                    <option value="Syringes">Syringes</option>
                                    <option value="Kits & Sets">Kits & Sets</option>
                                    <option value="Hemodialysis">Hemodialysis</option>
                                    <option value="Tubes & Catheters">Tubes & Catheters</option>
                                    <option value="Pulse Oximeter">Pulse Oximeter</option>
                                    <option value="General Surgery">General Surgery</option>
                                    <option value="Urology">Urology</option>
                                    <option value="Obstetrics & Gynecology">Obstetrics & Gynecology</option>
                                    <option value="Miscellaneous">Miscellaneous</option>
                                </select>
                            </div>
                            
                            <div class="mb-3" id="subProductGroup" style="display: none;">
                                <label for="subProduct" class="form-label fw-medium" data-i18n="product.subProduct">Enter Sub-product (Optional)</label>
                                <input type="text" class="form-control" id="subProduct" placeholder="E.g., LMA, Endotracheal Tubes">
                            </div>
                            
                            <div class="mb-3">
                                <label class="form-label fw-medium" data-i18n="data.inputMethod">Data Input Method</label>
                                <div class="d-flex gap-4">
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="fileUploadOption" name="dataInput" value="file" checked>
                                        <label class="form-check-label" for="fileUploadOption" data-i18n="data.uploadFile">Upload File</label>
                                    </div>
                                    <div class="form-check">
                                        <input class="form-check-input" type="radio" id="manualDataOption" name="dataInput" value="manual">
                                        <label class="form-check-label" for="manualDataOption" data-i18n="data.enterManually">Enter Manually</label>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="col-md-6">
                            <!-- File Upload Section -->
                            <div id="fileUploadSection">
                                <div class="file-upload" id="dropZone">
                                    <i class="fas fa-cloud-upload-alt"></i>
                                    <div class="file-upload-text" data-i18n="file.dragDrop">Drag & Drop or Click to Upload</div>
                                    <div class="file-upload-info" data-i18n="file.supportedTypes">Supports CSV, Excel, or TXT files</div>
                                    <input type="file" id="fileInput" class="file-input" accept=".csv,.xlsx,.xls,.txt">
                                    <button class="btn btn-outline-secondary" data-i18n="file.chooseFile">Choose File</button>
                                </div>
                                <div id="fileInfo" class="mt-3 text-center" style="display: none;">
                                    <i class="fas fa-file-alt"></i> <span id="fileName">No file selected</span>
                                    <button id="removeFile" class="btn btn-sm btn-outline-danger ms-2">
                                        <i class="fas fa-times"></i>
                                    </button>
                                </div>
                            </div>
                            
                            <!-- Manual Data Entry Section -->
                            <div id="manualDataSection" style="display: none;">
                                <div class="mb-3">
                                    <label for="manualData" class="form-label fw-medium" data-i18n="data.enterData">Enter Sales Data</label>
                                    <textarea class="form-control" id="manualData" rows="6" placeholder="Enter your sales data here. You can use CSV format or any structured data format."></textarea>
                                </div>
                            </div>
                        </div>
                    </div>
                    
                    <div id="errorMessage" class="alert alert-danger mt-3" style="display: none;"></div>
                    
                    <div class="mt-4 text-center">
                        <button id="analyzeBtn" class="btn btn-primary btn-lg px-4 py-2">
                            <i class="fas fa-brain me-2"></i> <span data-i18n="analyze.button">Analyze Sales Data</span>
                        </button>
                    </div>
                </div>
            </div>
            
            <!-- Results Section (initially hidden) -->
            <div id="resultsContainer" class="mt-4" style="display: none;">
                <div class="card shadow-sm">
                    <div class="card-header bg-white">
                        <h2 class="card-title"><i class="fas fa-chart-line"></i> <span data-i18n="results.title">Analysis Results</span></h2>
                        <button id="newAnalysisBtn" class="btn btn-outline-secondary">
                            <i class="fas fa-redo me-2"></i> <span data-i18n="results.newAnalysis">New Analysis</span>
                        </button>
                    </div>
                    <div class="card-body">
                        <div id="analysisHeader" class="mb-4 text-center"></div>
                        
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="fas fa-chart-bar text-primary me-2"></i> <span data-i18n="results.performanceTitle">Performance Summary</span>
                                        </h5>
                                        <div id="performanceSummary"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="fas fa-chart-line text-primary me-2"></i> <span data-i18n="results.trendsTitle">Sales Trends</span>
                                        </h5>
                                        <div class="chart-container">
                                            <canvas id="salesTrendChart"></canvas>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="fas fa-exclamation-triangle text-primary me-2"></i> <span data-i18n="results.dropTitle">Drop Detection & Reasons</span>
                                        </h5>
                                        <div id="dropAnalysis"></div>
                                    </div>
                                </div>
                            </div>
                            
                            <div class="col-md-6">
                                <div class="card h-100 shadow-sm">
                                    <div class="card-body">
                                        <h5 class="card-title mb-3">
                                            <i class="fas fa-lightbulb text-primary me-2"></i> <span data-i18n="results.recommendationsTitle">Optimization Recommendations</span>
                                        </h5>
                                        <div id="recommendations"></div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <div class="mt-4 text-center">
                            <button id="saveResultsBtn" class="btn btn-outline-primary me-2">
                                <i class="fas fa-save me-2"></i> <span data-i18n="results.saveButton">Save Analysis</span>
                            </button>
                            <button id="exportPdfBtn" class="btn btn-outline-secondary">
                                <i class="fas fa-file-pdf me-2"></i> <span data-i18n="results.exportButton">Export as PDF</span>
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </main>
    
    <!-- History Panel -->
    <div class="history-toggle" id="historyToggle">
        <i class="fas fa-history"></i>
    </div>
    
    <div class="history-panel" id="historyPanel">
        <div class="history-header">
            <h5 class="mb-0" data-i18n="history.title">Previous Analyses</h5>
            <button class="btn-close" id="historyClose"></button>
        </div>
        <div id="historyList" class="mb-3">
            <!-- History items will be added here -->
        </div>
        <div class="d-grid gap-2">
            <button id="clearHistoryBtn" class="btn btn-outline-danger">
                <i class="fas fa-trash-alt me-2"></i> <span data-i18n="history.clearButton">Clear History</span>
            </button>
        </div>
    </div>
    
    <!-- Chatbot -->
    <div class="chatbot-toggle" id="chatbotToggle">
        <i class="fas fa-robot"></i>
    </div>
    
    <div class="chatbot-container" id="chatbotContainer">
        <div class="chatbot-header">
            <div class="chatbot-title">
                <i class="fas fa-robot"></i> <span data-i18n="chatbot.title">Support Assistant</span>
            </div>
            <div class="chatbot-close" id="chatbotClose">
                <i class="fas fa-times"></i>
            </div>
        </div>
        <div class="chatbot-messages" id="chatMessages">
            <div class="message message-bot">
                <div class="message-content" data-i18n="chatbot.welcome">
                    Hello! I'm your Mais Medical dashboard assistant. How can I help you with your sales analysis today?
                </div>
            </div>
        </div>
        <div class="chatbot-input">
            <input type="text" id="chatInput" class="form-control" placeholder="Type your message..." data-i18n-placeholder="chatbot.inputPlaceholder">
            <div class="btn btn-primary ms-2" id="sendMessage">
                <i class="fas fa-paper-plane"></i>
            </div>
        </div>
    </div>
    
    <!-- About Modal -->
    <div class="modal fade" id="aboutModal" tabindex="-1" aria-labelledby="aboutModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="aboutModalLabel" data-i18n="about.title">About Mais Medical Dashboard</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p data-i18n="about.description">
                        The Mais Medical Sales Analysis Dashboard uses advanced AI to analyze your medical product sales data.
                        It provides insights, detects trends, and offers optimization recommendations to improve your sales performance.
                    </p>
                    <p data-i18n="about.aiInfo">
                        This dashboard is powered by GROQ AI using the deepseek-r1-distill-llama-70b model for data analysis.
                    </p>
                    <p class="mb-0" data-i18n="about.version">
                        Version: 1.0.0
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" data-i18n="about.closeButton">Close</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Bootstrap Bundle with Popper -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.2.3/dist/js/bootstrap.bundle.min.js"></script>
    
    <!-- Main App Script - Modular Architecture -->
    <script>
        // Main Application Module
        const App = (function() {
            // Initialize all sub-modules
            function init() {
                // Initialize UI module
                UI.init();
                
                // Initialize file handling
                FileHandler.init();
                
                // Initialize data processor
                DataProcessor.init();
                
                // Initialize AI Service
                AIService.init();
                
                // Initialize the Chatbot
                Chatbot.init();
                
                // Initialize history panel
                HistoryManager.init();
                
                // Initialize event listeners
                EventHandlers.init();
                
                // Initialize localization support
                Localization.init();
            }
            
            return {
                init: init
            };
        })();
        
        // User Interface Module
        const UI = (function() {
            // Cache DOM elements
            const elements = {};
            
            function init() {
                // Cache common DOM elements
                elements.productCategory = document.getElementById('productCategory');
                elements.subProductGroup = document.getElementById('subProductGroup');
                elements.subProduct = document.getElementById('subProduct');
                elements.fileUploadOption = document.getElementById('fileUploadOption');
                elements.manualDataOption = document.getElementById('manualDataOption');
                elements.fileUploadSection = document.getElementById('fileUploadSection');
                elements.manualDataSection = document.getElementById('manualDataSection');
                elements.fileInfo = document.getElementById('fileInfo');
                elements.fileName = document.getElementById('fileName');
                elements.manualData = document.getElementById('manualData');
                elements.analyzeBtn = document.getElementById('analyzeBtn');
                elements.errorMessage = document.getElementById('errorMessage');
                elements.loadingOverlay = document.getElementById('loadingOverlay');
                elements.resultsContainer = document.getElementById('resultsContainer');
                elements.newAnalysisBtn = document.getElementById('newAnalysisBtn');
                elements.analysisHeader = document.getElementById('analysisHeader');
                elements.performanceSummary = document.getElementById('performanceSummary');
                elements.dropAnalysis = document.getElementById('dropAnalysis');
                elements.recommendations = document.getElementById('recommendations');
                elements.saveResultsBtn = document.getElementById('saveResultsBtn');
                elements.exportPdfBtn = document.getElementById('exportPdfBtn');
                
                // Initialize UI state
                elements.productCategory.addEventListener('change', showSubProductField);
                elements.fileUploadOption.addEventListener('change', toggleDataInputMethod);
                elements.manualDataOption.addEventListener('change', toggleDataInputMethod);
                
                // Initialize tooltips
                initTooltips();
                
                // Initialize modals
                initModals();
            }
            
            function initTooltips() {
                // Initialize Bootstrap tooltips if available
                if (typeof bootstrap !== 'undefined' && bootstrap.Tooltip) {
                    const tooltipTriggerList = [].slice.call(document.querySelectorAll('[data-bs-toggle="tooltip"]'));
                    tooltipTriggerList.map(function (tooltipTriggerEl) {
                        return new bootstrap.Tooltip(tooltipTriggerEl);
                    });
                }
            }
            
            function initModals() {
                // Initialize Bootstrap modals if needed
            }
            
            function showSubProductField() {
                if (elements.productCategory.value) {
                    elements.subProductGroup.style.display = 'block';
                } else {
                    elements.subProductGroup.style.display = 'none';
                }
            }
            
            function toggleDataInputMethod() {
                if (elements.fileUploadOption.checked) {
                    elements.fileUploadSection.style.display = 'block';
                    elements.manualDataSection.style.display = 'none';
                } else if (elements.manualDataOption.checked) {
                    elements.fileUploadSection.style.display = 'none';
                    elements.manualDataSection.style.display = 'block';
                }
            }
            
            function showLoading() {
                elements.loadingOverlay.style.display = 'flex';
            }
            
            function hideLoading() {
                elements.loadingOverlay.style.display = 'none';
            }
            
            function showError(message) {
                elements.errorMessage.textContent = message;
                elements.errorMessage.style.display = 'block';
            }
            
            function hideError() {
                elements.errorMessage.style.display = 'none';
            }
            
            function showResults() {
                elements.resultsContainer.style.display = 'block';
                elements.resultsContainer.scrollIntoView({ behavior: 'smooth' });
            }
            
            function updateAnalysisHeader(category, subProduct) {
                const headerText = `<h3 class="fw-bold text-primary">Analysis for: ${category}${subProduct ? ` - ${subProduct}` : ''}</h3>
                                    <p class="text-muted mb-0">Generated on ${new Date().toLocaleString()}</p>`;
                elements.analysisHeader.innerHTML = headerText;
            }
            
            function updatePerformanceSummary(content) {
                elements.performanceSummary.innerHTML = content || '<p class="text-muted">No performance summary available</p>';
            }
            
            function updateDropAnalysis(content) {
                elements.dropAnalysis.innerHTML = content || '<p class="text-muted">No drop analysis available</p>';
            }
            
            function updateRecommendations(content) {
                elements.recommendations.innerHTML = content || '<p class="text-muted">No recommendations available</p>';
            }
            
            function resetForm() {
                elements.productCategory.value = '';
                elements.subProduct.value = '';
                elements.subProductGroup.style.display = 'none';
                elements.manualData.value = '';
                FileHandler.resetFile();
                hideError();
                
                // Switch back to file upload option
                elements.fileUploadOption.checked = true;
                elements.fileUploadSection.style.display = 'block';
                elements.manualDataSection.style.display = 'none';
                
                // Hide results
                elements.resultsContainer.style.display = 'none';
                
                // Scroll to top
                window.scrollTo({ top: 0, behavior: 'smooth' });
            }
            
            // Return public methods
            return {
                init: init,
                elements: elements,
                showLoading: showLoading,
                hideLoading: hideLoading,
                showError: showError,
                hideError: hideError,
                showResults: showResults,
                updateAnalysisHeader: updateAnalysisHeader,
                updatePerformanceSummary: updatePerformanceSummary,
                updateDropAnalysis: updateDropAnalysis,
                updateRecommendations: updateRecommendations,
                resetForm: resetForm
            };
        })();
        
        // File Handler Module
        const FileHandler = (function() {
            // File handling state
            let currentFile = null;
            
            function init() {
                const dropZone = document.getElementById('dropZone');
                const fileInput = document.getElementById('fileInput');
                const removeFile = document.getElementById('removeFile');
                
                // Setup file input and drag/drop
                dropZone.addEventListener('click', () => fileInput.click());
                fileInput.addEventListener('change', handleFileSelection);
                
                // Drag and drop functionality
                dropZone.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.classList.add('border-primary');
                    dropZone.classList.add('bg-light');
                });
                
                dropZone.addEventListener('dragleave', () => {
                    dropZone.classList.remove('border-primary');
                    dropZone.classList.remove('bg-light');
                });
                
                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.classList.remove('border-primary');
                    dropZone.classList.remove('bg-light');
                    
                    if (e.dataTransfer.files.length) {
                        handleFileSelection({ target: { files: e.dataTransfer.files } });
                    }
                });
                
                // Remove file button
                removeFile.addEventListener('click', resetFile);
            }
            
            function handleFileSelection(event) {
                const files = event.target.files;
                
                if (files.length > 0) {
                    const file = files[0];
                    
                    // Validate file type for security
                    if (!isValidFileType(file)) {
                        UI.showError('Please upload a valid CSV, Excel, or TXT file.');
                        return;
                    }
                    
                    // Update UI with file info
                    currentFile = file;
                    UI.elements.fileName.textContent = file.name;
                    UI.elements.fileInfo.style.display = 'block';
                    document.getElementById('dropZone').style.display = 'none';
                    UI.hideError();
                }
            }
            
            function isValidFileType(file) {
                const validTypes = [
                    'text/csv', 
                    'application/vnd.ms-excel',
                    'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                    'text/plain'
                ];
                
                // Check by MIME type
                if (validTypes.includes(file.type)) {
                    return true;
                }
                
                // Also check by extension
                const fileName = file.name.toLowerCase();
                return fileName.endsWith('.csv') || 
                       fileName.endsWith('.xlsx') || 
                       fileName.endsWith('.xls') || 
                       fileName.endsWith('.txt');
            }
            
            function readFile() {
                return new Promise((resolve, reject) => {
                    if (!currentFile) {
                        reject(new Error('No file selected'));
                        return;
                    }
                    
                    const reader = new FileReader();
                    
                    reader.onload = function(e) {
                        resolve(e.target.result);
                    };
                    
                    reader.onerror = function() {
                        reject(new Error('Error reading file'));
                    };
                    
                    reader.readAsText(currentFile);
                });
            }
            
            function resetFile() {
                document.getElementById('fileInput').value = '';
                currentFile = null;
                UI.elements.fileInfo.style.display = 'none';
                document.getElementById('dropZone').style.display = 'flex';
            }
            
            // Return public methods
            return {
                init: init,
                readFile: readFile,
                resetFile: resetFile,
                getCurrentFile: () => currentFile
            };
        })();
        
        // Data Processor Module
        const DataProcessor = (function() {
            function init() {
                // Initialize any data processing configuration
            }
            
            function getInputData() {
                return new Promise(async (resolve, reject) => {
                    try {
                        // Determine data source
                        if (UI.elements.fileUploadOption.checked) {
                            // Get data from file
                            const fileData = await FileHandler.readFile();
                            resolve(sanitizeInput(fileData));
                        } else {
                            // Get data from manual input
                            const manualData = UI.elements.manualData.value.trim();
                            resolve(sanitizeInput(manualData));
                        }
                    } catch (error) {
                        reject(error);
                    }
                });
            }
            
            function sanitizeInput(input) {
                // Basic sanitization to prevent XSS
                const sanitized = input
                    .replace(/</g, '&lt;')
                    .replace(/>/g, '&gt;')
                    .replace(/&/g, '&amp;')
                    .replace(/"/g, '&quot;')
                    .replace(/'/g, '&#x27;')
                    .replace(/\//g, '&#x2F;');
                
                return sanitized;
            }
            
            function extractChartData(text) {
                // Default chart data in case we can't extract meaningful data
                const defaultData = {
                    labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                    datasets: [
                        {
                            label: 'Sales',
                            data: [65, 78, 80, 74, 82, 85],
                            borderColor: 'rgb(0, 102, 204)',
                            backgroundColor: 'rgba(0, 102, 204, 0.1)',
                            tension: 0.3,
                            fill: true
                        }
                    ]
                };
                
                try {
                    // Try to extract numbers to use for the chart
                    const numbers = text.match(/\b\d+(\.\d+)?\b/g);
                    if (numbers && numbers.length >= 6) {
                        const chartNumbers = numbers.slice(0, 6).map(n => parseFloat(n));
                        defaultData.datasets[0].data = chartNumbers;
                    }
                    
                    // Try to extract months or time periods
                    const monthPattern = /\b(jan|feb|mar|apr|may|jun|jul|aug|sep|oct|nov|dec|january|february|march|april|may|june|july|august|september|october|november|december|q1|q2|q3|q4)\b/gi;
                    const months = text.match(monthPattern);
                    
                    if (months && months.length >= 6) {
                        defaultData.labels = months.slice(0, 6).map(m => m.charAt(0).toUpperCase() + m.slice(1).toLowerCase());
                    }
                } catch (e) {
                    console.error('Error extracting chart data:', e);
                }
                
                return defaultData;
            }
            
            function extractSections(text) {
                const sections = {
                    performance: '',
                    trends: '',
                    drop: '',
                    recommendations: '',
                    chartData: null
                };
                
                try {
                    // Extract performance summary
                    const performanceMatch = text.match(/performance summary:?.*?(?:sales trends|$)/is);
                    if (performanceMatch) {
                        sections.performance = formatSection(performanceMatch[0].replace(/performance summary:?/i, '').replace(/sales trends.*/is, ''));
                    }
                    
                    // Extract sales trends
                    const trendsMatch = text.match(/sales trends:?.*?(?:drop detection|$)/is);
                    if (trendsMatch) {
                        sections.trends = formatSection(trendsMatch[0].replace(/sales trends:?/i, '').replace(/drop detection.*/is, ''));
                        sections.chartData = extractChartData(trendsMatch[0]);
                    }
                    
                    // Extract drop detection
                    const dropMatch = text.match(/drop detection.*?(?:optimization recommendations|$)/is);
                    if (dropMatch) {
                        sections.drop = formatSection(dropMatch[0].replace(/drop detection.*?:/i, '').replace(/optimization recommendations.*/is, ''));
                    }
                    
                    // Extract recommendations
                    const recommendationsMatch = text.match(/optimization recommendations:?.*$/is);
                    if (recommendationsMatch) {
                        sections.recommendations = formatSection(recommendationsMatch[0].replace(/optimization recommendations:?/i, ''));
                    }
                    
                    // If no structured data found, use whole text with some formatting
                    if (!sections.performance && !sections.trends && !sections.drop && !sections.recommendations) {
                        const parts = text.split('\n\n');
                        if (parts.length >= 4) {
                            sections.performance = formatSection(parts[0]);
                            sections.trends = formatSection(parts[1]);
                            sections.drop = formatSection(parts[2]);
                            sections.recommendations = formatSection(parts[3]);
                        } else {
                            sections.performance = formatSection(text);
                        }
                    }
                } catch (e) {
                    console.error('Error extracting sections:', e);
                    sections.performance = formatSection(text);
                }
                
                return sections;
            }
            
            function formatSection(text) {
                // Convert bullet points to HTML list items
                let formatted = text.trim();
                
                try {
                    // Check if the text contains bullet points
                    if (formatted.includes('•') || formatted.includes('- ') || formatted.includes('* ')) {
                        const lines = formatted.split('\n');
                        let listItems = '';
                        
                        lines.forEach(line => {
                            line = line.trim();
                            if (line.startsWith('•') || line.startsWith('- ') || line.startsWith('* ')) {
                                listItems += `<li>${line.substring(1).trim()}</li>`;
                            } else if (line) {
                                listItems += `<p>${line}</p>`;
                            }
                        });
                        
                        if (listItems) {
                            formatted = `<ul class="summary-list">${listItems}</ul>`;
                        }
                    } else {
                        // Split by paragraphs
                        formatted = formatted.split('\n').filter(line => line.trim()).map(p => `<p>${p}</p>`).join('');
                    }
                    
                    // Highlight key metrics with colors
                    formatted = formatted.replace(/(\d+%\s*increase)/gi, '<span class="text-success">$1</span>');
                    formatted = formatted.replace(/(\d+%\s*decrease)/gi, '<span class="text-danger">$1</span>');
                    formatted = formatted.replace(/(\d+%\s*growth)/gi, '<span class="text-success">$1</span>');
                    formatted = formatted.replace(/(\d+%\s*decline)/gi, '<span class="text-danger">$1</span>');
                } catch (e) {
                    console.error('Error formatting section:', e);
                    // Return the original text if there was an error
                    return text;
                }
                
                return formatted;
            }
            
            // Return public methods
            return {
                init: init,
                getInputData: getInputData,
                extractSections: extractSections,
                extractChartData: extractChartData
            };
        })();
        
        // AI Service Module
        const AIService = (function() {
            // GROQ API Configuration
            const GROQ_API_KEY = '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';
            const GROQ_ENDPOINT = 'https://api.groq.com/openai/v1/chat/completions';
            const GROQ_MODEL = 'deepseek-r1-distill-llama-70b';
            
            function init() {
                // Initialize AI configuration
            }
            
            function analyzeData(category, subProduct, data) {
                // Prepare the prompt for GROQ
                const systemPrompt = buildSystemPrompt(category, subProduct);
                const userPrompt = buildUserPrompt(category, subProduct, data);
                
                return callGroqAPI(systemPrompt, userPrompt);
            }
            
            function buildSystemPrompt(category, subProduct) {
                return `You are a specialized medical sales analyst. Analyze the sales data provided for the selected product ${category}${subProduct ? ' and sub-product ' + subProduct : ''}. Identify trends, detect any decline in performance, suggest improvements, and point out root causes. Provide a detailed yet concise summary using bullet points. If input is unclear, ask for clarification. Use knowledge of medical product cycles and B2B hospital procurement behavior to guide your insights.`;
            }
            
            function buildUserPrompt(category, subProduct, data) {
                return `I need an analysis of sales data for ${category}${subProduct ? ' (specifically for ' + subProduct + ')' : ''}. Here's the data:\n\n${data}\n\nPlease provide: 1) A performance summary, 2) Sales trends analysis, 3) Drop detection with possible reasons, and 4) Optimization recommendations. Also include data points that could be visualized in a trend chart.`;
            }
            
            function callGroqAPI(systemPrompt, userPrompt) {
                return new Promise(async (resolve, reject) => {
                    try {
                        const payload = {
                            model: GROQ_MODEL,
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: userPrompt }
                            ],
                            temperature: 0.3,
                            max_tokens: 2048
                        };
                        
                        const response = await fetch(GROQ_ENDPOINT, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${GROQ_API_KEY}`
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) {
                            const errorText = await response.text();
                            throw new Error(`GROQ API Error (${response.status}): ${errorText}`);
                        }
                        
                        const data = await response.json();
                        resolve(data.choices[0].message.content);
                    } catch (error) {
                        reject(error);
                    }
                });
            }
            
            // Chat with AI for chatbot
            function chatWithAI(userMessage) {
                return new Promise(async (resolve, reject) => {
                    try {
                        const systemPrompt = `You are a helpful assistant for the Mais Medical Sales Analysis Dashboard. You can help with questions about using the dashboard, medical product sales analysis, and data interpretation. Keep responses concise and relevant to the medical sales domain.`;
                        
                        const payload = {
                            model: GROQ_MODEL,
                            messages: [
                                { role: 'system', content: systemPrompt },
                                { role: 'user', content: userMessage }
                            ],
                            temperature: 0.7,
                            max_tokens: 300
                        };
                        
                        const response = await fetch(GROQ_ENDPOINT, {
                            method: 'POST',
                            headers: {
                                'Content-Type': 'application/json',
                                'Authorization': `Bearer ${GROQ_API_KEY}`
                            },
                            body: JSON.stringify(payload)
                        });
                        
                        if (!response.ok) {
                            resolve("I'm having trouble connecting to my knowledge base right now. Please try again later or ask another question.");
                            return;
                        }
                        
                        const data = await response.json();
                        resolve(data.choices[0].message.content);
                    } catch (error) {
                        resolve("I encountered an error. Please try again with a different question.");
                    }
                });
            }
            
            // Return public methods
            return {
                init: init,
                analyzeData: analyzeData,
                chatWithAI: chatWithAI
            };
        })();
        
        // Chart Visualization Module
        const ChartVisualizer = (function() {
            let salesChart = null;
            
            function init() {
                // Initialize chart libraries or configurations
            }
            
            function createSalesChart(chartData) {
                const canvas = document.getElementById('salesTrendChart');
                
                // If a chart already exists, destroy it
                if (salesChart) {
                    salesChart.destroy();
                }
                
                // Create new chart
                salesChart = new Chart(canvas, {
                    type: 'line',
                    data: chartData,
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            legend: {
                                position: 'top',
                            },
                            tooltip: {
                                mode: 'index',
                                intersect: false,
                            }
                        },
                        scales: {
                            y: {
                                beginAtZero: false,
                                ticks: {
                                    callback: function(value) {
                                        return value;
                                    }
                                }
                            }
                        },
                        interaction: {
                            mode: 'nearest',
                            axis: 'x',
                            intersect: false
                        }
                    }
                });
                
                return salesChart;
            }
            
            // Return public methods
            return {
                init: init,
                createSalesChart: createSalesChart
            };
        })();
        
        // Chatbot Module
        const Chatbot = (function() {
            const chatbotToggle = document.getElementById('chatbotToggle');
            const chatbotContainer = document.getElementById('chatbotContainer');
            const chatbotClose = document.getElementById('chatbotClose');
            const chatMessages = document.getElementById('chatMessages');
            const chatInput = document.getElementById('chatInput');
            const sendMessage = document.getElementById('sendMessage');
            
            function init() {
                // Chatbot Toggle
                chatbotToggle.addEventListener('click', () => {
                    chatbotContainer.style.display = 'flex';
                    chatbotToggle.style.display = 'none';
                });
                
                chatbotClose.addEventListener('click', () => {
                    chatbotContainer.style.display = 'none';
                    chatbotToggle.style.display = 'flex';
                });
                
                // Send Message
                sendMessage.addEventListener('click', sendChatMessage);
                
                chatInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        sendChatMessage();
                    }
                });
            }
            
            async function sendChatMessage() {
                const message = chatInput.value.trim();
                if (!message) return;
                
                // Add user message to chat
                addMessageToChat('user', message);
                chatInput.value = '';
                
                // Show typing indicator
                const typingIndicator = addTypingIndicator();
                
                try {
                    // Get response from AI
                    const response = await AIService.chatWithAI(message);
                    
                    // Remove typing indicator
                    typingIndicator.remove();
                    
                    // Add bot response
                    addMessageToChat('bot', response);
                } catch (error) {
                    // Remove typing indicator
                    typingIndicator.remove();
                    
                    // Add error message
                    addMessageToChat('bot', "I'm sorry, I couldn't process your request at the moment. Please try again later.");
                }
            }
            
            function addMessageToChat(sender, content) {
                const messageDiv = document.createElement('div');
                messageDiv.className = `message message-${sender}`;
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.textContent = content;
                
                messageDiv.appendChild(contentDiv);
                chatMessages.appendChild(messageDiv);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                return messageDiv;
            }
            
            function addTypingIndicator() {
                const typingDiv = document.createElement('div');
                typingDiv.className = 'message message-bot typing-indicator';
                
                const contentDiv = document.createElement('div');
                contentDiv.className = 'message-content';
                contentDiv.innerHTML = '<span class="typing-dot"></span><span class="typing-dot"></span><span class="typing-dot"></span>';
                
                typingDiv.appendChild(contentDiv);
                chatMessages.appendChild(typingDiv);
                
                // Scroll to bottom
                chatMessages.scrollTop = chatMessages.scrollHeight;
                
                return typingDiv;
            }
            
            // Return public methods
            return {
                init: init
            };
        })();
        
        // History Manager Module
        const HistoryManager = (function() {
            const historyToggle = document.getElementById('historyToggle');
            const historyPanel = document.getElementById('historyPanel');
            const historyClose = document.getElementById('historyClose');
            const historyList = document.getElementById('historyList');
            const clearHistoryBtn = document.getElementById('clearHistoryBtn');
            
            // Maximum number of history items to store
            const MAX_HISTORY_ITEMS = 10;
            
            function init() {
                // Toggle history panel
                historyToggle.addEventListener('click', () => {
                    historyPanel.classList.add('show');
                });
                
                historyClose.addEventListener('click', () => {
                    historyPanel.classList.remove('show');
                });
                
                // Clear history button
                clearHistoryBtn.addEventListener('click', clearHistory);
                
                // Load history from localStorage
                loadHistory();
            }
            
            function saveAnalysis(category, subProduct, analysisData) {
                try {
                    // Get existing history
                    let history = getHistory();
                    
                    // Create new history item
                    const historyItem = {
                        id: Date.now(),
                        timestamp: new Date().toISOString(),
                        category: category,
                        subProduct: subProduct || '',
                        analysisData: analysisData
                    };
                    
                    // Add to beginning of array
                    history.unshift(historyItem);
                    
                    // Limit the number of items
                    if (history.length > MAX_HISTORY_ITEMS) {
                        history = history.slice(0, MAX_HISTORY_ITEMS);
                    }
                    
                    // Save to localStorage
                    localStorage.setItem('maisAnalysisHistory', JSON.stringify(history));
                    
                    // Refresh the history list
                    loadHistory();
                    
                    return true;
                } catch (error) {
                    console.error('Error saving analysis to history:', error);
                    return false;
                }
            }
            
            function getHistory() {
                try {
                    const historyJson = localStorage.getItem('maisAnalysisHistory');
                    return historyJson ? JSON.parse(historyJson) : [];
                } catch (error) {
                    console.error('Error getting history from localStorage:', error);
                    return [];
                }
            }
            
            function loadHistory() {
                try {
                    const history = getHistory();
                    
                    // Clear existing history list
                    historyList.innerHTML = '';
                    
                    if (history.length === 0) {
                        historyList.innerHTML = '<div class="text-center text-muted py-4">No previous analyses found</div>';
                        return;
                    }
                    
                    // Add each history item to the list
                    history.forEach(item => {
                        const historyItemEl = createHistoryItemElement(item);
                        historyList.appendChild(historyItemEl);
                    });
                } catch (error) {
                    console.error('Error loading history:', error);
                }
            }
            
            function createHistoryItemElement(item) {
                const historyItemEl = document.createElement('div');
                historyItemEl.className = 'history-item';
                historyItemEl.dataset.id = item.id;
                
                const date = new Date(item.timestamp);
                const formattedDate = date.toLocaleDateString();
                const formattedTime = date.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                
                historyItemEl.innerHTML = `
                    <div class="history-meta">
                        <span>${formattedDate} ${formattedTime}</span>
                        <button class="btn btn-sm text-danger p-0 delete-history" title="Delete">
                            <i class="fas fa-times"></i>
                        </button>
                    </div>
                    <div class="history-title">${item.category}${item.subProduct ? ` - ${item.subProduct}` : ''}</div>
                `;
                
                // Add click handler to load this analysis
                historyItemEl.addEventListener('click', (e) => {
                    if (!e.target.closest('.delete-history')) {
                        loadAnalysisFromHistory(item);
                    }
                });
                
                // Add delete button handler
                const deleteBtn = historyItemEl.querySelector('.delete-history');
                if (deleteBtn) {
                    deleteBtn.addEventListener('click', (e) => {
                        e.stopPropagation();
                        deleteHistoryItem(item.id);
                    });
                }
                
                return historyItemEl;
            }
            
            function loadAnalysisFromHistory(historyItem) {
                try {
                    // Close the history panel
                    historyPanel.classList.remove('show');
                    
                    // Update UI with the analysis results
                    UI.updateAnalysisHeader(historyItem.category, historyItem.subProduct);
                    
                    const sections = DataProcessor.extractSections(historyItem.analysisData);
                    
                    UI.updatePerformanceSummary(sections.performance);
                    UI.updateDropAnalysis(sections.drop);
                    UI.updateRecommendations(sections.recommendations);
                    
                    // Create chart
                    ChartVisualizer.createSalesChart(sections.chartData || DataProcessor.extractChartData(historyItem.analysisData));
                    
                    // Show results container
                    UI.showResults();
                } catch (error) {
                    console.error('Error loading analysis from history:', error);
                    UI.showError('Failed to load previous analysis. Please try again.');
                }
            }
            
            function deleteHistoryItem(id) {
                try {
                    let history = getHistory();
                    
                    // Filter out the item to delete
                    history = history.filter(item => item.id !== id);
                    
                    // Save updated history
                    localStorage.setItem('maisAnalysisHistory', JSON.stringify(history));
                    
                    // Reload history list
                    loadHistory();
                } catch (error) {
                    console.error('Error deleting history item:', error);
                }
            }
            
            function clearHistory() {
                try {
                    localStorage.removeItem('maisAnalysisHistory');
                    loadHistory();
                } catch (error) {
                    console.error('Error clearing history:', error);
                }
            }
            
            // Return public methods
            return {
                init: init,
                saveAnalysis: saveAnalysis,
                getHistory: getHistory
            };
        })();
        
        // Event Handlers Module
        const EventHandlers = (function() {
            function init() {
                // Analyze Button
                UI.elements.analyzeBtn.addEventListener('click', handleAnalysis);
                
                // New Analysis Button
                UI.elements.newAnalysisBtn.addEventListener('click', () => {
                    UI.resetForm();
                });
                
                // Save Results Button
                UI.elements.saveResultsBtn.addEventListener('click', saveResults);
                
                // Export PDF Button
                UI.elements.exportPdfBtn.addEventListener('click', exportPdf);
            }
            
            async function handleAnalysis() {
                // Validate form
                if (!UI.elements.productCategory.value) {
                    UI.showError('Please select a product category.');
                    return;
                }
                
                let dataToAnalyze = '';
                
                try {
                    // Get data based on selected input method
                    dataToAnalyze = await DataProcessor.getInputData();
                    
                    if (!dataToAnalyze) {
                        if (UI.elements.fileUploadOption.checked) {
                            UI.showError('Please upload a file or switch to manual data entry.');
                        } else {
                            UI.showError('Please enter sales data or switch to file upload.');
                        }
                        return;
                    }
                    
                    // Show loading overlay
                    UI.showLoading();
                    
                    // Get input values
                    const category = UI.elements.productCategory.value;
                    const subProductValue = UI.elements.subProduct.value.trim();
                    
                    // Call AI service to analyze data
                    const response = await AIService.analyzeData(category, subProductValue, dataToAnalyze);
                    
                    // Process and display results
                    processAnalysisResults(response, category, subProductValue);
                } catch (error) {
                    UI.hideLoading();
                    UI.showError('Analysis failed: ' + error.message);
                }
            }
            
            function processAnalysisResults(response, category, subProduct) {
                UI.hideLoading();
                
                // Extract sections from the response
                const sections = DataProcessor.extractSections(response);
                
                // Update UI with results
                UI.updateAnalysisHeader(category, subProduct);
                UI.updatePerformanceSummary(sections.performance);
                UI.updateDropAnalysis(sections.drop);
                UI.updateRecommendations(sections.recommendations);
                
                // Generate and display chart
                ChartVisualizer.createSalesChart(sections.chartData || DataProcessor.extractChartData(response));
                
                // Show results container
                UI.showResults();
                
                // Save analysis data for current session
                window.currentAnalysis = {
                    category,
                    subProduct,
                    response
                };
            }
            
            function saveResults() {
                // Save current analysis to history
                if (window.currentAnalysis) {
                    const saved = HistoryManager.saveAnalysis(
                        window.currentAnalysis.category,
                        window.currentAnalysis.subProduct,
                        window.currentAnalysis.response
                    );
                    
                    if (saved) {
                        // Show success message
                        alert('Analysis saved successfully!');
                    } else {
                        // Show error message
                        alert('Failed to save analysis. Please try again.');
                    }
                }
            }
            
            function exportPdf() {
                // Alert user that this feature is coming soon
                alert('Export to PDF feature coming soon!');
            }
            
            // Return public methods
            return {
                init: init
            };
        })();
        
        // Localization Module
        const Localization = (function() {
            // Currently supported languages
            const languages = {
                'en': 'English',
                'es': 'Español',
                'fr': 'Français',
                'ar': 'العربية'
            };
            
            // Default language
            let currentLanguage = 'en';
            
            // Translations (empty for now, would be populated in a real app)
            const translations = {
                'en': {},
                'es': {},
                'fr': {},
                'ar': {}
            };
            
            function init() {
                const languageSelector = document.getElementById('languageSelector');
                
                // Event listener for language selector (disabled for now)
                languageSelector.addEventListener('change', function() {
                    alert('Language changing functionality will be available in a future update.');
                    this.value = 'en'; // Reset to English
                });
                
                // Apply initial translations (would be implemented in a real app)
                // For now, all text is in English as specified in requirements
            }
            
            function setLanguage(langCode) {
                if (translations[langCode]) {
                    currentLanguage = langCode;
                    applyTranslations();
                }
            }
            
            function applyTranslations() {
                // This would apply translations to all elements with data-i18n attributes
                // Not implemented for now as per requirements (English only)
            }
            
            // Return public methods
            return {
                init: init,
                setLanguage: setLanguage,
                getCurrentLanguage: () => currentLanguage
            };
        })();
        
        // Initialize the application when the DOM is loaded
        document.addEventListener('DOMContentLoaded', function() {
            App.init();
            
            // Initialize the default chart
            const sampleChartData = {
                labels: ['Jan', 'Feb', 'Mar', 'Apr', 'May', 'Jun'],
                datasets: [
                    {
                        label: 'Sample Sales Data',
                        data: [65, 78, 80, 74, 82, 85],
                        borderColor: 'rgb(0, 102, 204)',
                        backgroundColor: 'rgba(0, 102, 204, 0.1)',
                        tension: 0.3,
                        fill: true
                    }
                ]
            };
            
            ChartVisualizer.createSalesChart(sampleChartData);
        });
    </script>
</body>
</html>