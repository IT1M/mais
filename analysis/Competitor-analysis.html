<!DOCTYPE html>
<html lang="en" dir="ltr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAIS Competitor Analysis</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" integrity="sha512-9usAa10IRO0HhonpyAIVpjrylPvoDwiPUiKdWk5t3PyolY1cOd4DSE0Ga+ri4AuTroPR5aQvXU9xC6qOPnzFeg==" crossorigin="anonymous" referrerpolicy="no-referrer" />
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.css">
    <style>
        :root {
            --primary-color: #005b96; /* Deep corporate blue */
            --secondary-color: #6497b1; /* Lighter, supportive blue */
            --accent-color: #e0f2f7;   /* Very light blue, for backgrounds or highlights */
            --accent-color-2: #ffb347; /* Orange accent for highlights and CTAs */
            --text-color: #333333;
            --text-color-light: #f8f9fa;
            --light-bg: #f4f7f9;    /* Main page background */
            --dark-bg: #011f4b;     /* Very dark blue, for footer or contrasting elements */
            --card-bg: #ffffff;
            --border-color: #dee2e6;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --error-color: #dc3545;
            --success-color: #28a745;
            --font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            --border-radius: 12px;
            --transition-speed: 0.3s;
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: var(--font-family);
            background-color: var(--light-bg);
            color: var(--text-color);
            line-height: 1.7;
            padding-top: 70px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header Styles */
        header {
            background: linear-gradient(135deg, var(--primary-color), var(--dark-bg));
            color: var(--text-color-light);
            text-align: center;
            padding: 2.5rem 1rem;
            margin-bottom: 0;
            box-shadow: 0 4px 10px var(--shadow-color);
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            z-index: 1000;
        }

        header h1 {
            margin: 0;
            font-size: 2.2rem;
            font-weight: 700;
            text-shadow: 1px 1px 3px rgba(0,0,0,0.3);
            display: inline-block;
        }

        header h1 i {
            margin-right: 10px;
            color: var(--accent-color-2);
        }

        /* Sticky Analysis Summary Section */
        #analysis-summary {
            background-color: var(--card-bg);
            padding: 25px;
            box-shadow: 0 4px 8px var(--shadow-color);
            margin-top: 0;
            margin-bottom: 2.5rem;
            position: sticky;
            top: 90px;
            z-index: 999;
            border-radius: 0 0 var(--border-radius) var(--border-radius);
            border: 1px solid var(--border-color);
            border-top: none;
            transition: all var(--transition-speed) ease;
        }

        #analysis-summary:hover {
            box-shadow: 0 6px 12px var(--shadow-color);
            transform: translateY(-2px);
        }

        #analysis-summary h2 {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin-bottom: 1rem;
            border-bottom: 2px solid var(--accent-color);
            padding-bottom: 0.5rem;
            display: flex;
            align-items: center;
        }

        #analysis-summary h2 i {
            margin-right: 10px;
            color: var(--accent-color-2);
        }

        #analysis-summary p {
            font-size: 1rem;
            color: var(--secondary-color);
            text-align: left;
            padding: 10px;
            background-color: rgba(224, 242, 247, 0.5);
            border-left: 4px solid var(--secondary-color);
            border-radius: 4px;
        }
        
        /* Main Content Area */
        .main-content-area {
            padding-top: 1rem;
        }

        /* Card styling */
        .card {
            background-color: var(--card-bg);
            border-radius: var(--border-radius);
            padding: 25px;
            box-shadow: 0 3px 6px var(--shadow-color);
            margin-bottom: 2.5rem;
            transition: transform var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
        }

        .card:hover {
            box-shadow: 0 8px 15px var(--shadow-color);
            transform: translateY(-5px);
        }

        .section-title {
            color: var(--primary-color);
            font-size: 1.8rem;
            margin-bottom: 1.5rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid var(--accent-color);
            display: flex;
            align-items: center;
        }

        .section-title i {
            margin-right: 10px;
            color: var(--accent-color-2);
        }

        /* Input Section Styles */
        #input-section {
            position: relative;
            overflow: hidden;
        }

        #input-section::before {
            content: '';
            position: absolute;
            top: 0;
            right: 0;
            width: 150px;
            height: 150px;
            background: radial-gradient(circle, var(--accent-color) 0%, rgba(255,255,255,0) 70%);
            opacity: 0.5;
            z-index: 0;
        }

        #analysis-form {
            position: relative;
            z-index: 1;
        }

        #analysis-form label {
            display: block;
            margin-bottom: 8px;
            font-weight: 600;
            color: var(--text-color);
            font-size: 0.95rem;
            transition: color var(--transition-speed) ease;
        }

        #analysis-form label:hover {
            color: var(--primary-color);
        }

        #analysis-form input[type="text"],
        #analysis-form select {
            width: 100%;
            padding: 12px 15px;
            margin-bottom: 20px;
            border: 1px solid var(--border-color);
            border-radius: 6px;
            box-sizing: border-box;
            font-size: 1rem;
            transition: border-color var(--transition-speed) ease, box-shadow var(--transition-speed) ease;
            background-color: var(--light-bg);
        }

        #analysis-form input[type="text"]:focus,
        #analysis-form select:focus {
            border-color: var(--primary-color);
            box-shadow: 0 0 0 0.2rem rgba(0, 91, 150, 0.25);
            outline: none;
            background-color: white;
        }

        #analysis-form button {
            background-color: var(--primary-color);
            color: white;
            padding: 14px 20px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-size: 1.1rem;
            font-weight: 600;
            transition: background-color var(--transition-speed) ease, transform var(--transition-speed) ease;
            display: block;
            width: 100%;
            position: relative;
            overflow: hidden;
        }

        #analysis-form button::after {
            content: '';
            position: absolute;
            top: 0;
            left: -100%;
            width: 100%;
            height: 100%;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
            transition: left 0.5s ease;
        }

        #analysis-form button:hover {
            background-color: #004a7c;
            transform: translateY(-2px);
        }

        #analysis-form button:hover::after {
            left: 100%;
        }

        #analysis-form button:active {
            transform: translateY(0);
        }

        /* Form grid layout for larger screens */
        .form-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }

        .full-width {
            grid-column: 1 / -1;
        }

        /* Results Section Styles */
        #results-section {
            min-height: 150px;
        }

        #loading-indicator {
            text-align: center;
            margin: 20px auto;
            font-style: italic;
            color: var(--secondary-color);
            display: none;
            font-size: 1.1rem;
            padding: 15px;
            background-color: rgba(224, 242, 247, 0.5);
            border-radius: 6px;
            max-width: 300px;
        }

        .loading-spinner {
            display: inline-block;
            width: 40px;
            height: 40px;
            margin-bottom: 10px;
            border: 4px solid rgba(0, 91, 150, 0.1);
            border-radius: 50%;
            border-top-color: var(--primary-color);
            animation: spin 1s ease-in-out infinite;
        }

        @keyframes spin {
            to { transform: rotate(360deg); }
        }

        /* Dashboard Layout */
        .dashboard {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
            margin-top: 20px;
        }

        .dashboard-full {
            grid-column: 1 / -1;
        }

        .dashboard-card {
            background-color: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.1);
            transition: all var(--transition-speed) ease;
        }

        .dashboard-card:hover {
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            transform: translateY(-3px);
        }

        .dashboard-card h3 {
            color: var(--primary-color);
            font-size: 1.2rem;
            margin-bottom: 15px;
            padding-bottom: 8px;
            border-bottom: 1px solid var(--accent-color);
        }

        /* Chart containers */
        .chart-container {
            position: relative;
            height: 250px;
            margin-top: 15px;
        }

        /* Analysis text formatting */
        .analysis-text {
            font-size: 1rem;
            line-height: 1.6;
            color: var(--text-color);
        }

        .highlight {
            background-color: rgba(255, 179, 71, 0.2);
            padding: 2px 5px;
            border-radius: 3px;
            font-weight: 500;
        }

        /* SWOT Analysis specific styling */
        .swot-grid {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 15px;
            margin-top: 20px;
        }

        .swot-item {
            padding: 15px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }

        .swot-item h4 {
            font-size: 1.1rem;
            margin-bottom: 10px;
            display: flex;
            align-items: center;
        }

        .swot-item h4 i {
            margin-right: 8px;
        }

        .swot-item ul {
            padding-left: 25px;
        }

        .swot-item li {
            margin-bottom: 5px;
        }

        .strengths {
            background-color: rgba(40, 167, 69, 0.1);
            border-left: 4px solid #28a745;
        }
        
        .strengths h4 {
            color: #28a745;
        }

        .weaknesses {
            background-color: rgba(220, 53, 69, 0.1);
            border-left: 4px solid #dc3545;
        }
        
        .weaknesses h4 {
            color: #dc3545;
        }

        .opportunities {
            background-color: rgba(0, 123, 255, 0.1);
            border-left: 4px solid #007bff;
        }
        
        .opportunities h4 {
            color: #007bff;
        }

        .threats {
            background-color: rgba(255, 193, 7, 0.1);
            border-left: 4px solid #ffc107;
        }
        
        .threats h4 {
            color: #ffc107;
        }

        /* Error Styling */
        .error {
            color: var(--error-color);
            font-weight: bold;
            text-align: center;
            padding: 15px;
            background-color: rgba(220, 53, 69, 0.1);
            border: 1px solid var(--error-color);
            border-radius: 6px;
        }

        /* Footer Styles */
        footer {
            text-align: center;
            padding: 25px 20px;
            background-color: var(--dark-bg);
            color: var(--text-color-light);
            font-size: 0.9rem;
            margin-top: 3rem;
            border-top: 3px solid var(--primary-color);
        }

        footer .social-icons {
            margin-top: 15px;
        }

        footer .social-icons a {
            color: var(--text-color-light);
            margin: 0 10px;
            font-size: 1.2rem;
            transition: color var(--transition-speed) ease, transform var(--transition-speed) ease;
            display: inline-block;
        }

        footer .social-icons a:hover {
            color: var(--accent-color-2);
            transform: translateY(-3px);
        }

        /* RTL Support */
        [dir="rtl"] .swot-item {
            border-left: none;
            border-right: 4px solid;
        }

        [dir="rtl"] #analysis-summary p {
            border-left: none;
            border-right: 4px solid var(--secondary-color);
        }

        [dir="rtl"] .swot-item h4 i,
        [dir="rtl"] .section-title i,
        [dir="rtl"] #analysis-summary h2 i,
        [dir="rtl"] header h1 i {
            margin-right: 0;
            margin-left: 8px;
        }

        /* Responsive Design */
        @media (max-width: 992px) {
            .dashboard {
                grid-template-columns: 1fr;
            }
        }

        @media (max-width: 768px) {
            body {
                padding-top: 60px;
            }
            
            header h1 {
                font-size: 1.8rem;
            }
            
            #analysis-summary {
                top: 75px;
                padding: 20px;
                border-radius: 0;
            }
            
            #analysis-summary h2,
            .section-title {
                font-size: 1.6rem;
            }

            .form-grid {
                grid-template-columns: 1fr;
            }

            .swot-grid {
                grid-template-columns: 1fr;
            }
            
            .chart-container {
                height: 300px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding-top: 50px;
            }
            
            header {
                padding: 1.5rem 1rem;
            }
            
            header h1 {
                font-size: 1.6rem;
            }
            
            #analysis-summary {
                top: 65px;
                padding: 15px;
            }
            
            #analysis-summary h2,
            .section-title {
                font-size: 1.4rem;
            }
            
            #analysis-form label {
                font-size: 0.9rem;
            }
            
            #analysis-form input[type="text"],
            #analysis-form select {
                padding: 10px 12px;
                margin-bottom: 15px;
            }
            
            #analysis-form button {
                padding: 12px 15px;
                font-size: 1rem;
            }
            
            .dashboard-card {
                padding: 15px;
            }
            
            .chart-container {
                height: 250px;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1><i class="fas fa-chart-line"></i> MAIS Competitor Analysis Tool</h1>
    </header>

    <!-- Sticky Summary Section -->
    <section id="analysis-summary" class="container">
        <h2><i class="fas fa-lightbulb"></i> Intelligent Analysis Overview</h2>
        <p>This section provides a dynamic, AI-driven overview of competitor analysis. Enter a competitor's name and select an analysis method to generate a concise, intelligent summary. The detailed report will appear in the 'Detailed Analysis Results' section below.</p>
    </section>

    <div class="main-content-area container">
        <section id="input-section" class="card">
            <h2 class="section-title"><i class="fas fa-search-plus"></i> Generate Detailed Analysis</h2>
            <form id="analysis-form" class="form-grid">
                <div>
                    <label for="competitor-name">Competitor Name:</label>
                    <input type="text" id="competitor-name" name="competitor-name" placeholder="Enter competitor name" required>
                </div>

                <div>
                    <label for="analysis-method">Analysis Method:</label>
                    <select id="analysis-method" name="analysis-method">
                        <option value="swot">SWOT Analysis</option>
                        <option value="market-share">Market Share Analysis</option>
                        <option value="pricing">Pricing Analysis</option>
                        <option value="product-comparison">Product Comparison</option>
                        <option value="website-analysis">Website Analysis</option>
                    </select>
                </div>

                <div class="full-width">
                    <button type="submit">Analyze <i class="fas fa-search" style="margin-left: 8px;"></i></button>
                </div>
            </form>
        </section>

        <section id="results-section" class="card">
            <h2 class="section-title"><i class="fas fa-chart-bar"></i> Detailed Analysis Results</h2>
            <div id="loading-indicator">
                <div class="loading-spinner"></div>
                <div>Analyzing data and generating insights...</div>
            </div>
            <div id="results-container" class="dashboard">
                <div class="dashboard-full dashboard-card">
                    <h3><i class="fas fa-info-circle"></i> Analysis Information</h3>
                    <p class="analysis-text"><em>Your detailed analysis report will appear here once generated.</em></p>
                </div>
            </div>
        </section>
    </div>

    <footer>
        <div class="container">
            <p>Â© 2024 MAIS Analysis Tool. All Rights Reserved.</p>
            <p style="font-size: 0.8em; opacity: 0.7; margin-top: 5px;">Powered by YAZEED </p>
            <div class="social-icons">
                <a href="#"><i class="fab fa-twitter"></i></a>
                <a href="#"><i class="fab fa-linkedin"></i></a>
                <a href="#"><i class="fab fa-facebook"></i></a>
                <a href="#"><i class="fab fa-instagram"></i></a>
            </div>
        </div>
    </footer>

    <script src="https://cdn.jsdelivr.net/npm/chart.js@3.7.1/dist/chart.min.js"></script>
    <script>
        const GEMINI_API_KEY = 'AIzaSyCMrm1LjmlJObZsVCQEuy_wTkh9ZEEc8aQ'; // Replace with your actual API key. Secure this!
        const url = "https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash:generateContent?key=" + GEMINI_API_KEY; // Updated to gemini-1.5-flash
        
        // Detect language direction
        const htmlElement = document.querySelector('html');
        const isRTL = document.documentElement.getAttribute('dir') === 'rtl';
        if (isRTL) {
            document.querySelector('html').setAttribute('dir', 'rtl');
        }

        document.addEventListener('DOMContentLoaded', () => {
            const analysisForm = document.getElementById('analysis-form');
            const resultsContainer = document.getElementById('results-container');
            const loadingIndicator = document.getElementById('loading-indicator');
            const analysisSummarySection = document.getElementById('analysis-summary');
            const initialSummaryText = analysisSummarySection.querySelector('p').innerHTML; // Store initial text

            // Chart objects
            let charts = {};

            // Initially hide the loading indicator
            loadingIndicator.style.display = 'none';

            analysisForm.addEventListener('submit', async (event) => {
                event.preventDefault(); 

                const competitorName = document.getElementById('competitor-name').value;
                const analysisMethod = document.getElementById('analysis-method').value;

                if (!competitorName.trim()) {
                    alert("Please enter a competitor name.");
                    return;
                }

                loadingIndicator.style.display = 'block';
                resultsContainer.innerHTML = ''; 
                
                // Temporarily clear summary or show loading state
                const summaryParagraph = analysisSummarySection.querySelector('p');
                if (summaryParagraph) {
                    summaryParagraph.innerHTML = '<em>Generating intelligent overview...</em>';
                }

                // Destroy any existing charts
                Object.values(charts).forEach(chart => {
                    if (chart) chart.destroy();
                });
                charts = {};

                const prompt = generatePrompt(competitorName, analysisMethod);

                try {
                    const response = await fetch(url, {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            contents: [{
                                parts: [{ text: prompt }]
                            }],
                            generationConfig: {
                                "temperature": 0.7,
                                "topP": 1,
                                "topK": 1,
                                "maxOutputTokens": 1024,
                            }
                        })
                    });

                    if (!response.ok) {
                        const errorData = await response.json();
                        console.error("API Error Response:", errorData);
                        throw new Error(`HTTP error! Status: ${response.status}. Message: ${errorData.error?.message || 'Unknown API error'}`);
                    }

                    const data = await response.json();
                    
                    loadingIndicator.style.display = 'none';
                    displayResults(data, resultsContainer, competitorName, analysisMethod);
                    updateAnalysisSummary(data, competitorName, analysisMethod, initialSummaryText);

                    // Generate visualization data based on analysis type
                    generateVisualizations(competitorName, analysisMethod, data);

                } catch (error) {
                    console.error('Error:', error);
                    loadingIndicator.style.display = 'none';
                    resultsContainer.innerHTML = `<div class="dashboard-full dashboard-card">
                        <h3><i class="fas fa-exclamation-triangle"></i> Error</h3>
                        <p class="error">Error fetching analysis: ${error.message}. Please check the console for more details and ensure your API key is valid and the API is enabled.</p>
                    </div>`;
                    
                    // Restore initial summary text on error
                    const summaryParagraph = analysisSummarySection.querySelector('p');
                    if (summaryParagraph) {
                         summaryParagraph.innerHTML = initialSummaryText;
                    }
                }
            });

            function generatePrompt(competitorName, analysisMethod) {
                let prompt = "";
                
                // Base prompt with structure request for better visualization
                const basePrompt = `Generate a detailed analysis about "${competitorName}", a competitor to MAIS Saudi Arabia in the medical supplies and equipment sector. 

After your analysis, include a section called VISUALIZATION_DATA with data points for charts/graphs that would help visualize your analysis. Format this section with clear labels and numeric values where possible.`;
                
                // Prompts refined for clarity and visualization data
                switch (analysisMethod) {
                    case 'swot':
                        prompt = `${basePrompt}

For a SWOT analysis, please structure your response clearly with:
1. A brief introduction about ${competitorName}
2. Clearly labeled sections for Strengths, Weaknesses, Opportunities, and Threats
3. Bullet points within each section
4. A brief conclusion

In the VISUALIZATION_DATA section, include:
1. A quantitative strength score (1-10) for each main strength
2. A quantitative weakness score (1-10) for each main weakness
3. An opportunity impact score (1-10) for each opportunity
4. A threat severity score (1-10) for each threat`;
                        break;
                    case 'market-share':
                        prompt = `${basePrompt}

For a market share analysis, please structure your response with:
1. An estimation of ${competitorName}'s approximate market share in the Saudi medical supplies sector
2. Comparison with MAIS and other major players
3. Growth trends and trajectory
4. Factors influencing their market position

In the VISUALIZATION_DATA section, include:
1. Estimated market share percentages for ${competitorName}, MAIS, and top 3-4 other competitors
2. Year-over-year growth rates if available
3. Market segment distribution data points`;
                        break;
                    case 'pricing':
                        prompt = `${basePrompt}

For pricing analysis, please structure your response with:
1. Overall pricing strategy of ${competitorName}
2. How their pricing compares to MAIS (higher, lower, or similar)
3. Price-quality relationship
4. Price positioning for key product categories
5. Discount strategies and promotions

In the VISUALIZATION_DATA section, include:
1. A relative price index (with MAIS as baseline 100) for major product categories
2. Estimated price-quality matrix points (price 1-10, quality 1-10)
3. Price trend indicators (percentage changes) if available`;
                        break;
                    case 'product-comparison':
                        prompt = `${basePrompt}

For product comparison, please structure your response with:
1. Overview of ${competitorName}'s product portfolio
2. Direct comparison with MAIS product lines
3. Unique product offerings
4. Quality perception
5. Product range breadth and depth
6. Innovation assessment

In the VISUALIZATION_DATA section, include:
1. Product category coverage scores (1-10) for both companies across 5-6 key categories
2. Innovation scores (1-10)
3. Quality perception scores (1-10)
4. Product range breadth score (total number of product lines or categories)`;
                        break;
                    case 'website-analysis':
                        prompt = `${basePrompt}

For website analysis, please structure your response with:
1. Overall assessment of ${competitorName}'s website
2. User experience and navigation
3. Content quality and product information
4. Digital marketing and SEO positioning
5. E-commerce capabilities
6. Comparison with MAIS website

In the VISUALIZATION_DATA section, include:
1. Website performance scores (1-10) across categories like: usability, design, content, technical SEO, mobile-friendliness
2. Feature comparison points between ${competitorName} and MAIS websites
3. Estimated traffic sources distribution (percentage from organic, direct, social, etc.)`;
                        break;
                    default:
                        prompt = `${basePrompt}

Please provide a general competitive overview structured with:
1. Company background
2. Market positioning
3. Key strengths and challenges
4. Competitive relationship with MAIS
5. Future outlook

In the VISUALIZATION_DATA section, include:
1. Competitive strength scores (1-10) across 5-6 key business dimensions
2. Market positioning map coordinates (x,y coordinates for factors like price vs quality, etc.)`;
                }
                return prompt;
            }

            function displayResults(data, container, competitorName, analysisMethod) {
                if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    const analysisText = data.candidates[0].content.parts[0].text;
                    
                    // Split content to separate visualization data
                    const parts = analysisText.split("VISUALIZATION_DATA");
                    const mainAnalysis = parts[0].trim();
                    
                    // Create HTML structure based on analysis method
                    switch(analysisMethod) {
                        case 'swot':
                            displaySWOTAnalysis(container, mainAnalysis, competitorName);
                            break;
                        case 'market-share':
                            displayMarketShareAnalysis(container, mainAnalysis, competitorName);
                            break;
                        case 'pricing':
                            displayPricingAnalysis(container, mainAnalysis, competitorName);
                            break;
                        case 'product-comparison':
                            displayProductComparison(container, mainAnalysis, competitorName);
                            break;
                        case 'website-analysis':
                            displayWebsiteAnalysis(container, mainAnalysis, competitorName);
                            break;
                        default:
                            displayGeneralAnalysis(container, mainAnalysis, competitorName);
                    }
                } else {
                    console.warn("No valid content in API response for detailed results:", data);
                    container.innerHTML = `
                    <div class="dashboard-full dashboard-card">
                        <h3><i class="fas fa-exclamation-circle"></i> Error</h3>
                        <p>No detailed analysis results found or the response format was unexpected. Check console for details.</p>
                    </div>`;
                }
            }

            function displaySWOTAnalysis(container, analysisText, competitorName) {
                // Format analysis into SWOT sections
                const sections = {
                    strengths: extractSectionContent(analysisText, "Strengths", ["Weaknesses", "Opportunities", "Threats", "Conclusion"]),
                    weaknesses: extractSectionContent(analysisText, "Weaknesses", ["Opportunities", "Threats", "Conclusion"]),
                    opportunities: extractSectionContent(analysisText, "Opportunities", ["Threats", "Conclusion"]),
                    threats: extractSectionContent(analysisText, "Threats", ["Conclusion"])
                };
                
                // Create introduction section
                const introduction = extractSectionContent(analysisText, "Introduction", ["Strengths"]) || 
                                    analysisText.split("Strengths")[0];
                
                // Create conclusion section
                const conclusion = extractSectionContent(analysisText, "Conclusion", []);
                
                container.innerHTML = `
                    <div class="dashboard-full dashboard-card">
                        <h3><i class="fas fa-info-circle"></i> SWOT Analysis: ${competitorName}</h3>
                        <div class="analysis-text">${formatText(introduction)}</div>
                    </div>
                    
                    <div class="dashboard-full dashboard-card">
                        <div class="swot-grid">
                            <div class="swot-item strengths">
                                <h4><i class="fas fa-plus-circle"></i> Strengths</h4>
                                ${formatBulletPoints(sections.strengths)}
                            </div>
                            
                            <div class="swot-item weaknesses">
                                <h4><i class="fas fa-minus-circle"></i> Weaknesses</h4>
                                ${formatBulletPoints(sections.weaknesses)}
                            </div>
                            
                            <div class="swot-item opportunities">
                                <h4><i class="fas fa-lightbulb"></i> Opportunities</h4>
                                ${formatBulletPoints(sections.opportunities)}
                            </div>
                            
                            <div class="swot-item threats">
                                <h4><i class="fas fa-exclamation-triangle"></i> Threats</h4>
                                ${formatBulletPoints(sections.threats)}
                            </div>
                        </div>
                    </div>
                    
                    <div class="dashboard-card dashboard-full">
                        <h3><i class="fas fa-chart-pie"></i> SWOT Factors Strength</h3>
                        <div class="chart-container">
                            <canvas id="swotChart"></canvas>
                        </div>
                    </div>
                    
                    ${conclusion ? `
                    <div class="dashboard-card dashboard-full">
                        <h3><i class="fas fa-flag-checkered"></i> Conclusion</h3>
                        <div class="analysis-text">${formatText(conclusion)}</div>
                    </div>
                    ` : ''}
                `;
            }

            function displayMarketShareAnalysis(container, analysisText, competitorName) {
                container.innerHTML = `
                    <div class="dashboard-full dashboard-card">
                        <h3><i class="fas fa-chart-pie"></i> Market Share Analysis: ${competitorName}</h3>
                        <div class="analysis-text">${formatText(analysisText)}</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-percentage"></i> Estimated Market Share Distribution</h3>
                        <div class="chart-container">
                            <canvas id="marketShareChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-chart-line"></i> Market Growth Trends</h3>
                        <div class="chart-container">
                            <canvas id="growthTrendChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card dashboard-full">
                        <h3><i class="fas fa-sitemap"></i> Market Segment Distribution</h3>
                        <div class="chart-container">
                            <canvas id="segmentChart"></canvas>
                        </div>
                    </div>
                `;
            }

            function displayPricingAnalysis(container, analysisText, competitorName) {
                container.innerHTML = `
                    <div class="dashboard-full dashboard-card">
                        <h3><i class="fas fa-tag"></i> Pricing Analysis: ${competitorName}</h3>
                        <div class="analysis-text">${formatText(analysisText)}</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-balance-scale"></i> Relative Price Comparison</h3>
                        <div class="chart-container">
                            <canvas id="priceComparisonChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-th"></i> Price-Quality Matrix</h3>
                        <div class="chart-container">
                            <canvas id="priceQualityChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card dashboard-full">
                        <h3><i class="fas fa-chart-bar"></i> Price Trends</h3>
                        <div class="chart-container">
                            <canvas id="priceTrendChart"></canvas>
                        </div>
                    </div>
                `;
            }

            function displayProductComparison(container, analysisText, competitorName) {
                container.innerHTML = `
                    <div class="dashboard-full dashboard-card">
                        <h3><i class="fas fa-boxes"></i> Product Comparison: ${competitorName}</h3>
                        <div class="analysis-text">${formatText(analysisText)}</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-th"></i> Product Category Coverage</h3>
                        <div class="chart-container">
                            <canvas id="categoryComparisonChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-star"></i> Quality & Innovation</h3>
                        <div class="chart-container">
                            <canvas id="qualityInnovationChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card dashboard-full">
                        <h3><i class="fas fa-sitemap"></i> Product Range Comparison</h3>
                        <div class="chart-container">
                            <canvas id="productRangeChart"></canvas>
                        </div>
                    </div>
                `;
            }

            function displayWebsiteAnalysis(container, analysisText, competitorName) {
                container.innerHTML = `
                    <div class="dashboard-full dashboard-card">
                        <h3><i class="fas fa-globe"></i> Website Analysis: ${competitorName}</h3>
                        <div class="analysis-text">${formatText(analysisText)}</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-tachometer-alt"></i> Website Performance</h3>
                        <div class="chart-container">
                            <canvas id="websitePerformanceChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-random"></i> Traffic Sources</h3>
                        <div class="chart-container">
                            <canvas id="trafficSourcesChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card dashboard-full">
                        <h3><i class="fas fa-list-ul"></i> Feature Comparison</h3>
                        <div class="chart-container">
                            <canvas id="featureComparisonChart"></canvas>
                        </div>
                    </div>
                `;
            }

            function displayGeneralAnalysis(container, analysisText, competitorName) {
                container.innerHTML = `
                    <div class="dashboard-full dashboard-card">
                        <h3><i class="fas fa-building"></i> General Competitive Analysis: ${competitorName}</h3>
                        <div class="analysis-text">${formatText(analysisText)}</div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-chart-radar"></i> Competitive Strengths</h3>
                        <div class="chart-container">
                            <canvas id="competitiveStrengthChart"></canvas>
                        </div>
                    </div>
                    
                    <div class="dashboard-card">
                        <h3><i class="fas fa-map-marker-alt"></i> Market Positioning</h3>
                        <div class="chart-container">
                            <canvas id="positioningChart"></canvas>
                        </div>
                    </div>
                `;
            }

            function generateVisualizations(competitorName, analysisMethod, data) {
                // Extract visualization data if available
                let visualizationData = null;
                if (data && data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0].text) {
                    const parts = data.candidates[0].content.parts[0].text.split("VISUALIZATION_DATA");
                    if (parts.length > 1) {
                        visualizationData = parts[1].trim();
                    }
                }
                
                // Based on analysis method, create appropriate charts
                switch(analysisMethod) {
                    case 'swot':
                        createSWOTCharts(competitorName, visualizationData);
                        break;
                    case 'market-share':
                        createMarketShareCharts(competitorName, visualizationData);
                        break;
                    case 'pricing':
                        createPricingCharts(competitorName, visualizationData);
                        break;
                    case 'product-comparison':
                        createProductComparisonCharts(competitorName, visualizationData);
                        break;
                    case 'website-analysis':
                        createWebsiteAnalysisCharts(competitorName, visualizationData);
                        break;
                    default:
                        createGeneralAnalysisCharts(competitorName, visualizationData);
                }
            }

            function createSWOTCharts(competitorName, visualizationData) {
                // Default data if visualization data not properly formatted
                let strengthScores = [
                    {name: 'Market Position', score: 7},
                    {name: 'Product Quality', score: 8},
                    {name: 'Brand Recognition', score: 6},
                    {name: 'Customer Service', score: 7}
                ];
                
                let weaknessScores = [
                    {name: 'Price Point', score: 6},
                    {name: 'Limited Range', score: 5},
                    {name: 'Regional Coverage', score: 4}
                ];
                
                let opportunityScores = [
                    {name: 'Market Expansion', score: 8},
                    {name: 'Digital Transformation', score: 7},
                    {name: 'New Product Lines', score: 6}
                ];
                
                let threatScores = [
                    {name: 'Price Competition', score: 7},
                    {name: 'Regulatory Changes', score: 5},
                    {name: 'New Entrants', score: 6}
                ];
                
                // Try to parse actual data if available
                if (visualizationData) {
                    try {
                        // Extract scores using regex or other parsing methods
                        const strengthMatch = visualizationData.match(/strength score[^:]*:(.*?)(?=weakness|opportunity|threat|\n\n|$)/is);
                        const weaknessMatch = visualizationData.match(/weakness score[^:]*:(.*?)(?=strength|opportunity|threat|\n\n|$)/is);
                        const opportunityMatch = visualizationData.match(/opportunity[^:]*score[^:]*:(.*?)(?=strength|weakness|threat|\n\n|$)/is);
                        const threatMatch = visualizationData.match(/threat[^:]*score[^:]*:(.*?)(?=strength|weakness|opportunity|\n\n|$)/is);
                        
                        if (strengthMatch) {
                            const extractedStrengths = parseScores(strengthMatch[1]);
                            if (extractedStrengths.length > 0) strengthScores = extractedStrengths;
                        }
                        
                        if (weaknessMatch) {
                            const extractedWeaknesses = parseScores(weaknessMatch[1]);
                            if (extractedWeaknesses.length > 0) weaknessScores = extractedWeaknesses;
                        }
                        
                        if (opportunityMatch) {
                            const extractedOpportunities = parseScores(opportunityMatch[1]);
                            if (extractedOpportunities.length > 0) opportunityScores = extractedOpportunities;
                        }
                        
                        if (threatMatch) {
                            const extractedThreats = parseScores(threatMatch[1]);
                            if (extractedThreats.length > 0) threatScores = extractedThreats;
                        }
                    } catch (e) {
                        console.error("Error parsing SWOT visualization data:", e);
                    }
                }
                
                // Create SWOT chart
                const ctx = document.getElementById('swotChart').getContext('2d');
                
                // Prepare labels and datasets
                const labels = [
                    ...strengthScores.map(s => `S: ${s.name}`),
                    ...weaknessScores.map(w => `W: ${w.name}`),
                    ...opportunityScores.map(o => `O: ${o.name}`),
                    ...threatScores.map(t => `T: ${t.name}`)
                ];
                
                const data = [
                    ...strengthScores.map(s => s.score),
                    ...weaknessScores.map(w => w.score),
                    ...opportunityScores.map(o => o.score),
                    ...threatScores.map(t => t.score)
                ];
                
                // Colors for each SWOT category
                const backgroundColors = [
                    ...Array(strengthScores.length).fill('rgba(40, 167, 69, 0.7)'),
                    ...Array(weaknessScores.length).fill('rgba(220, 53, 69, 0.7)'),
                    ...Array(opportunityScores.length).fill('rgba(0, 123, 255, 0.7)'),
                    ...Array(threatScores.length).fill('rgba(255, 193, 7, 0.7)')
                ];
                
                charts.swot = new Chart(ctx, {
                    type: 'bar',
                    data: {
                        labels: labels,
                        datasets: [{
                            label: 'Factor Strength (1-10)',
                            data: data,
                            backgroundColor: backgroundColors,
                            borderColor: backgroundColors.map(color => color.replace('0.7', '1')),
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 10,
                                title: {
                                    display: true,
                                    text: 'Strength/Impact Score (1-10)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: `SWOT Analysis Factors for ${competitorName}`,
                                font: {
                                    size: 16
                                }
                            },
                            legend: {
                                display: false
                            },
                            tooltip: {
                                callbacks: {
                                    title: function(tooltipItems) {
                                        const item = tooltipItems[0];
                                        return item.label;
                                    },
                                    label: function(context) {
                                        return `Score: ${context.parsed.y}/10`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            function createMarketShareCharts(competitorName, visualizationData) {
                // Default data
                let marketShareData = {
                    competitors: [competitorName, 'MAIS', 'Competitor A', 'Competitor B', 'Others'],
                    shares: [25, 30, 15, 12, 18]
                };
                
                let growthData = {
                    years: ['2021', '2022', '2023', '2024'],
                    competitor: [5, 8, 12, 9],
                    mais: [7, 10, 8, 11],
                    industry: [4, 6, 7, 5]
                };
                
                let segmentData = {
                    segments: ['Hospitals', 'Clinics', 'Pharmacies', 'Labs', 'Other'],
                    competitor: [40, 25, 15, 12, 8],
                    mais: [30, 30, 20, 15, 5]
                };
                
                // Try to parse actual data if available
                if (visualizationData) {
                    try {
                        // Parse market share percentages
                        const shareMatch = visualizationData.match(/market share percentages[^:]*:(.*?)(?=year-over-year|growth rates|market segment|\n\n|$)/is);
                        if (shareMatch) {
                            const shareText = shareMatch[1];
                            const competitors = [];
                            const shares = [];
                            
                            // Extract competitor names and percentages
                            const shareRegex = /([^:,]+)[:,-]\s*(\d+(?:\.\d+)?)%/g;
                            let match;
                            while ((match = shareRegex.exec(shareText)) !== null) {
                                competitors.push(match[1].trim());
                                shares.push(parseFloat(match[2]));
                            }
                            
                            if (competitors.length > 0 && shares.length > 0) {
                                marketShareData.competitors = competitors;
                                marketShareData.shares = shares;
                            }
                        }
                        
                        // Parse growth data if available
                        const growthMatch = visualizationData.match(/growth rates[^:]*:(.*?)(?=market share|market segment|\n\n|$)/is);
                        if (growthMatch) {
                            // Process growth data parsing here
                            // (simplified for this example)
                        }
                        
                        // Parse segment data if available
                        const segmentMatch = visualizationData.match(/market segment[^:]*distribution[^:]*:(.*?)(?=\n\n|$)/is);
                        if (segmentMatch) {
                            // Process segment data parsing here
                            // (simplified for this example)
                        }
                    } catch (e) {
                        console.error("Error parsing market share visualization data:", e);
                    }
                }
                
                // Create market share pie chart
                const marketShareCtx = document.getElementById('marketShareChart').getContext('2d');
                charts.marketShare = new Chart(marketShareCtx, {
                    type: 'pie',
                    data: {
                        labels: marketShareData.competitors,
                        datasets: [{
                            data: marketShareData.shares,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)',
                                'rgba(255, 159, 64, 0.7)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)',
                                'rgba(255, 159, 64, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: 'Estimated Market Share Distribution',
                                font: {
                                    size: 16
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        return `${label}: ${value}%`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Create growth trend line chart
                const growthCtx = document.getElementById('growthTrendChart').getContext('2d');
                charts.growthTrend = new Chart(growthCtx, {
                    type: 'line',
                    data: {
                        labels: growthData.years,
                        datasets: [
                            {
                                label: competitorName,
                                data: growthData.competitor,
                                borderColor: 'rgba(255, 99, 132, 1)',
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                tension: 0.3,
                                fill: false
                            },
                            {
                                label: 'MAIS',
                                data: growthData.mais,
                                borderColor: 'rgba(54, 162, 235, 1)',
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                tension: 0.3,
                                fill: false
                            },
                            {
                                label: 'Industry Average',
                                data: growthData.industry,
                                borderColor: 'rgba(255, 206, 86, 1)',
                                backgroundColor: 'rgba(255, 206, 86, 0.2)',
                                tension: 0.3,
                                fill: false,
                                borderDash: [5, 5]
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Growth Rate (%)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Year-over-Year Growth Trends',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
                
                // Create segment distribution chart
                const segmentCtx = document.getElementById('segmentChart').getContext('2d');
                charts.segment = new Chart(segmentCtx, {
                    type: 'bar',
                    data: {
                        labels: segmentData.segments,
                        datasets: [
                            {
                                label: competitorName,
                                data: segmentData.competitor,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'MAIS',
                                data: segmentData.mais,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                title: {
                                    display: true,
                                    text: 'Market Presence (%)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Market Segment Distribution',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
            }

            function createPricingCharts(competitorName, visualizationData) {
                // Default data
                let priceIndexData = {
                    categories: ['Diagnostic Eq.', 'Surgical Supplies', 'Monitoring Devices', 'Safety Products', 'Disposables'],
                    competitor: [110, 95, 105, 90, 85],
                    baseline: [100, 100, 100, 100, 100]
                };
                
                let priceQualityData = {
                    competitors: [
                        {name: competitorName, price: 7, quality: 8},
                        {name: 'MAIS', price: 6, quality: 8},
                        {name: 'Competitor A', price: 8, quality: 7},
                        {name: 'Competitor B', price: 5, quality: 6},
                        {name: 'Competitor C', price: 9, quality: 9}
                    ]
                };
                
                let priceTrendData = {
                    categories: ['Diagnostic Eq.', 'Surgical Supplies', 'Monitoring Devices', 'Safety Products', 'Disposables'],
                    competitor: [3, -2, 1, 0, -3],
                    mais: [2, 1, 0, -1, -2],
                    industry: [2.5, 0, 0.5, -0.5, -1]
                };
                
                // Try to parse actual data if available
                if (visualizationData) {
                    try {
                        // Parse price index data
                        const priceIndexMatch = visualizationData.match(/relative price index[^:]*:(.*?)(?=price-quality|price trend|\n\n|$)/is);
                        if (priceIndexMatch) {
                            // Process price index parsing
                        }
                        
                        // Parse price-quality matrix data
                        const priceQualityMatch = visualizationData.match(/price-quality matrix[^:]*:(.*?)(?=relative price|price trend|\n\n|$)/is);
                        if (priceQualityMatch) {
                            // Process price-quality parsing
                        }
                        
                        // Parse price trend data
                        const priceTrendMatch = visualizationData.match(/price trend[^:]*:(.*?)(?=\n\n|$)/is);
                        if (priceTrendMatch) {
                            // Process price trend parsing
                        }
                    } catch (e) {
                        console.error("Error parsing pricing visualization data:", e);
                    }
                }
                
                // Create relative price comparison chart
                const priceComparisonCtx = document.getElementById('priceComparisonChart').getContext('2d');
                charts.priceComparison = new Chart(priceComparisonCtx, {
                    type: 'bar',
                    data: {
                        labels: priceIndexData.categories,
                        datasets: [
                            {
                                label: competitorName,
                                data: priceIndexData.competitor,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'MAIS (Baseline)',
                                data: priceIndexData.baseline,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Price Index (MAIS = 100)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Relative Price Comparison by Category',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
                
                // Create price-quality matrix chart (scatter plot)
                const priceQualityCtx = document.getElementById('priceQualityChart').getContext('2d');
                charts.priceQuality = new Chart(priceQualityCtx, {
                    type: 'scatter',
                    data: {
                        datasets: priceQualityData.competitors.map(comp => ({
                            label: comp.name,
                            data: [{x: comp.quality, y: comp.price}],
                            backgroundColor: comp.name === competitorName ? 'rgba(255, 99, 132, 0.7)' : 
                                            comp.name === 'MAIS' ? 'rgba(54, 162, 235, 0.7)' : 
                                            getRandomColor(0.7),
                            borderColor: comp.name === competitorName ? 'rgba(255, 99, 132, 1)' : 
                                         comp.name === 'MAIS' ? 'rgba(54, 162, 235, 1)' : 
                                         getRandomColor(1),
                            borderWidth: 1,
                            pointRadius: 8,
                            pointHoverRadius: 10
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                min: 0,
                                max: 10,
                                title: {
                                    display: true,
                                    text: 'Quality (1-10)'
                                }
                            },
                            y: {
                                min: 0,
                                max: 10,
                                title: {
                                    display: true,
                                    text: 'Price (1-10, higher = more expensive)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Price-Quality Positioning Matrix',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
                
                // Create price trend chart
                const priceTrendCtx = document.getElementById('priceTrendChart').getContext('2d');
                charts.priceTrend = new Chart(priceTrendCtx, {
                    type: 'bar',
                    data: {
                        labels: priceTrendData.categories,
                        datasets: [
                            {
                                label: competitorName,
                                data: priceTrendData.competitor,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'MAIS',
                                data: priceTrendData.mais,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'Industry Average',
                                data: priceTrendData.industry,
                                backgroundColor: 'rgba(255, 206, 86, 0.7)',
                                borderColor: 'rgba(255, 206, 86, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                title: {
                                    display: true,
                                    text: 'Annual Price Change (%)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Annual Price Change by Category',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
            }

            function createProductComparisonCharts(competitorName, visualizationData) {
                // Default data
                let categoryData = {
                    categories: ['Diagnostic', 'Surgical', 'Monitoring', 'Disposables', 'Safety', 'Specialized'],
                    competitor: [8, 7, 9, 6, 7, 5],
                    mais: [7, 9, 8, 8, 6, 8]
                };
                
                let qualityInnovationData = {
                    competitors: [
                        {name: competitorName, quality: 8, innovation: 7},
                        {name: 'MAIS', quality: 8, innovation: 8},
                        {name: 'Competitor A', quality: 7, innovation: 6},
                        {name: 'Competitor B', quality: 6, innovation: 9}
                    ]
                };
                
                let productRangeData = {
                    categories: ['Product Lines', 'Product Depth', 'Specialization', 'Customization'],
                    competitor: [70, 65, 80, 55],
                    mais: [85, 75, 70, 80]
                };
                
                // Try to parse actual data if available
                if (visualizationData) {
                    try {
                        // Parsing logic here
                    } catch (e) {
                        console.error("Error parsing product comparison visualization data:", e);
                    }
                }
                
                // Create category comparison radar chart
                const categoryCtx = document.getElementById('categoryComparisonChart').getContext('2d');
                charts.categoryComparison = new Chart(categoryCtx, {
                    type: 'radar',
                    data: {
                        labels: categoryData.categories,
                        datasets: [
                            {
                                label: competitorName,
                                data: categoryData.competitor,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(255, 99, 132, 1)'
                            },
                            {
                                label: 'MAIS',
                                data: categoryData.mais,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                suggestedMin: 0,
                                suggestedMax: 10
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Product Category Strength (1-10)',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
                
                // Create quality & innovation scatter chart
                const qualityCtx = document.getElementById('qualityInnovationChart').getContext('2d');
                charts.qualityInnovation = new Chart(qualityCtx, {
                    type: 'scatter',
                    data: {
                        datasets: qualityInnovationData.competitors.map(comp => ({
                            label: comp.name,
                            data: [{x: comp.innovation, y: comp.quality}],
                            backgroundColor: comp.name === competitorName ? 'rgba(255, 99, 132, 0.7)' : 
                                            comp.name === 'MAIS' ? 'rgba(54, 162, 235, 0.7)' : 
                                            getRandomColor(0.7),
                            borderColor: comp.name === competitorName ? 'rgba(255, 99, 132, 1)' : 
                                         comp.name === 'MAIS' ? 'rgba(54, 162, 235, 1)' : 
                                         getRandomColor(1),
                            borderWidth: 1,
                            pointRadius: 8,
                            pointHoverRadius: 10
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                min: 0,
                                max: 10,
                                title: {
                                    display: true,
                                    text: 'Innovation (1-10)'
                                }
                            },
                            y: {
                                min: 0,
                                max: 10,
                                title: {
                                    display: true,
                                    text: 'Quality (1-10)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Quality vs Innovation Positioning',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
                
                // Create product range comparison chart
                const rangeCtx = document.getElementById('productRangeChart').getContext('2d');
                charts.productRange = new Chart(rangeCtx, {
                    type: 'bar',
                    data: {
                        labels: productRangeData.categories,
                        datasets: [
                            {
                                label: competitorName,
                                data: productRangeData.competitor,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'MAIS',
                                data: productRangeData.mais,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 100,
                                title: {
                                    display: true,
                                    text: 'Score (0-100)'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Product Range Comparison',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
            }

            function createWebsiteAnalysisCharts(competitorName, visualizationData) {
                // Default data
                let performanceData = {
                    metrics: ['Design', 'Usability', 'Content', 'Technical SEO', 'Mobile-friendly'],
                    competitor: [7, 6, 8, 5, 7],
                    mais: [8, 7, 6, 7, 8]
                };
                
                let trafficData = {
                    sources: ['Organic', 'Direct', 'Referral', 'Social', 'Email'],
                    competitor: [45, 25, 15, 10, 5]
                };
                
                let featureData = {
                    features: ['Product Catalog', 'Search Function', 'Product Info', 'Customer Support', 'Order System', 'Mobile Experience'],
                    competitor: [1, 0.8, 0.9, 0.7, 0.5, 0.8],
                    mais: [0.9, 0.9, 0.7, 0.8, 0.8, 0.7]
                };
                
                // Try to parse actual data if available
                if (visualizationData) {
                    try {
                        // Parsing logic here
                    } catch (e) {
                        console.error("Error parsing website analysis visualization data:", e);
                    }
                }
                
                // Create website performance radar chart
                const performanceCtx = document.getElementById('websitePerformanceChart').getContext('2d');
                charts.websitePerformance = new Chart(performanceCtx, {
                    type: 'radar',
                    data: {
                        labels: performanceData.metrics,
                        datasets: [
                            {
                                label: competitorName,
                                data: performanceData.competitor,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(255, 99, 132, 1)'
                            },
                            {
                                label: 'MAIS',
                                data: performanceData.mais,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                suggestedMin: 0,
                                suggestedMax: 10
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Website Performance Metrics (1-10)',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
                
                // Create traffic sources doughnut chart
                const trafficCtx = document.getElementById('trafficSourcesChart').getContext('2d');
                charts.trafficSources = new Chart(trafficCtx, {
                    type: 'doughnut',
                    data: {
                        labels: trafficData.sources,
                        datasets: [{
                            data: trafficData.competitor,
                            backgroundColor: [
                                'rgba(255, 99, 132, 0.7)',
                                'rgba(54, 162, 235, 0.7)',
                                'rgba(255, 206, 86, 0.7)',
                                'rgba(75, 192, 192, 0.7)',
                                'rgba(153, 102, 255, 0.7)'
                            ],
                            borderColor: [
                                'rgba(255, 99, 132, 1)',
                                'rgba(54, 162, 235, 1)',
                                'rgba(255, 206, 86, 1)',
                                'rgba(75, 192, 192, 1)',
                                'rgba(153, 102, 255, 1)'
                            ],
                            borderWidth: 1
                        }]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        plugins: {
                            title: {
                                display: true,
                                text: `Estimated Traffic Sources for ${competitorName}`,
                                font: {
                                    size: 16
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        const label = context.label || '';
                                        const value = context.parsed || 0;
                                        return `${label}: ${value}%`;
                                    }
                                }
                            }
                        }
                    }
                });
                
                // Create feature comparison chart
                const featureCtx = document.getElementById('featureComparisonChart').getContext('2d');
                charts.featureComparison = new Chart(featureCtx, {
                    type: 'bar',
                    data: {
                        labels: featureData.features,
                        datasets: [
                            {
                                label: competitorName,
                                data: featureData.competitor,
                                backgroundColor: 'rgba(255, 99, 132, 0.7)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                borderWidth: 1
                            },
                            {
                                label: 'MAIS',
                                data: featureData.mais,
                                backgroundColor: 'rgba(54, 162, 235, 0.7)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                borderWidth: 1
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            y: {
                                beginAtZero: true,
                                max: 1,
                                ticks: {
                                    callback: function(value) {
                                        if (value === 0) return 'Poor';
                                        if (value === 0.5) return 'Average';
                                        if (value === 1) return 'Excellent';
                                        return '';
                                    }
                                },
                                title: {
                                    display: true,
                                    text: 'Feature Quality'
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Website Feature Comparison',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
            }

            function createGeneralAnalysisCharts(competitorName, visualizationData) {
                // Default data
                let strengthData = {
                    dimensions: ['Product Quality', 'Customer Service', 'Innovation', 'Market Share', 'Brand Recognition', 'Value for Money'],
                    competitor: [8, 7, 6, 7, 8, 6],
                    mais: [7, 8, 8, 7, 7, 7]
                };
                
                let positioningData = {
                    competitors: [
                        {name: competitorName, x: 7, y: 8, size: 20},
                        {name: 'MAIS', x: 6, y: 7, size: 25},
                        {name: 'Competitor A', x: 8, y: 6, size: 15},
                        {name: 'Competitor B', x: 5, y: 5, size: 12},
                        {name: 'Competitor C', x: 9, y: 9, size: 10}
                    ],
                    xAxis: 'Price (1 = Low, 10 = High)',
                    yAxis: 'Quality (1 = Low, 10 = High)'
                };
                
                // Try to parse actual data if available
                if (visualizationData) {
                    try {
                        // Parsing logic here
                    } catch (e) {
                        console.error("Error parsing general analysis visualization data:", e);
                    }
                }
                
                // Create competitive strength radar chart
                const strengthCtx = document.getElementById('competitiveStrengthChart').getContext('2d');
                charts.competitiveStrength = new Chart(strengthCtx, {
                    type: 'radar',
                    data: {
                        labels: strengthData.dimensions,
                        datasets: [
                            {
                                label: competitorName,
                                data: strengthData.competitor,
                                backgroundColor: 'rgba(255, 99, 132, 0.2)',
                                borderColor: 'rgba(255, 99, 132, 1)',
                                pointBackgroundColor: 'rgba(255, 99, 132, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(255, 99, 132, 1)'
                            },
                            {
                                label: 'MAIS',
                                data: strengthData.mais,
                                backgroundColor: 'rgba(54, 162, 235, 0.2)',
                                borderColor: 'rgba(54, 162, 235, 1)',
                                pointBackgroundColor: 'rgba(54, 162, 235, 1)',
                                pointBorderColor: '#fff',
                                pointHoverBackgroundColor: '#fff',
                                pointHoverBorderColor: 'rgba(54, 162, 235, 1)'
                            }
                        ]
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            r: {
                                angleLines: {
                                    display: true
                                },
                                suggestedMin: 0,
                                suggestedMax: 10
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Competitive Strength Dimensions (1-10)',
                                font: {
                                    size: 16
                                }
                            }
                        }
                    }
                });
                
                // Create market positioning bubble chart
                const positioningCtx = document.getElementById('positioningChart').getContext('2d');
                charts.positioning = new Chart(positioningCtx, {
                    type: 'bubble',
                    data: {
                        datasets: positioningData.competitors.map(comp => ({
                            label: comp.name,
                            data: [{x: comp.x, y: comp.y, r: comp.size / 3}], // Divide by 3 to get reasonable bubble sizes
                            backgroundColor: comp.name === competitorName ? 'rgba(255, 99, 132, 0.7)' : 
                                            comp.name === 'MAIS' ? 'rgba(54, 162, 235, 0.7)' : 
                                            getRandomColor(0.7),
                            borderColor: comp.name === competitorName ? 'rgba(255, 99, 132, 1)' : 
                                         comp.name === 'MAIS' ? 'rgba(54, 162, 235, 1)' : 
                                         getRandomColor(1),
                            borderWidth: 1
                        }))
                    },
                    options: {
                        responsive: true,
                        maintainAspectRatio: false,
                        scales: {
                            x: {
                                min: 0,
                                max: 10,
                                title: {
                                    display: true,
                                    text: positioningData.xAxis
                                }
                            },
                            y: {
                                min: 0,
                                max: 10,
                                title: {
                                    display: true,
                                    text: positioningData.yAxis
                                }
                            }
                        },
                        plugins: {
                            title: {
                                display: true,
                                text: 'Market Positioning Map (Bubble size represents market share)',
                                font: {
                                    size: 16
                                }
                            },
                            tooltip: {
                                callbacks: {
                                    label: function(context) {
                                        return `${context.dataset.label}: Price = ${context.raw.x}/10, Quality = ${context.raw.y}/10`;
                                    }
                                }
                            }
                        }
                    }
                });
            }

            async function updateAnalysisSummary(detailedData, competitorName, analysisMethod, fallbackText) {
                const summaryParagraph = analysisSummarySection.querySelector('p');
                if (!summaryParagraph) {
                    console.error("Summary paragraph element not found in #analysis-summary");
                    return;
                }

                summaryParagraph.innerHTML = '<em>Generating intelligent overview...</em>'; // Update status

                if (detailedData && detailedData.candidates && detailedData.candidates[0] && detailedData.candidates[0].content && detailedData.candidates[0].content.parts && detailedData.candidates[0].content.parts[0].text) {
                    const detailedAnalysisText = detailedData.candidates[0].content.parts[0].text;
                    // Remove visualization data section for summary
                    const cleanedText = detailedAnalysisText.split("VISUALIZATION_DATA")[0].trim();
                    const summaryPrompt = `Create a very concise (2-3 sentences maximum) executive summary of the following competitive analysis for "${competitorName}" (analysis type: ${analysisMethod}):\n\n${cleanedText}\n\nFocus on the most critical insights.`;

                    try {
                        const summaryResponse = await fetch(url, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify({
                                contents: [{ parts: [{ text: summaryPrompt }] }],
                                generationConfig: {
                                    "temperature": 0.7,
                                    "maxOutputTokens": 200,
                                }
                            })
                        });

                        if (!summaryResponse.ok) {
                            const errorData = await summaryResponse.json();
                            throw new Error(`HTTP error generating summary! Status: ${summaryResponse.status}. Message: ${errorData.error?.message || 'Unknown API error'}`);
                        }

                        const summaryData = await summaryResponse.json();

                        if (summaryData && summaryData.candidates && summaryData.candidates[0] && summaryData.candidates[0].content && summaryData.candidates[0].content.parts && summaryData.candidates[0].content.parts[0].text) {
                            summaryParagraph.innerHTML = summaryData.candidates[0].content.parts[0].text.replace(/\n/g, '<br>');
                        } else {
                            console.warn("No valid content in API response for summary:", summaryData);
                            summaryParagraph.innerHTML = `Could not generate a concise summary. Please refer to the detailed report below.`;
                        }
                    } catch (summaryError) {
                        console.error('Error generating summary:', summaryError);
                        summaryParagraph.innerHTML = `Error generating summary: ${summaryError.message}. The detailed report is available below.`;
                    }
                } else {
                    summaryParagraph.innerHTML = fallbackText || "No detailed analysis available to summarize.";
                }
            }

            // Helper functions
            function formatText(text) {
                if (!text) return '';
                // Convert newlines to <br>
                let formatted = text.replace(/\n/g, '<br>');
                
                // Highlight key terms with spans
                const highlightTerms = ['strength', 'weakness', 'opportunity', 'threat', 'advantage', 'disadvantage', 'market leader', 'competitive edge', 'challenge'];
                
                highlightTerms.forEach(term => {
                    const regex = new RegExp(`\\b${term}\\w*\\b`, 'gi');
                    formatted = formatted.replace(regex, match => `<span class="highlight">${match}</span>`);
                });
                
                return formatted;
            }

            function formatBulletPoints(text) {
                if (!text) return '<ul><li>No data available</li></ul>';
                
                // Check if text already has bullet points
                if (text.includes('â¢') || text.includes('-') || text.includes('*')) {
                    // Convert existing bullet points to proper HTML
                    const lines = text.split('\n').filter(line => line.trim().length > 0);
                    const bulletItems = lines.map(line => {
                        const trimmed = line.trim().replace(/^[â¢\-*]\s*/, '');
                        return `<li>${trimmed}</li>`;
                    }).join('');
                    
                    return `<ul>${bulletItems}</ul>`;
                } else {
                    // If no bullet points, split by sentences and create bullet points
                    const sentences = text.match(/[^.!?]+[.!?]+/g) || [text];
                    const bulletItems = sentences
                        .filter(sentence => sentence.trim().length > 5) // Filter out very short sentences
                        .map(sentence => `<li>${sentence.trim()}</li>`)
                        .join('');
                    
                    return `<ul>${bulletItems}</ul>`;
                }
            }

            function extractSectionContent(text, sectionTitle, nextSectionTitles) {
                if (!text) return '';
                
                const sectionRegex = new RegExp(`${sectionTitle}[:\\s]*(.*?)(?:${nextSectionTitles.join('|')}|$)`, 'is');
                const match = text.match(sectionRegex);
                
                if (match && match[1]) {
                    return match[1].trim();
                }
                
                return '';
            }

            function parseScores(text) {
                const result = [];
                const lines = text.split('\n');
                
                lines.forEach(line => {
                    // Look for patterns like "Name/description: 7" or "Name - 8/10" or similar
                    const scoreMatch = line.match(/([^:,-]+)[:,-]\s*(\d+(?:\.\d+)?)\s*(?:\/\s*\d+)?/);
                    if (scoreMatch) {
                        const name = scoreMatch[1].trim();
                        const score = parseFloat(scoreMatch[2]);
                        result.push({name, score});
                    }
                });
                
                return result;
            }

            function getRandomColor(alpha = 1) {
                const r = Math.floor(Math.random() * 255);
                const g = Math.floor(Math.random() * 255);
                const b = Math.floor(Math.random() * 255);
                return `rgba(${r}, ${g}, ${b}, ${alpha})`;
            }
        });
    </script>
</body>
</html>