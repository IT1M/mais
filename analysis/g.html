<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>MAIS Medical Products Analysis</title>
    <style>
        :root {
            --primary-color: #0056b3; /* Deep Blue */
            --secondary-color: #4CAF50; /* Green */
            --accent-color: #ff9800; /* Orange for accents if needed */
            --background-color: #f8f9fa; /* Lighter gray */
            --card-color: #ffffff;
            --text-color: #343a40; /* Darker gray for text */
            --border-color: #dee2e6; /* Lighter border */
            --shadow: 0 4px 8px rgba(0, 0, 0, 0.05);
            --hover-shadow: 0 8px 16px rgba(0, 0, 0, 0.1);
            --transition: all 0.3s ease-in-out;
            --border-radius: 8px;
        }

        *, *::before, *::after {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        html {
            scroll-behavior: smooth;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background-color: var(--background-color);
            color: var(--text-color);
            line-height: 1.6;
            font-size: 16px;
        }

        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }

        /* Header */
        header {
            background-color: var(--primary-color);
            color: white;
            padding: 15px 0;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 1000;
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .logo a {
            display: flex;
            align-items: center;
            text-decoration: none;
            color: white;
        }

        .logo img {
            height: 48px;
            margin-right: 10px;
            transition: transform 0.3s ease;
        }
        .logo a:hover img {
            transform: scale(1.05);
        }

        .logo-text {
            font-size: 26px;
            font-weight: bold;
            letter-spacing: 0.5px;
        }

        nav ul {
            display: flex;
            list-style: none;
        }

        nav ul li {
            margin-left: 25px;
        }

        nav ul li a {
            color: white;
            text-decoration: none;
            font-weight: 500;
            padding: 8px 0;
            position: relative;
            transition: color 0.3s ease;
        }

        nav ul li a::after {
            content: '';
            position: absolute;
            width: 0;
            height: 2px;
            bottom: 0;
            left: 50%;
            transform: translateX(-50%);
            background-color: var(--secondary-color);
            transition: width 0.3s ease;
        }

        nav ul li a:hover {
            color: #e0e0e0; /* Slightly lighter on hover */
        }
        nav ul li a:hover::after,
        nav ul li a.active::after { /* For active page link */
            width: 100%;
        }


        /* Message Area */
        .message-area {
            padding: 15px;
            margin: 20px auto;
            border-radius: var(--border-radius);
            text-align: center;
            font-weight: 500;
            max-width: 1160px; /* Aligns with container minus padding */
        }
        .message-area.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message-area.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }


        /* Main Content */
        .main-content {
            margin: 30px 0;
        }

        .section-title {
            font-size: 28px;
            margin-bottom: 25px;
            color: var(--primary-color);
            border-bottom: 3px solid var(--secondary-color);
            padding-bottom: 12px;
            font-weight: 600;
        }

        .input-section {
            background-color: var(--card-color);
            padding: 30px;
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            margin-bottom: 30px;
        }

        .select-group {
            margin-bottom: 20px;
        }

        label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #555;
        }

        select, textarea {
            width: 100%;
            padding: 12px 15px;
            border: 1px solid var(--border-color);
            border-radius: 4px; /* Smaller radius for form elements */
            background-color: #fff;
            font-size: 16px;
            transition: var(--transition);
        }

        select:focus, textarea:focus {
            outline: none;
            border-color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(0, 86, 179, 0.15);
        }

        .input-tabs {
            margin-top: 25px;
        }

        .tab-buttons {
            display: flex;
            margin-bottom: 20px;
            border-bottom: 1px solid var(--border-color);
        }

        .tab-button {
            padding: 12px 25px;
            background: none;
            border: none;
            border-bottom: 3px solid transparent;
            cursor: pointer;
            font-size: 16px;
            font-weight: 500;
            transition: var(--transition);
            color: var(--text-color);
        }

        .tab-button.active {
            border-bottom-color: var(--secondary-color);
            color: var(--primary-color);
            font-weight: 600;
        }
        .tab-button:not(.active):hover {
            color: var(--primary-color);
            background-color: rgba(0, 86, 179, 0.05);
        }

        .tab-content {
            display: none;
            padding-top: 10px;
        }

        .tab-content.active {
            display: block;
        }

        .file-upload {
            border: 2px dashed var(--border-color);
            padding: 35px;
            text-align: center;
            border-radius: 6px;
            margin-bottom: 20px;
            transition: var(--transition);
            background-color: #fdfdfd;
        }

        .file-upload:hover {
            border-color: var(--primary-color);
            background-color: rgba(0, 86, 179, 0.02);
        }

        .file-upload p {
            margin-bottom: 15px;
            color: #6c757d;
        }

        .file-input {
            display: none;
        }

        .upload-btn {
            display: inline-block;
            padding: 12px 30px;
            background-color: var(--primary-color);
            color: white;
            border-radius: 4px;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 500;
        }

        .upload-btn:hover {
            background-color: #00458f; /* Darker shade */
        }

        #file-name-display {
            margin-top: 15px;
            font-size: 14px;
            color: #555;
            font-style: italic;
        }

        .text-input textarea {
            min-height: 180px;
            resize: vertical;
        }

        .submit-btn {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: var(--secondary-color);
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 18px;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            margin-top: 25px;
        }

        .submit-btn:hover:not(:disabled) {
            background-color: #409143; /* Darker green */
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.1);
        }

        .submit-btn:disabled {
            background-color: #ced4da;
            cursor: not-allowed;
            color: #6c757d;
        }

        /* Loading Animation */
        .loading {
            display: none; /* Hidden by default */
            text-align: center;
            padding: 40px 20px;
            margin: 30px 0;
        }

        .loading p {
            color: var(--primary-color);
            margin-top: 20px;
            font-size: 18px;
            font-weight: 500;
        }

        .spinner {
            width: 60px;
            height: 60px;
            margin: 0 auto;
            border: 7px solid #e9ecef; /* Light grey for track */
            border-top: 7px solid var(--primary-color); /* Spinner color */
            border-radius: 50%;
            animation: spin 1s linear infinite;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }


        /* Results Section */
        .results-section {
            display: none; /* Hidden by default */
            margin-top: 40px;
            animation: fadeIn 0.5s ease-out;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }

        .results-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(320px, 1fr));
            gap: 30px;
            margin-top: 25px;
        }

        .result-card {
            background-color: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: var(--shadow);
            transition: var(--transition);
            overflow: hidden; /* Ensures content respects border radius */
        }

        .result-card:hover {
            transform: translateY(-5px);
            box-shadow: var(--hover-shadow);
        }

        .card-header {
            background-color: var(--primary-color);
            color: white;
            padding: 18px 25px;
            font-weight: 600;
            font-size: 19px;
        }

        .card-body {
            padding: 25px;
            min-height: 250px; /* Adjusted min-height */
            max-height: 450px; /* Adjusted max-height */
            overflow-y: auto;
            font-size: 15px;
        }
         .card-body h3 {
            font-size: 1.1em;
            color: var(--primary-color);
            margin-top: 1em;
            margin-bottom: 0.5em;
        }
        .card-body p {
            margin-bottom: 1em;
            line-height: 1.7;
        }
        .card-body ul, .card-body ol {
            margin-left: 20px;
            margin-bottom: 1em;
        }
        .card-body li {
            margin-bottom: 0.5em;
        }
        .card-body strong { color: var(--primary-color); }
        .card-body em { color: var(--secondary-color); font-style: normal; }
        .text-highlight {
            background-color: #fff3cd; /* Light yellow highlight */
            padding: 0.1em 0.3em;
            border-radius: 3px;
        }

        /* Table styling for performance card */
        #performance-content table {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
        #performance-content th, #performance-content td {
            border: 1px solid var(--border-color);
            padding: 10px 12px;
            text-align: left;
            font-size: 14px;
        }
        #performance-content th {
            background-color: #f8f9fa; /* Light background for headers */
            font-weight: 600;
            color: var(--primary-color);
        }
        #performance-content tr:nth-child(even) {
            background-color: #fdfdfd;
        }
        #performance-content .status-success { color: var(--secondary-color); font-weight: bold; }
        #performance-content .status-danger { color: #dc3545; font-weight: bold; } /* Red for danger/loss */
        #performance-content .status-neutral { color: #6c757d; } /* Grey for neutral */


        #performance-card {
            grid-column: 1 / -1; /* Span full width on larger screens */
            min-height: 350px;
        }


        /* Footer */
        footer {
            background-color: #343a40; /* Dark footer */
            color: #adb5bd; /* Light text for dark background */
            padding: 30px 0;
            margin-top: 50px;
            text-align: center;
        }

        .footer-content {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 15px;
        }

        .footer-logo {
            font-size: 20px;
            font-weight: bold;
            color: #f8f9fa;
        }

        .footer-links a {
            color: #adb5bd;
            text-decoration: none;
            margin: 0 12px;
            transition: color 0.3s ease;
        }

        .footer-links a:hover {
            color: #ffffff;
        }


        /* 3D Support Button */
        .support-btn-3d {
            position: fixed;
            bottom: 30px;
            right: 30px;
            z-index: 9999;
            width: 60px;
            height: 60px;
            background: linear-gradient(145deg, var(--primary-color) 50%, var(--secondary-color) 100%);
            border-radius: 50%;
            box-shadow: 0 6px 18px rgba(0,86,179,0.2), 0 2px 6px rgba(0,0,0,0.08);
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: transform 0.2s ease, box-shadow 0.2s ease;
            border: none;
            outline: none;
        }
        .support-btn-3d:hover {
            transform: translateY(-5px) scale(1.05);
            box-shadow: 0 12px 24px rgba(0,86,179,0.25), 0 3px 12px rgba(0,0,0,0.1);
        }
        .support-btn-3d svg {
            width: 32px;
            height: 32px;
            filter: drop-shadow(0 1px 2px rgba(0,0,0,0.15));
        }

        /* Support Modal */
        .support-modal-bg {
            display: none; /* Hidden by default */
            position: fixed;
            z-index: 10000;
            left: 0; top: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.4); /* Darker overlay */
            display: flex; /* Use flex for centering, but manage display via JS */
            align-items: center;
            justify-content: center;
            opacity: 0;
            visibility: hidden;
            transition: opacity 0.3s ease, visibility 0s linear 0.3s;
        }
        .support-modal-bg.visible {
            opacity: 1;
            visibility: visible;
            transition: opacity 0.3s ease;
        }

        .support-modal {
            background: var(--card-color);
            border-radius: var(--border-radius);
            box-shadow: 0 10px 40px rgba(0,86,179,0.15);
            max-width: 420px;
            width: 90vw;
            padding: 30px 25px 20px 25px;
            position: relative;
            transform: scale(0.95) translateY(20px);
            transition: transform 0.3s ease;
        }
        .support-modal-bg.visible .support-modal {
            transform: scale(1) translateY(0);
        }

        .support-modal-close {
            position: absolute;
            top: 15px; right: 20px;
            background: none;
            border: none;
            font-size: 26px;
            color: #adb5bd;
            cursor: pointer;
            transition: color 0.2s ease;
        }
        .support-modal-close:hover {
            color: var(--text-color);
        }
        .support-modal-title {
            font-size: 22px;
            font-weight: 600; /* Bolder */
            color: var(--primary-color);
            margin-bottom: 12px;
        }
        .support-modal-desc {
            font-size: 15px;
            color: #555;
            margin-bottom: 20px;
        }
        .support-modal textarea {
            width: 100%;
            min-height: 100px;
            border: 1px solid var(--border-color);
            border-radius: 4px;
            padding: 12px;
            font-size: 15px;
            margin-bottom: 15px;
            resize: vertical;
        }
        .support-modal .support-send-btn {
            background: var(--primary-color);
            color: #fff;
            border: none;
            border-radius: 4px;
            padding: 12px 25px;
            font-size: 16px;
            font-weight: 500;
            cursor: pointer;
            transition: background-color 0.2s ease;
            width: 100%;
        }
        .support-modal .support-send-btn:hover:not(:disabled) {
            background-color: #00458f;
        }
        .support-modal .support-send-btn:disabled {
            background: #ced4da;
            cursor: not-allowed;
        }
        .support-modal .support-loading {
            margin-top: 12px;
            color: var(--primary-color);
            font-size: 15px;
            text-align: center;
        }
        .support-modal .support-response {
            margin-top: 18px;
            background: #f8f9fa;
            border-radius: 6px;
            padding: 15px;
            font-size: 15px;
            color: var(--text-color);
            min-height: 40px;
            white-space: pre-line; /* Respect newlines from AI */
            border: 1px solid var(--border-color);
        }

        /* Responsive Adjustments */
        @media (max-width: 992px) {
            #performance-card {
                grid-column: span 1; /* Stack on smaller screens */
            }
        }

        @media (max-width: 768px) {
            .header-content {
                flex-direction: column;
                text-align: center;
            }
            .logo { margin-bottom: 10px; }
            nav ul {
                margin-top: 15px;
                justify-content: center;
                flex-wrap: wrap; /* Allow nav items to wrap */
            }
            nav ul li { margin: 5px 10px; }

            .results-grid {
                grid-template-columns: 1fr; /* Single column for cards */
            }
            .footer-content {
                flex-direction: column;
                text-align: center;
            }
            .footer-links { margin-top: 15px; }
            .footer-links a { margin: 0 8px; }
        }

        @media (max-width: 480px) {
            .section-title { font-size: 24px; }
            .input-section, .card-body, .card-header { padding: 20px; }
            .tab-buttons {
                flex-direction: column;
                border-bottom: none;
            }
            .tab-button {
                border-bottom: 1px solid var(--border-color);
                text-align: left;
                width: 100%;
            }
            .tab-button.active {
                border-left: 4px solid var(--secondary-color);
                border-bottom-color: var(--border-color); /* Keep bottom border */
            }
            .support-modal { padding: 20px 15px 15px 15px; }
            .support-modal-title { font-size: 20px; }
        }
    </style>
</head>
<body>
    <header>
        <div class="container">
            <div class="header-content">
                <div class="logo">
                    <a href="#" title="MAIS Home">
                        <img src="../logo.png" alt="MAIS Company Logo">
                        <span class="logo-text">MAIS Analytics</span>
                    </a>
                </div>
                <nav>
                    <ul>
                        <li><a href="#" class="active">Home</a></li>
                        <li><a href="Competitor-analysis.html">Competitor Analysis</a></li>
                        <li><a href="#">Reports</a></li>
                        <li><a href="#">Contact</a></li>
                    </ul>
                </nav>
            </div>
        </div>
    </header>

    <div class="container">
        <div id="message-area" class="message-area" style="display:none;" role="alert"></div>

        <main class="main-content">
            <h1 class="section-title">Sales Data Analysis Platform</h1>
            
            <section class="input-section" aria-labelledby="input-section-title">
                <h2 id="input-section-title" class="visually-hidden">Data Input</h2>
                <div class="product-selection">
                    <div class="select-group">
                        <label for="product-category">Select Product Category:</label>
                        <select id="product-category">
                            <option value="">-- Select Category --</option>
                            <option value="any">Any Category</option>
                            <option value="Airway">Airway</option>
                            <option value="Anesthesia">Anesthesia</option>
                            <option value="Oxygen Therapy">Oxygen Therapy</option>
                            <option value="Neonatal">Neonatal</option>
                            <option value="I.V. Therapy">I.V. Therapy</option>
                            <option value="Syringes">Syringes</option>
                            <option value="Kits & Sets">Kits & Sets</option>
                            <option value="Hemodialysis">Hemodialysis</option>
                            <option value="Tubes & Catheters">Tubes & Catheters</option>
                            <option value="Pulse Oximeter">Pulse Oximeter</option>
                            <option value="General Surgery">General Surgery</option>
                            <option value="Urology">Urology</option>
                            <option value="Obstetrics & Gynecology">Obstetrics & Gynecology</option>
                            <option value="Miscellaneous">Miscellaneous</option>
                        </select>
                    </div>
                    <div class="select-group">
                        <label for="product-subcategory">Select Specific Product (Optional):</label>
                        <select id="product-subcategory" disabled>
                            <option value="">-- Select Category First --</option>
                        </select>
                    </div>
                </div>
                
                <div class="input-tabs">
                    <div class="tab-buttons" role="tablist">
                        <button class="tab-button active" id="file-tab-btn" data-tab="file-tab" role="tab" aria-controls="file-tab" aria-selected="true">Upload File</button>
                        <button class="tab-button" id="text-tab-btn" data-tab="text-tab" role="tab" aria-controls="text-tab" aria-selected="false">Enter Text</button>
                    </div>
                    
                    <div id="file-tab" class="tab-content active" role="tabpanel" aria-labelledby="file-tab-btn">
                        <div class="file-upload">
                            <p>Drag and drop a file here or click the button below.</p>
                            <input type="file" id="file-input" class="file-input" accept=".pdf,.doc,.docx,.xls,.xlsx,.csv,.txt,.md" aria-label="File input for sales data">
                            <label for="file-input" class="upload-btn">Choose File</label>
                            <p id="file-name-display" style="margin-top: 10px; font-size: 14px;"></p>
                        </div>
                    </div>
                    
                    <div id="text-tab" class="tab-content" role="tabpanel" aria-labelledby="text-tab-btn">
                        <div class="text-input">
                            <label for="analysis-text">Enter text for analysis:</label>
                            <textarea id="analysis-text" placeholder="Paste your sales data or relevant text here for analysis..."></textarea>
                        </div>
                    </div>
                    
                    <button id="analyze-btn" class="submit-btn" disabled>Analyze Data</button>
                </div>
            </section>
            
            <div id="loading" class="loading" aria-live="polite" aria-atomic="true">
                <div class="spinner" role="status">
                    <span class="visually-hidden">Loading...</span>
                </div>
                <p>Analyzing data... Please wait.</p>
            </div>
            
            <section id="results-section" class="results-section" aria-live="polite" aria-atomic="true">
                <h2 class="section-title">Analysis Results</h2>
                
                <div class="results-grid">
                    <div class="result-card">
                        <div class="card-header">Comprehensive Analysis</div>
                        <div class="card-body" id="analysis-content">
                            <p><em>Analysis content will appear here.</em></p>
                        </div>
                    </div>
                    
                    <div id="performance-card" class="result-card">
                        <div class="card-header">Product Performance Highlights</div>
                        <div class="card-body" id="performance-content">
                             <p><em>Performance table and key metrics will appear here.</em></p>
                        </div>
                    </div>
                    
                    <div class="result-card">
                        <div class="card-header">Strategic AI Insights</div>
                        <div class="card-body" id="insights-content">
                            <p><em>Actionable AI-driven insights will appear here.</em></p>
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>
    
    <footer>
        <div class="container">
            <div class="footer-content">
                <div class="footer-logo">MAIS Analytics © <span id="current-year"></span></div>
                <div class="footer-links">
                    <a href="#">Privacy Policy</a>
                    <a href="#">Terms of Service</a>
                    <a href="#support-btn" id="footer-support-link">Support</a>
                </div>
            </div>
        </div>
    </footer>

    <!-- 3D Support Button -->
    <button class="support-btn-3d" id="support-btn" title="Technical Support" aria-label="Open Technical Support Chat">
        <svg viewBox="0 0 64 64" fill="none" xmlns="http://www.w3.org/2000/svg">
            <defs>
                <radialGradient id="g1" cx="50%" cy="50%" r="70%">
                    <stop offset="0%" stop-color="#4CAF50"/>
                    <stop offset="100%" stop-color="#0056b3"/>
                </radialGradient>
            </defs>
            <ellipse cx="32" cy="32" rx="30" ry="30" fill="url(#g1)" />
            <ellipse cx="32" cy="38" rx="18" ry="10" fill="#fff" opacity="0.18"/>
            <path d="M16 36v-6c0-8.8 7.2-16 16-16s16 7.2 16 16v6" stroke="#fff" stroke-width="3" stroke-linecap="round"/>
            <rect x="14" y="36" width="8" height="14" rx="4" fill="#fff" stroke="#0056b3" stroke-width="2"/>
            <rect x="42" y="36" width="8" height="14" rx="4" fill="#fff" stroke="#0056b3" stroke-width="2"/>
            <circle cx="32" cy="32" r="7" fill="#fff" stroke="#0056b3" stroke-width="2"/>
            <ellipse cx="32" cy="32" rx="4" ry="4" fill="#4CAF50"/>
            <path d="M50 50c0 4-6 6-18 6s-18-2-18-6" stroke="#0056b3" stroke-width="2" stroke-linecap="round"/>
        </svg>
    </button>

    <!-- Support Modal -->
    <div class="support-modal-bg" id="support-modal-bg" role="dialog" aria-modal="true" aria-labelledby="support-modal-title">
        <div class="support-modal">
            <button class="support-modal-close" id="support-modal-close" title="Close" aria-label="Close support modal">×</button>
            <div class="support-modal-title" id="support-modal-title">MAIS Technical Support</div>
            <div class="support-modal-desc">Describe your issue or question about the MAIS platform, and our AI assistant will help you.</div>
            <textarea id="support-input" placeholder="Type your problem or question here..." aria-label="Support question input"></textarea>
            <button class="support-send-btn" id="support-send-btn" disabled>Send</button>
            <div class="support-loading" id="support-loading" style="display:none;" aria-live="polite">Processing your request...</div>
            <div class="support-response" id="support-response" aria-live="polite"></div>
        </div>
    </div>

    <!-- Visually Hidden Class for Accessibility -->
    <style>.visually-hidden { position: absolute; width: 1px; height: 1px; margin: -1px; padding: 0; overflow: hidden; clip: rect(0, 0, 0, 0); border: 0; }</style>

    <script>
        // DOM Elements
        const productCategorySelect = document.getElementById('product-category');
        const productSubcategorySelect = document.getElementById('product-subcategory');
        const fileInput = document.getElementById('file-input');
        const fileNameDisplay = document.getElementById('file-name-display');
        const analysisText = document.getElementById('analysis-text');
        const analyzeBtn = document.getElementById('analyze-btn');
        const tabButtons = document.querySelectorAll('.tab-button');
        const tabContents = document.querySelectorAll('.tab-content');
        const loadingDiv = document.getElementById('loading');
        const resultsSection = document.getElementById('results-section');
        const analysisContent = document.getElementById('analysis-content');
        const performanceContent = document.getElementById('performance-content');
        const insightsContent = document.getElementById('insights-content');
        const messageArea = document.getElementById('message-area');
        
        let activeTab = 'file-tab'; // Default active tab

        // Product Subcategories Data
        const productSubcategories = {
            "Airway": ["Pharyngeal Airway", "Naso-Pharyngeal Airway-PVC", "Naso-Pharyngeal Airway-Silicon", "laryngeal Airway Mask -PVC", "laryngeal Airway Mask (Reinforced Reusable -silicon)", "laryngeal Airway Mask set (Reinforced Reusable -silicon)", "All-Silicone Tracheostomy Tube : Un-Cuffed", "All-Silicone Tracheostomy Tube : Cuffed", "Tracheostomy Tube", "Tracheostomy Mask"],
            "Anesthesia": ["Anesthesia Breathing circuit (Smooth Bore )", "Anesthesia Breathing circuit (corrugated)", "Ventelation Breathing Circuit", "Catheter Mount", "Breathing Bag (Antistatic) Reusable", "MDI Meter Dose Inhaler Adapter", "Bacterial & Viral Filters", "Bacterial/Viral Filter With HME", "Bacterial/Viral Filter With HME (Artificial Nose)", "Tracheostomy HME Filter", "E.T.T Preformed (South Facing-oral) Cuffed", "E.T.T Preformed (North Facing Nasal) Cuffed", "E.T.T Preformed (South Facing-oral) Uncuffed", "E.T.T Preformed (North Facing Nasal) Uncuffed", "Endotracheal Tubes Oral/Nasal-Cuffed", "Endotracheal Tubes Reinforced Oral/Nasal-Cuffed", "Endotracheal Tubes Oral/Nasal-Uncuffed", "Endotracheal Tubes Reinforced Oral/Nasal-Uncuffed"],
            "Oxygen Therapy": ["Oxygen Nasal Cannula", "Aerosol Mask Without Tube", "Nebulizer Mask With tube", "Oxygen Catheter", "Oxygen Mask With tube", "Nebulizer kit with (T-mouth pc, 15cm corrugated tube)", "Non-Rebreathing Mask", "Partially Non Rebreathing Mask", "Venturi Mask / Mask Vent Adult", "Oxygen Therapy Accessories"],
            "Neonatal": ["Polyurethane Catheter", "Positioning Aid / Snuggle Ups", "NCAP-Hat(cap)", "Eye Protector", "Little Suckers/Neosuckers-neonate Gentle Plastic", "Nasal Prong, Max flow 6 l/min", "NCPAP Mask", "Hat For Neonate", "Infant bonnet", "SIPAP Inflow flow circuit"],
            "I.V. Therapy": ["Blood Transfusion Set with Y-injection site", "Blood Administrator set - Burette Type", "Blood filter for clot removal", "I.V Infusion set With Y-injection site", "I.V Infusion set With flow control", "Burette I.V Infusion set With Y-Injection site", "Infusion Accessories", "Transfer Set", "Venting Needle", "I.V. adhesive Fixer"],
            "Syringes": ["Dual Syringe Injector", "Special Syringes", "Syringe Insulin (sterile)", "Syringe Luer Lock/side Nozzle (Sterile)", "Syringe luer tip (sterile)"],
            "Kits & Sets": ["CVC Single/Double/Triple/Four/Five Lumen Sets", "HDC Single/Double/Triple Lumen Catheter Sets (Straight/Curved)", "Peritoneal Dialysis Catheter Set (PDC)", "Permthane Double Lumen Catheter Set", "Lumbar Puncture Set", "Combined Spinal-Epidural Set", "Epidural Set", "Biopsy Set", "Tracheostomy Care Kit", "Patient Care Kit", "Suction Catheter Kit"],
            "Hemodialysis": ["Blood Lines (Fresenius/Gambro/B.Braun/Other Machines)", "Arterial Venous Catheter for Hemodialysis", "Hemodialyzer Filters", "Cartridge for hemodialysis (Non-Sterile)", "Fistula Needle (Sterile/Set)", "Y-Connector for Single Needle Dialysis", "Trans Urethral Resection Catheter", "Dialysis Catheter (short term)"],
            "Tubes & Catheters": ["Feeding Tube (with Guide Wire/Silicon/X-Ray Line)", "Enteral Feeding Bag with Set", "Feeding Tube Gastrostomy (Silicone)", "Ryles Tubes with X-Ray Line", "Rectal Tube", "Drainage Tubes", "Extension/Connection Tubes", "Suction Connection Tubes", "Nasojejunal Feeding Tube/Suction Silicon Tube", "I.V. Amber Tubing", "Suction Catheter (Finger Control/Funnel)", "CO2 Gas Tubing for Insufflator", "Laparoscopic Accessories", "Adapters", "Thoracic Catheter (Right Angle/Straight, with/without Trocar)"],
            "Pulse Oximeter": ["Sensor Oxygen Forehead Masimo SET", "SPO2 Probe Adhesive Masimo SET", "Saturation Probe Neonates Nellcor", "Skin Temperature Probe Giraffe Incubator", "Saturation Probe Finger Tip", "Temperature Probe"],
            "General Surgery": ["PVC Wound Drainage Set (Silicon Multi Channel Tube)", "Open Surgery Abdominal Drain", "Hi-Vacuum Wound Drainage Set Spring Type", "Silicon Hubless Wound Drainage", "Wound Drainage Set (Pre-evacuated/Bellow Pump)", "Under Water Drainage System (Thoracic/Pleural/One/Two Bottle)"],
            "Urology": ["Tiemann Catheter", "Nelaton Catheter (Male/Female)", "Double Lumen Catheter (Radio-Opaque, Graduated)", "Set Replacement Polyurethane Pigtail", "2-Way Foley Catheter (100% Silicone/Latex Silicone Coated)", "Ureteral Stent (Distal End Opened/Closed - PUR)"],
            "Obstetrics & Gynecology": ["Vaginal Dilator Set", "Water Based Gel"],
            "Miscellaneous": ["IV Cannula (With/Without Port)", "Safety Intravenous (I.V) Cannula", "Scalp Vein Set", "IV Butterfly Needle", "Vacuum Blood Collection Tube", "Multi Sample Needle", "Multi Sample Holder & Adapter", "Arterial Catheter"]
        };
        
        // Helper function to show messages
        function showMessage(message, type = 'info') { // type can be 'info', 'success', 'error'
            messageArea.textContent = message;
            messageArea.className = 'message-area'; // Reset classes
            if (type === 'success') {
                messageArea.classList.add('success');
            } else if (type === 'error') {
                messageArea.classList.add('error');
            }
            messageArea.style.display = 'block';
            // Optionally hide after some time for info/success
            if (type !== 'error') {
                setTimeout(() => {
                    if (messageArea.textContent === message) { // Only hide if it's still the same message
                         messageArea.style.display = 'none';
                    }
                }, 5000);
            }
        }
        function hideMessage() {
            messageArea.style.display = 'none';
        }

        // Populate subcategories
        productCategorySelect.addEventListener('change', function() {
            const selectedCategory = this.value;
            productSubcategorySelect.innerHTML = '<option value="">-- Optional: Select Specific Product --</option>';
            
            if (selectedCategory && productSubcategories[selectedCategory]) {
                productSubcategories[selectedCategory].forEach(sub => {
                    const opt = document.createElement('option');
                    opt.value = sub;
                    opt.textContent = sub;
                    productSubcategorySelect.appendChild(opt);
                });
                productSubcategorySelect.disabled = false;
            } else {
                productSubcategorySelect.innerHTML = '<option value="">-- Select Category First --</option>';
                productSubcategorySelect.disabled = true;
            }
            updateAnalyzeButtonState();
        });

        // Handle file selection
        fileInput.addEventListener('change', function() {
            if (this.files.length > 0) {
                fileNameDisplay.textContent = `Selected file: ${this.files[0].name}`;
                 // Basic file type validation (can be expanded)
                const allowedTypes = ['application/pdf', 'application/msword', 'application/vnd.openxmlformats-officedocument.wordprocessingml.document', 'application/vnd.ms-excel', 'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet', 'text/csv', 'text/plain', 'text/markdown'];
                if (!allowedTypes.includes(this.files[0].type) && !this.files[0].name.endsWith('.md')) { // .md might not have a standard MIME type
                    showMessage(`Unsupported file type: ${this.files[0].type || 'unknown'}. Please upload PDF, DOC, DOCX, XLS, XLSX, CSV, TXT, or MD.`, 'error');
                    this.value = ''; // Clear the input
                    fileNameDisplay.textContent = '';
                }
            } else {
                fileNameDisplay.textContent = '';
            }
            updateAnalyzeButtonState();
        });

        // Handle text input
        analysisText.addEventListener('input', updateAnalyzeButtonState);

        // Tab switching
        tabButtons.forEach(button => {
            button.addEventListener('click', function() {
                const tabId = this.getAttribute('data-tab');
                
                tabButtons.forEach(btn => {
                    btn.classList.remove('active');
                    btn.setAttribute('aria-selected', 'false');
                });
                this.classList.add('active');
                this.setAttribute('aria-selected', 'true');
                
                tabContents.forEach(content => {
                    content.classList.remove('active');
                });
                document.getElementById(tabId).classList.add('active');
                
                activeTab = tabId;
                updateAnalyzeButtonState();
            });
        });

        // Update Analyze Button State
        function updateAnalyzeButtonState() {
            const categorySelected = productCategorySelect.value !== '';
            let dataProvided = false;
            if (activeTab === 'file-tab') {
                dataProvided = fileInput.files.length > 0 && fileInput.files[0] !== undefined;
            } else {
                dataProvided = analysisText.value.trim() !== '';
            }
            analyzeBtn.disabled = !(categorySelected && dataProvided);
        }

        // Analyze Button Click Handler
        analyzeBtn.addEventListener('click', async function() {
            hideMessage();
            loadingDiv.style.display = 'block';
            resultsSection.style.display = 'none';
            this.disabled = true; // Disable button during processing

            try {
                const category = productCategorySelect.options[productCategorySelect.selectedIndex].text;
                const subcategoryValue = productSubcategorySelect.value;
                const subcategory = subcategoryValue ? ` - ${subcategoryValue}` : ""; // Add subcategory if selected

                let inputDataContent = '';
                let sourceDescription = '';

                if (activeTab === 'text-tab') {
                    inputDataContent = analysisText.value.trim();
                    sourceDescription = 'text input';
                    if (!inputDataContent) {
                        showMessage('Please enter text for analysis.', 'error');
                        throw new Error('No text input provided.');
                    }
                } else {
                    if (fileInput.files.length === 0 || !fileInput.files[0]) {
                         showMessage('Please select a file for analysis.', 'error');
                        throw new Error('No file selected.');
                    }
                    // For security, actual file content reading for direct API sending
                    // would typically happen server-side. Here, we simulate with file name.
                    // If you need to send file content, you'd use FileReader API.
                    // For now, let's assume the API can handle a description or the backend does the fetching.
                    inputDataContent = `Sales data from file: ${fileInput.files[0].name}. File type: ${fileInput.files[0].type}. File size: ${fileInput.files[0].size} bytes.`;
                    sourceDescription = `file: ${fileInput.files[0].name}`;
                }

                const results = await analyzeWithGroq(category, subcategory, inputDataContent, sourceDescription);
                displayResults(results);
                
                loadingDiv.style.display = 'none';
                resultsSection.style.display = 'block';
                resultsSection.scrollIntoView({ behavior: 'smooth' });
                showMessage('Analysis complete!', 'success');

            } catch (error) {
                console.error('Sales analysis error:', error);
                showMessage(`Analysis Error: ${error.message}. Please check your input or try again.`, 'error');
                loadingDiv.style.display = 'none';
            } finally {
                analyzeBtn.disabled = false; // Re-enable button
                updateAnalyzeButtonState(); // Ensure it's correctly disabled if inputs are cleared
            }
        });

        // Groq API Analysis
        async function analyzeWithGroq(category, subcategory, inputData, sourceDescription) {
            // --- IMPORTANT SECURITY WARNING ---
            // NEVER hardcode API keys directly in client-side JavaScript like this for production.
            // This key will be exposed to anyone viewing the page source.
            // For production, use a backend proxy server to make API calls securely.
            const GROQ_API_KEY = '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'; // REPLACE WITH YOUR ACTUAL KEY VIA A SECURE METHOD
            const GROQ_API_ENDPOINT = 'https://api.groq.com/openai/v1/chat/completions';
            const MODEL_NAME = 'llama3-8b-8192'; // Switched to a common Llama3 model for broad capabilities

            const systemPrompt = `You are an expert Sales Data Analyst for MAIS, a medical products company.
Your task is to analyze sales data and provide a structured report.
The user will provide data related to product category: "${category}${subcategory}" from source: "${sourceDescription}".

Please structure your response precisely as follows, using these exact headings:

COMPREHENSIVE ANALYSIS:
[Provide a detailed assessment of sales performance, trends, patterns, and overall business impact. Identify key metrics and interpret them. Discuss market position, competitive factors if evident, and potential opportunities or threats. Use bullet points for lists of findings.]

PERFORMANCE HIGHLIGHTS:
[Create a summary of profitable vs. loss-making areas/products/trends. For each, try to identify specific causes if discernible from the data. Then, provide specific, actionable recommendations. If possible, present this as a structured list or if complex, describe how a table would look with columns: Aspect, Status (e.g., Profitable/Loss-making/Stagnant), Potential Cause, Recommendation. Example:
- Product X:
  - Status: Highly Profitable
  - Potential Cause: Recent marketing campaign, high demand in specific region.
  - Recommendation: Scale up marketing, explore similar regions.]

STRATEGIC AI INSIGHTS:
[Offer 2-3 high-value, potentially non-obvious observations or strategic recommendations derived from the data. These should be forward-looking and aim to significantly impact sales strategies or uncover hidden potential. Focus on actionable advice.]

Be concise, data-driven, and professional. If the provided data is insufficient for a section, state that clearly (e.g., "Insufficient data to determine specific loss-making areas.").
`;

            const userContent = `Analyze the following sales data: ${inputData}`;

            const response = await fetch(GROQ_API_ENDPOINT, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                    'Authorization': `Bearer ${GROQ_API_KEY}`
                },
                body: JSON.stringify({
                    model: MODEL_NAME,
                    messages: [
                        { role: "system", content: systemPrompt },
                        { role: "user", content: userContent }
                    ],
                    temperature: 0.6, // Slightly creative but still factual
                    max_tokens: 3000 // Increased for potentially detailed analysis
                })
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                throw new Error(`API request failed: ${response.status} ${response.statusText}. ${errorData.error?.message || ''}`);
            }

            const responseData = await response.json();
            if (!responseData.choices || responseData.choices.length === 0) {
                throw new Error("API returned an empty response or no choices.");
            }
            const analysisText = responseData.choices[0].message.content;
            return parseAnalysisResponse(analysisText);
        }

        // Parse Groq Response
        function parseAnalysisResponse(text) {
            const sections = {
                analysis: "Comprehensive analysis not found in the response.",
                performance: "Performance highlights not found in the response.",
                insights: "Strategic insights not found in the response."
            };

            const analysisMatch = text.match(/COMPREHENSIVE ANALYSIS:([\s\S]*?)(?=PERFORMANCE HIGHLIGHTS:|STRATEGIC AI INSIGHTS:|$)/i);
            if (analysisMatch && analysisMatch[1]) sections.analysis = analysisMatch[1].trim();

            const performanceMatch = text.match(/PERFORMANCE HIGHLIGHTS:([\s\S]*?)(?=STRATEGIC AI INSIGHTS:|$)/i);
            if (performanceMatch && performanceMatch[1]) sections.performance = performanceMatch[1].trim();
            
            const insightsMatch = text.match(/STRATEGIC AI INSIGHTS:([\s\S]*?)$/i);
            if (insightsMatch && insightsMatch[1]) sections.insights = insightsMatch[1].trim();

            return sections;
        }

        // Display Results
        function displayResults(results) {
            analysisContent.innerHTML = formatContent(results.analysis);
            performanceContent.innerHTML = formatPerformanceTable(results.performance);
            insightsContent.innerHTML = formatContent(results.insights);
        }
        
        // Format Content (basic markdown-like)
        function formatContent(text) {
            if (!text) return "<p><em>No content available for this section.</em></p>";
            let html = text;
            // Bold: **text** or __text__
            html = html.replace(/\*\*(.*?)\*\*|__(.*?)__/g, '<strong>$1$2</strong>');
            // Italic: *text* or _text_
            html = html.replace(/\*(.*?)\*|_(.*?)_/g, '<em>$1$2</em>');
            // Highlight: ==text==
            html = html.replace(/==(.*?)==/g, '<span class="text-highlight">$1</span>');
            // Bullet points: * item or - item or + item
            html = html.replace(/^\s*[\*\-\+]\s+(.*)/gm, '<li>$1</li>');
            html = html.replace(/<\/li>\s*<li>/g, '</li><li>'); // Consolidate li tags
            html = html.replace(/<li>.*<\/li>/gs, (match) => `<ul>${match}</ul>`); // Wrap LIs in ULs
            // Numbered lists: 1. item
            html = html.replace(/^\s*\d+\.\s+(.*)/gm, '<li>$1</li>');
            html = html.replace(/<\/li>\s*<li>/g, '</li><li>'); // Consolidate li tags (again for numbered)
            // This regex needs to be smarter to distinguish between UL and OL or have AI use distinct markers.
            // For now, if we have LIs not in UL, assume it's a new OL.
            html = html.replace(/(<li>.*<\/li>)(?!<\/ul>)(?!<\/ol>)/gs, (match) => `<ol>${match}</ol>`);


            // Paragraphs (split by double newlines, then single newlines to <br>)
            const paragraphs = html.split(/\n\s*\n/).map(p => {
                if (p.startsWith('<ul>') || p.startsWith('<ol>')) return p; // Don't wrap lists in <p>
                return p.trim() ? `<p>${p.replace(/\n/g, '<br>')}</p>` : '';
            }).join('');
            
            return paragraphs || "<p><em>Content processed, but result is empty.</em></p>";
        }

        // Format Performance Table
        function formatPerformanceTable(text) {
            if (!text) return "<p><em>No performance data available.</em></p>";

            if (text.toLowerCase().includes("insufficient data")) {
                return `<p><em>${text}</em></p>`;
            }

            // If AI provides a markdown table:
            if (text.includes('| --- |')) {
                let html = text.replace(/\|\s*---*\s*\|/g, '|:---|') // Ensure left align for remark
                               .replace(/^\|(.+)\|\s*$/gm, '<tr><td>$1</td></tr>')
                               .replace(/<\/td><td>/g, '</td><td>')
                               .replace(/<\/td><\/tr>\s*<tr><td>/g, '</td></tr><tr><td>')
                               .replace(/<td>\s*([^|]+?)\s*<\/td>/g, (match, p1) => `<td>${p1.trim()}</td>`) // Trim content
                               .replace(/<tr><td>(.+?)<\/td><\/tr>/, '<thead><tr><th>$1</th></tr></thead>') // First row as header
                               .replace(/<\/th><th>/g, '</th><th>') // Fix multiple th
                               .replace(/<tr><td>/g, '<tbody><tr><td>'); // Start tbody after head
                if (html.includes('<tbody>')) html += '</tbody>'; else html = `<table>${html}</table>`;
                 return html.replace('<table><thead>', '<table class="generated-table"><thead>');
            }
            
            // Fallback to simpler list-based or paragraph formatting if not a clear table structure
            // Try to parse "Aspect:", "Status:", "Cause:", "Recommendation:" pattern
            let htmlOutput = "";
            const entries = text.split(/\n\s*(?=[A-Za-z\s]+:)/); // Split by lines starting with "Word:"
            
            if (entries.length > 1 && entries.some(e => e.toLowerCase().includes("status:"))) {
                 htmlOutput += '<table class="generated-table"><thead><tr><th>Aspect</th><th>Status</th><th>Potential Cause</th><th>Recommendation</th></tr></thead><tbody>';
                let currentEntry = {};
                entries.forEach(line => {
                    const parts = line.match(/^([A-Za-z\s]+):\s*([\s\S]*)/);
                    if (parts) {
                        const key = parts[1].trim().toLowerCase();
                        const value = parts[2].trim();
                        if (key === "aspect" || key === "product" || key === "item") currentEntry.aspect = value;
                        else if (key === "status") currentEntry.status = value;
                        else if (key === "potential cause" || key === "cause") currentEntry.cause = value;
                        else if (key === "recommendation") currentEntry.recommendation = value;

                        if (currentEntry.aspect && currentEntry.status && currentEntry.cause && currentEntry.recommendation) {
                            htmlOutput += `<tr>
                                <td>${currentEntry.aspect}</td>
                                <td class="${currentEntry.status.toLowerCase().includes('profit') ? 'status-success' : currentEntry.status.toLowerCase().includes('loss') ? 'status-danger' : 'status-neutral'}">${currentEntry.status}</td>
                                <td>${currentEntry.cause}</td>
                                <td>${currentEntry.recommendation}</td>
                            </tr>`;
                            currentEntry = {}; // Reset for next entry
                        }
                    }
                });
                htmlOutput += '</tbody></table>';
                if (!htmlOutput.includes('<tr>')) { // If no table rows were made, fall back
                    htmlOutput = formatContent(text); // Use general content formatter
                }

            } else {
                // If not easily parsable into a table, use the general content formatter
                htmlOutput = formatContent(text);
            }
            return htmlOutput || "<p><em>Performance highlights processed.</em></p>";
        }

        // File Drag and Drop
        const dropZone = document.querySelector('.file-upload');
        dropZone.addEventListener('dragover', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--primary-color)';
            dropZone.style.backgroundColor = 'rgba(0, 86, 179, 0.03)';
        });
        dropZone.addEventListener('dragleave', () => {
            dropZone.style.borderColor = 'var(--border-color)';
            dropZone.style.backgroundColor = '#fdfdfd';
        });
        dropZone.addEventListener('drop', (e) => {
            e.preventDefault();
            dropZone.style.borderColor = 'var(--border-color)';
            dropZone.style.backgroundColor = '#fdfdfd';
            if (e.dataTransfer.files.length > 0) {
                fileInput.files = e.dataTransfer.files;
                // Trigger change event manually for fileInput
                const event = new Event('change');
                fileInput.dispatchEvent(event);
            }
        });

        // Support Modal Logic
        const supportBtn = document.getElementById('support-btn');
        const footerSupportLink = document.getElementById('footer-support-link');
        const supportModalBg = document.getElementById('support-modal-bg');
        const supportModalClose = document.getElementById('support-modal-close');
        const supportInput = document.getElementById('support-input');
        const supportSendBtn = document.getElementById('support-send-btn');
        const supportLoading = document.getElementById('support-loading');
        const supportResponse = document.getElementById('support-response');
        let previousFocusedElement;


        function openSupportModal() {
            previousFocusedElement = document.activeElement;
            supportModalBg.classList.add('visible');
            supportInput.value = '';
            supportResponse.textContent = '';
            supportSendBtn.disabled = true;
            supportLoading.style.display = 'none';
            supportInput.focus();
        }
        function closeSupportModal() {
            supportModalBg.classList.remove('visible');
            if(previousFocusedElement) previousFocusedElement.focus();
        }

        supportBtn.addEventListener('click', openSupportModal);
        if(footerSupportLink) footerSupportLink.addEventListener('click', (e) => { e.preventDefault(); openSupportModal();});

        supportModalClose.addEventListener('click', closeSupportModal);
        supportModalBg.addEventListener('click', (e) => { // Close on overlay click
            if (e.target === supportModalBg) closeSupportModal();
        });
        document.addEventListener('keydown', (e) => { // Close with Escape key
            if (e.key === 'Escape' && supportModalBg.classList.contains('visible')) {
                closeSupportModal();
            }
        });


        supportInput.addEventListener('input', () => {
            supportSendBtn.disabled = supportInput.value.trim() === '';
        });

        supportSendBtn.addEventListener('click', async () => {
            const userMsg = supportInput.value.trim();
            if (!userMsg) return;
            
            supportSendBtn.disabled = true;
            supportInput.disabled = true;
            supportLoading.style.display = 'block';
            supportResponse.textContent = '';
            
            try {
                const reply = await callSupportAI(userMsg);
                supportResponse.textContent = reply;
            } catch (e) {
                console.error("Support AI Error:", e);
                supportResponse.textContent = 'Apologies, I encountered an issue trying to connect with support. Please try again shortly.';
            } finally {
                supportLoading.style.display = 'none';
                supportSendBtn.disabled = false; // Re-enable based on input content next
                supportInput.disabled = false;
                supportInput.focus();
                supportInput.dispatchEvent(new Event('input')); // Trigger input event to re-check button state
            }
        });

        // Gemini API call for support
        async function callSupportAI(userMsg) {
            // --- IMPORTANT SECURITY WARNING ---
            // As with the Groq key, this API key should NOT be in client-side code for production.
            // Use a backend proxy.
            const GEMINI_API_KEY = 'AIzaSyCMrm1LjmlJObZsVCQEuy_wTkh9ZEEc8aQ'; // REPLACE with your actual key via a SECURE METHOD
            const GEMINI_API_URL = `https://generativelanguage.googleapis.com/v1beta/models/gemini-1.5-flash-latest:generateContent?key=${GEMINI_API_KEY}`;

            const supportPrompt = `You are a helpful AI assistant for MAIS, a medical products analysis platform.
Your role is to provide technical support and answer questions about using the platform, its features, understanding analysis results, or general queries related to MAIS products.
- Answer clearly, concisely, and in a friendly, professional tone.
- If a question is outside the scope of MAIS platform support (e.g., medical advice, financial advice, non-MAIS topics), politely state that you cannot assist with that specific query and suggest contacting human support if appropriate for complex MAIS issues.
- If the user asks about data analysis or reports, explain how to use the platform's features or interpret the generated content.
- Respond in English.

User's question: "${userMsg}"`;

            const requestBody = {
                contents: [{ role: "user", parts: [{ text: supportPrompt }] }],
                generationConfig: {
                    temperature: 0.7,
                    maxOutputTokens: 500
                }
            };

            const response = await fetch(GEMINI_API_URL, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify(requestBody)
            });

            if (!response.ok) {
                const errorData = await response.json().catch(() => ({}));
                 throw new Error(`Support API error: ${response.status}. ${errorData.error?.message || 'Failed to get a response.'}`);
            }

            const data = await response.json();
            if (data.candidates && data.candidates[0] && data.candidates[0].content && data.candidates[0].content.parts && data.candidates[0].content.parts[0]) {
                return data.candidates[0].content.parts[0].text.trim();
            } else if (data.promptFeedback && data.promptFeedback.blockReason) {
                return `I'm sorry, I couldn't process that request due to: ${data.promptFeedback.blockReason}. Please try rephrasing.`;
            }
            return "I'm sorry, I couldn't generate a response at this time. Please try again.";
        }
        
        // Initialize
        document.addEventListener('DOMContentLoaded', () => {
            updateAnalyzeButtonState(); // Initial check for analyze button
            document.getElementById('current-year').textContent = new Date().getFullYear();
            // Set default placeholder for subcategory
            productSubcategorySelect.innerHTML = '<option value="">-- Select Category First --</option>';
        });

    </script>
</body>
</html>